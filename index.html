<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Dear&#39;s Blog</title>

  <meta name="author" content="Dear">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="renderer" content="webkit">

  
  <meta property="og:site_name" content="Dear&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
  

  <!-- CSS -->
  <!-- link rel="stylesheet" href="/css/themes/bootstrap.css" media="screen" type="text/css" -->
  <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight-default.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]>
  <!-- <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.9/es5-shim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-sham.min.js"></script>
  -->
  <![endif]-->

<script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-8073696482754398",
    enable_page_level_ads: true
  });
</script>
<script language="javascript" type="text/javascript" src="//js.users.51.la/19306385.js"></script>
<noscript>
  <a href="//www.51.la/?19306385" target="_blank">
    <img alt="&#x6211;&#x8981;&#x5566;&#x514D;&#x8D39;&#x7EDF;&#x8BA1;" src="//img.users.51.la/19306385.asp" style="border:none" />
  </a>
</noscript>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
  <script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>
  
  <!-- analytics -->
  



  <meta name="baidu-site-verification" content="RXfcpfczu8" />
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Dear&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>目录
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>分类
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>标签
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>关于个人
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Welcome to Dear&#39;s Blog
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
        <!-- render top articles firstly -->
        
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
        
        <!-- render other articles -->
        
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-03-14 </div>
			<div class="article-title"><a href="/2018/03/14/junior-sql/" >sql简单语法</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h3 id="查看命令"><a href="#查看命令" class="headerlink" title="查看命令"></a>查看命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">show databases; # 查看数据库</div><div class="line">show tables;    # 查看表</div><div class="line">show columns from table; # 查看列</div><div class="line">desc table;     # 查看列</div><div class="line">show status;    # 查看mysql状态信息</div><div class="line">show create database/table; # 查看建库/表语句</div><div class="line">show grants;    # 查看授权用户</div><div class="line">show errors/warnings; # 查看error, warning信息</div></pre></td></tr></table></figure>
<h3 id="查数据"><a href="#查数据" class="headerlink" title="查数据"></a>查数据</h3><ol>
<li>同时使用order by 与where子句时, order by子句应放于where子句后</li>
<li>AND 与 OR 同时使用时, 先计算AND, 若想先计算OR 可以()</li>
<li>group by 必须出现在where子句之后, 在order by子句之前</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 简单查询</div><div class="line">select column1, column2 from table; # 查看多列数据</div><div class="line">select * from table; # 查看所有列数据</div><div class="line">select  distinct id from table; # 查询不同的ID</div><div class="line">select * from table limit 5; # 查询前5条数据</div><div class="line">select * from table limit 5, 10; # 查询从第5行开始的前10条数据</div><div class="line"></div><div class="line"><span class="meta">#</span> 排序</div><div class="line">select * from table order by column1; # 按column1升序排列</div><div class="line">select * from table order by column1 ASC; # 按column1升序排列</div><div class="line">select * from table order by column1 desc; # 按column1降序排列</div><div class="line">select * from table order by column1, column2 desc; # 按column1升序排列后再按column2降序排列</div><div class="line"></div><div class="line"><span class="meta">#</span> 数据过滤</div><div class="line"></div><div class="line"><span class="meta">#</span> 操作符</div><div class="line">= : 等于</div><div class="line">&lt;&gt; : 不等于</div><div class="line">!= : 不等于</div><div class="line">&lt; : 小于</div><div class="line">&lt;= : 小于等于</div><div class="line"><span class="meta">&gt;</span> : 大于</div><div class="line"><span class="meta">&gt;</span>= : 大于等于</div><div class="line">between : 在两个数值之间</div><div class="line"></div><div class="line"><span class="meta">#</span> 单条件</div><div class="line">select * from table where id=1; # 查找表中, id=1的数据</div><div class="line">select * from table where id between 10 and 20; 查找表中id为10-20之间的数据(包括10, 20)</div><div class="line">select * from table where column1 is null; # 查找表中column1为Null的数据</div><div class="line"></div><div class="line"><span class="meta">#</span> 使用操作符过滤</div><div class="line">select * from table where id&gt;10 and column1 is not null; # 查找表中id&gt;10且column不为Null的数据</div><div class="line">select * from table where id&gt;10 or column1 is not null; # 查找表中id&gt;10或column不为Null的数据</div><div class="line">select * from table where id in (1,2,3); # 查找表中id为1、2、3的数据</div><div class="line"></div><div class="line">3¤</div><div class="line"><span class="meta">%</span> 匹配任意字符出现任意次数</div><div class="line">_ 匹配单个任意的字符</div><div class="line">select * from table where column1 like 'Dear%'; # 查找表中column1是以Dear开头的数据</div><div class="line">select * from table where column1 like '%Dear%'; # 查找表中column1包含字符Dear的数据</div><div class="line">select * from table where column1 like 'D_ar'; # 查找表中column1字段是4个字符的,其中以D开头, ar结束</div><div class="line"></div><div class="line"><span class="meta">#</span> 使用正则表达式过滤</div><div class="line"><span class="meta">#</span> 详情参考正则表达式</div><div class="line">select * from table where id regexp '[0-9]'; # 查找表中id为0至9的数据</div><div class="line"></div><div class="line"><span class="meta">#</span> 拼接字段</div><div class="line">select (name, 'is in class ' ,class) from student_info; # 把查询出来的结果拼接起来形成新的字符串</div><div class="line"></div><div class="line"><span class="meta">#</span> 使用别名</div><div class="line">select (name, 'is in class ' ,class) as info from student_info;</div><div class="line"></div><div class="line"><span class="meta">#</span> 字段计算</div><div class="line">select  item, inventory, price, inventory*price as total from items_info;</div><div class="line"></div><div class="line"><span class="meta">#</span> 文本处理函数</div><div class="line">RTrim()  去掉右边的空格</div><div class="line">LTrim()  去掉左边的空格</div><div class="line">Trim()   去掉左右两边的空格</div><div class="line">Upper()  将文本转为大写字符</div><div class="line">Lower()  将文本转为小写字符</div><div class="line">Left()   返回文本最左边的字符</div><div class="line">Right()  返回文本最右边的字符</div><div class="line">Length() 返回文本长度</div><div class="line"></div><div class="line"><span class="meta">#</span> 日期处理函数</div><div class="line">AddDate() 增加一个日期(天、周等)</div><div class="line">AddTime() 增加一个时间(时、分等)</div><div class="line">CurDate() 返回当前日期</div><div class="line">CurTime() 返回当前时间</div><div class="line">Date()    返回日期时间和日期部分</div><div class="line">Datediff() 计算两个日期的差</div><div class="line">Date_Format() 返回一个格式化的日期或时间串</div><div class="line">DayOfWeek() 返回日期对应的是星期几</div><div class="line">Time()    返回一个日期时间的时间部分</div><div class="line">Year()    返回一个日期的年份部分</div><div class="line">Month()   返回日期的月数部分</div><div class="line">Day()     返回日期的天数部分</div><div class="line">Hour()    返回日期的小时部分</div><div class="line">Minute()  返回日期的分钟部分</div><div class="line">Second()  返回日期的秒数部分</div><div class="line">Now()     返回当前时间</div><div class="line"></div><div class="line"><span class="meta">#</span> 数值处理函数</div><div class="line">Abs()     返回一个数的绝对值</div><div class="line">Sqrt()    返回一个数的平方根</div><div class="line">Exp()     返回一个数的指数值</div><div class="line">Mod()     返回除操作的余数</div><div class="line">Pi()      返回圆周率</div><div class="line">Rand()    返回一个随机数</div><div class="line">Sin()     返回一个角度的正弦</div><div class="line">Cos()     返回一个角度的余弦</div><div class="line">Tan()     返回一个角度的正切</div><div class="line"></div><div class="line"><span class="meta">#</span> 汇聚函数</div><div class="line">AVG()     返回某列的平均值</div><div class="line">MAX()     返回某列的最大值</div><div class="line">MIN()     返回某列的最小值</div><div class="line">SUM()     返回某列的值的总和</div><div class="line">COUNT()   返回某列的行数</div><div class="line"></div><div class="line"><span class="meta">#</span> 数据分组</div><div class="line">select class, count(*) from student_info group by class # 查看每个班级有多少学生</div><div class="line">select class, count(*) from student_info group by class having count(*) &gt;40 # 查看班级人数大于40人的班级</div><div class="line"><span class="meta">#</span> where 过滤行数据, having 过滤分组数据</div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2018/03/14/junior-sql/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-03-13 </div>
			<div class="article-title"><a href="/2018/03/13/super/" >python之super</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h3 id="为什么需要super"><a href="#为什么需要super" class="headerlink" title="为什么需要super"></a>为什么需要super</h3><p>在python没有引入super之前, 如果需要在子类中引用父类的方法, 一般写法如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Father</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">whoami</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"I am father"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">whoami</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"I am child"</span>)</div><div class="line">    Father.whoami(self)</div></pre></td></tr></table></figure>
<p>这样看好像没什么问题, 就算没有super也能正常调用父类的方法, 但是如果有一天Father类需要修改类名为Father1, 那么子类Child中也必须跟着修改.<br>想象下如果一个类有很多个子类, 这样一来我们就需要修改每个子类中引用父类的语句</p>
<h3 id="怎么使用super"><a href="#怎么使用super" class="headerlink" title="怎么使用super"></a>怎么使用super</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Help on <span class="class"><span class="keyword">class</span> <span class="title">super</span> <span class="title">in</span> <span class="title">module</span> <span class="title">builtins</span>:</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">super</span><span class="params">(object)</span></span></div><div class="line"><span class="class"> |  <span class="title">super</span><span class="params">()</span> -&gt; same as super(__class__, &lt;first argument&gt;)</span></div><div class="line"><span class="class"> |  super(type) -&gt; unbound super object</span></div><div class="line"><span class="class"> |  super(type, obj) -&gt; bound super object; requires isinstance(obj, type)</span></div><div class="line"><span class="class"> |  super(type, type2) -&gt; bound super object; requires issubclass(type2, type)</span></div><div class="line"><span class="class"> |  Typical use to call a cooperative superclass method:</span></div><div class="line"> |  <span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(B)</span>:</span></div><div class="line"> |      <span class="function"><span class="keyword">def</span> <span class="title">meth</span><span class="params">(self, arg)</span>:</span></div><div class="line"> |          super().meth(arg)</div><div class="line"> |  This works <span class="keyword">for</span> <span class="class"><span class="keyword">class</span> <span class="title">methods</span> <span class="title">too</span>:</span></div><div class="line"> |  <span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(B)</span>:</span></div><div class="line"> |      @classmethod</div><div class="line"> |      <span class="function"><span class="keyword">def</span> <span class="title">cmeth</span><span class="params">(cls, arg)</span>:</span></div><div class="line"> |          super().cmeth(arg)</div></pre></td></tr></table></figure>
<p>我们来看看super的帮助文档, 首先super是一个类, 它的调用方法有如下几种:</p>
<ol>
<li>super()</li>
<li>super(type)</li>
<li>super(type, obj)</li>
<li>super(type, type2)</li>
</ol>
<p>我们推荐用第一种方法来使用super, 因为它并不需要显式传递任何参数.但是要注意一点, super只能在新式类中使用.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is A"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    super().__init__()</div><div class="line">    print(<span class="string">"this is B"</span>)</div><div class="line"></div><div class="line"></div><div class="line">b = B()</div><div class="line"></div><div class="line"><span class="string">"""</span></div><div class="line"><span class="string">this is A</span></div><div class="line"><span class="string">this is B</span></div><div class="line"><span class="string">"""</span></div></pre></td></tr></table></figure>
<p>看起来super就像直接调用了B的父类A的__init__, 其实并不是这样的, 我们看看super在多继承下的使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is A"</span>)</div><div class="line">    print(<span class="string">"leave A"</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is B"</span>)</div><div class="line">    super().__init__()</div><div class="line">    print(<span class="string">"leave B"</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is C"</span>)</div><div class="line">    super().__init__()</div><div class="line">    print(<span class="string">"leave C"</span>)</div><div class="line">  </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(B, C)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is D"</span>)</div><div class="line">    super().__init__()</div><div class="line">    print(<span class="string">"leave D"</span>)</div><div class="line">    </div><div class="line">    </div><div class="line">d = D()</div><div class="line"></div><div class="line"><span class="string">"""</span></div><div class="line"><span class="string">this is D</span></div><div class="line"><span class="string">this is B</span></div><div class="line"><span class="string">this is C</span></div><div class="line"><span class="string">this is A</span></div><div class="line"><span class="string">leave A</span></div><div class="line"><span class="string">leave C</span></div><div class="line"><span class="string">leave B</span></div><div class="line"><span class="string">leave D</span></div><div class="line"><span class="string">"""</span></div><div class="line"></div><div class="line">print(D.__mro__)</div><div class="line"><span class="string">"""</span></div><div class="line"><span class="string">(&lt;class '__main__.D'&gt;, </span></div><div class="line"><span class="string">&lt;class '__main__.B'&gt;, </span></div><div class="line"><span class="string">&lt;class '__main__.C'&gt;, </span></div><div class="line"><span class="string">&lt;class '__main__.A'&gt;, </span></div><div class="line"><span class="string">&lt;class 'object'&gt;)</span></div><div class="line"><span class="string">"""</span></div></pre></td></tr></table></figure>
<blockquote>
<p>这里可以看到, 如果super只是简单调用父类的方法的话, 那么调用了B的__init__ 方法之后, 应该调用A的__init__ 才对, 但是调用的却是C的__init__ 方法</p>
</blockquote>
<p>这是因为super调用的是当前类在MRO列表中的后一个类, 而并不是简单地调用当前类的父类</p>
<blockquote>
<p>python并没有强制性限制我们使用super调用父类, 我们还是可以使用原始的方法来调用父类中的方法, 但是需要注意的是调用父类的方法要统一, 即全用super或全不用super, 而用super 的话, 调用的方式也最好是统一的</p>
</blockquote>

	
	</div>
  <a type="button" href="/2018/03/13/super/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-03-12 </div>
			<div class="article-title"><a href="/2018/03/12/new-style-class-and-classic-class/" >python之新式类与旧式类</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>本文中代码运行的python版本一律采取2.7.13</strong></p>
<p>科普:</p>
<p>经典类:classic class</p>
<p>新式类:new-style class</p>
<ol>
<li><p>python2.2 之前并没有新式类</p>
</li>
<li><p>python2.2-2.7 新式类与经典类并存, 默认使用经典类, 除非显式继承object</p>
</li>
<li><p>python3.X 中去除了经典类, 用户定义的所有类都隐式继承自object</p>
</li>
</ol>
<h3 id="如何使用新式类"><a href="#如何使用新式类" class="headerlink" title="如何使用新式类"></a>如何使用新式类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">New</span><span class="params">(object)</span>:</span> <span class="comment"># 显式继承object类</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Old</span>:</span>  </div><div class="line">  <span class="keyword">pass</span></div><div class="line">  </div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Old2</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<p>上述代码中的3种定义类的方法, 只有第一种方法定义的是新式类.</p>
<h3 id="新式类VS经典类"><a href="#新式类VS经典类" class="headerlink" title="新式类VS经典类"></a>新式类VS经典类</h3><blockquote>
<p>新式类与经典类最主要的区别在于继承顺序, 事实上, 对于用户定义的每一个类, python 都会计算出一个<strong>方法解析顺序（Method Resolution Order, MRO）列表，它代表了类继承的顺序</strong>, 而由于经典类与新式类采用的算法不一致, 相同的继承关系可能会出现不一样的MRO列表.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> inspect</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(D)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(D)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(B, C)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line">    </div><div class="line"></div><div class="line"><span class="keyword">print</span> inspect.getmro(A)</div><div class="line"></div><div class="line"><span class="comment"># (&lt;class __main__.A at 0x000000000322BB88&gt;, </span></div><div class="line"><span class="comment"># &lt;class __main__.B at 0x000000000322B9A8&gt;, </span></div><div class="line"><span class="comment"># &lt;class __main__.D at 0x000000000322BC48&gt;, </span></div><div class="line"><span class="comment"># &lt;class __main__.C at 0x000000000322B948&gt;)</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(D)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(D)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(B, C)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> inspect.getmro(A)</div><div class="line"></div><div class="line"><span class="comment"># (&lt;class '__main__.A'&gt;, </span></div><div class="line">&lt;class '__main__.B'&gt;, </div><div class="line">&lt;class '__main__.C'&gt;, </div><div class="line">&lt;class '__main__.D'&gt;, </div><div class="line">&lt;type <span class="string">'object'</span>&gt;)</div></pre></td></tr></table></figure>
<p>可以看到, 经典类的MRO顺序A-B-D-C 与新式类的MRO顺序 A-B-C-D-object 是存在差异的, 这可能会是我们日常会遇到的坑. </p>
<p>而除了继承顺序的差异, 新式类还添加了内置属性__slots__</p>
<blockquote>
<p>一般来说, 每个实例都有一个字典来管理实例的属性, 我们可以用__dict__ 来查看(__dict__并不保存类属性),它允许我们动态地修改实例的属性, 但是这也意味着每个实例都会有1个独立的字典需要我们去维护, 当我们需要创建大量的实例时, 这个操作是十分消耗内存的.</p>
<p>当我们在定义类时添加了__slots__属性后, 对象在实例化时就不会创建字典来管理实例属性, 而实例只能定义在__slots__里边已经设定好的属性名, 不允许动态添加其他未在__slots__里定义的属性</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></div><div class="line">  __slots__ = (<span class="string">'id'</span>, <span class="string">'name'</span>, <span class="string">'gender'</span>)</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">exam</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line">s1 = Student()</div><div class="line"><span class="string">'__dict__'</span> <span class="keyword">in</span> dir(s1) <span class="comment"># False</span></div><div class="line">s1.id = <span class="number">10001</span></div><div class="line">s1.<span class="keyword">class</span> = <span class="number">1</span> </div><div class="line"><span class="comment"># AttributeError: 'Student' object has no attribute 'class'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line">s1.exam = func </div><div class="line"><span class="comment"># AttributeError: 'Student' object attribute 'f' is read-only</span></div></pre></td></tr></table></figure>
<p>使用__slots__ 后我们不再能够动态地修改实例的属性, 那么使用__slots__究竟有什么好处呢?</p>
<p>优点：</p>
<ol>
<li>节省内存</li>
<li>提高属性访问速度</li>
</ol>
<p>缺点:</p>
<ol>
<li>不能动态修改实例属性</li>
</ol>
<hr>
<p>当然, 除了继承顺序和__slots__, 新式类添加了__getattribute__方法, 还修改了实例的类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">New</span><span class="params">(object)</span>:</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line">  </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Old</span>:</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line">  </div><div class="line"> </div><div class="line">new = New()</div><div class="line">old = Old()</div><div class="line">print(new)</div><div class="line"><span class="comment"># &lt;__main__.New object at 0x0000000003262208&gt;</span></div><div class="line">print(old)</div><div class="line"><span class="comment"># &lt;__main__.Old instance at 0x000000000321C6C8&gt;</span></div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2018/03/12/new-style-class-and-classic-class/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-12-24 </div>
			<div class="article-title"><a href="/2017/12/24/agile/" >初涉敏捷开发</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="传统开发"><a href="#传统开发" class="headerlink" title="传统开发"></a>传统开发</h1><h3 id="瀑布模型"><a href="#瀑布模型" class="headerlink" title="瀑布模型"></a>瀑布模型</h3><p><img src="https://raw.githubusercontent.com/DearEirs/learn_python/master/AgileDevelopment/%E7%80%91%E5%B8%83%E6%A8%A1%E5%9E%8B.png" alt=""></p>
<p>优点：</p>
<pre><code>瀑布模型中把开发过程细分成多个步骤, 每个人各司其职,
开发人员只需按照文档完成需求即可
</code></pre><p>缺点：</p>
<pre><code>- 需要编写过多的文档
- 开发周期长,每个步骤都需要等待上一个步骤完成后才可
以开展工作
- 需求响应慢,每有一个新需求,都需要完整地走一遍流程
- 用户没有参与开发过程,不能很好地知道开发出来的产品
有没有符合客户的要求
</code></pre><h1 id="敏捷开发"><a href="#敏捷开发" class="headerlink" title="敏捷开发"></a>敏捷开发</h1><h3 id="敏捷开发是什么"><a href="#敏捷开发是什么" class="headerlink" title="敏捷开发是什么"></a>敏捷开发是什么</h3><p>敏捷开发不是一套明确的流程,也不是一种方法或者工具,敏捷开发是遵循着敏捷宣言的一种思想, 所有遵循这种思想的实践都可以称为敏捷开发.</p>
<p>敏捷开发的核心思想：<strong>以人为本，专注交付对客户有价值的软件。在高度协作的环境中，使用迭代式的方式进行增量开发，经常根据反馈进行思考、反省和总结，不停地自我调整和完善，让软件开发与交付轻量而敏捷。</strong></p>
<h5 id="敏捷宣言"><a href="#敏捷宣言" class="headerlink" title="敏捷宣言"></a>敏捷宣言</h5><ul>
<li>个体和互动 高于 流程和工具</li>
<li>工作的文件 高于 详尽的文档</li>
<li>客户合作 高于 合同谈判</li>
<li>响应变化 高于 遵循计划</li>
</ul>
<h3 id="敏捷开发怎么做"><a href="#敏捷开发怎么做" class="headerlink" title="敏捷开发怎么做"></a>敏捷开发怎么做</h3><p>敏捷开发是一种思想, 那么XP(极限编程), Scrum, DSDM等就是这种思想具体的实践</p>
<h4 id="XP"><a href="#XP" class="headerlink" title="XP"></a>XP</h4><p>XP是一种使用于在需求不明,或快速多变的情况下进行软件开发的轻量级方法学,其核心价值观为：</p>
<ul>
<li>简单：只做必做的、最小设计、持续重构</li>
<li>沟通：及时有效，目的是一起创造最好的解决方案</li>
<li>反馈：严重承诺，尽快交付，认真听取反馈并及时改进</li>
<li>尊重：互相尊重，通过努力工作获得认同</li>
<li>勇气：如实反馈进展和预估，不为没完成的计划找借口，<br>勇于根据根据情况随时调整工作方式</li>
</ul>
<p><img src="https://raw.githubusercontent.com/DearEirs/learn_python/master/AgileDevelopment/XP.png" alt=""></p>
<p>XP的核心实践：</p>
<ul>
<li>Whole Team: 用户参与到开发团队, 协作开发更好地开发出用户所需要的功能</li>
<li>Planning Game：用户通过用户故事提出需求,开发人员作出发布计划和迭代计划并作出承诺如期完成任务</li>
<li>Customer Test：验收测试, 由客户来检验系统是否完成了既定的功能</li>
<li>Small Releases：最小发布, 即每开发出一个可正常工作的功能就可以发布</li>
<li>Collective Code Ownership： 集体代码所有权, 项目中的每个人都可以看到项目完整的代码</li>
<li>Coding Standards：编码风格统一</li>
<li>Sustainable Pace: 可持续的开发速度</li>
<li>Metaphor：全项目命名风格统一</li>
<li>Continuous Integration：持续集成</li>
<li>Test-driven development：测试驱动开发,编写覆盖率高的测试用例</li>
<li>Simple Design：用最简单的设计来完成工作</li>
<li>Refactoring：重构,去掉冗余代码,提高代码质量</li>
<li>Pair Programming：结对编程, 由两个程序员完成同一个需求, 可以再实现功能的同时review代码</li>
</ul>
<p>XP的过程：从用户根据用户故事提起需求后, 进行架构刺探, 功能刺探, 然后指定发布计划, 每次迭代发布周期为1-2周, 开发出完整功能后进行验收测试, 通过方可发布.</p>
<hr>
<h4 id="Scrum"><a href="#Scrum" class="headerlink" title="Scrum"></a>Scrum</h4><p><img src="https://raw.githubusercontent.com/DearEirs/learn_python/master/AgileDevelopment/Scrum.png" alt=""></p>
<p>由用户提起需求, 产品经理分析用户需求做出产品订单后, 进行冲刺计划会议, 制定每次冲刺需要完成的需求, 而一次冲刺的周期为3-4周,在冲刺过程中,成员自由领取冲刺订单,冲刺订单中包含着细化后的需求信息.冲刺期间每日都要召开站立会议,成员们各自讲述自己昨天你完成了哪些工作?今天你打算做什么?完成你的目标是否存在什么障碍?而在冲刺结束后, 同样会有冲刺回顾会议,会议上所有成员对这次会议进行反思</p>
<h4 id="XP-VS-Scrum"><a href="#XP-VS-Scrum" class="headerlink" title="XP VS Scrum"></a>XP VS Scrum</h4><p>XP相对于Scrum：</p>
<ul>
<li>迭代周期: XP迭代周期为1-2周, Scrum迭代周期为3-4周(现在多为1-2周)</li>
<li>应付新需求: 在XP中, 有限制地允许用户更改需求, 而Scrum中则不允许这样做, 一旦需求确定, 不可更改</li>
<li>开发过程: 在开发过程中, XP严格按照需求的优先级来开发, 而Scrum可以不按照需求优先级开发</li>
<li>实施规范: Scrum实施的过程中, 并没有规定采用XP中要求的结对编程、TDD、简单设计等行为</li>
</ul>
<h4 id="精益"><a href="#精益" class="headerlink" title="精益"></a>精益</h4><p>拉动式生产, 即当有需求的时候才开始生产, 这样做可以避免资源浪费,<br>自动化生产, 提高生产的效率</p>
<h3 id="为什么要使用敏捷开发"><a href="#为什么要使用敏捷开发" class="headerlink" title="为什么要使用敏捷开发"></a>为什么要使用敏捷开发</h3><p>在传统瀑布式开发的过程中存在的问题：</p>
<ul>
<li>项目文档繁重, 在编写文档上花费了过多的时间</li>
<li>用户对开发进度一无所知</li>
</ul>
<p>而在XP和Scrum中我们可以发现其共同点, 这也是敏捷开发的优势：</p>
<ul>
<li>持续集成, 产品一直处于可运行状态, 而开发人员只进行增量开发</li>
<li>开发前, 不需要编写太多的文档</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>并不是说敏捷开发就一定要比传统的瀑布式开发要好, 只能说各有所长, 而敏捷开发更适用于当前的软件开发当中.</p>
<hr>
<p>敏捷开发结合到自身工作中：</p>
<p>项目：ELK日志收集</p>
<p>需求：</p>
<ul>
<li>开发：可以看到系统日志, 用于发现,修复问题</li>
<li>老板：可以看到系统的访问量, 查询的响应时间的信息</li>
</ul>
<p>计划：</p>
<ul>
<li>搭建环境, 耗时0.5天</li>
<li>收集系统日志, 耗时0.5天</li>
<li>分析系统日志, 耗时0.5天</li>
</ul>
<blockquote>
<p>搭建环境时, 需要开发参与, 日志具体是在那台机器上, 并到对应的机器上安装所需软件.</p>
</blockquote>
<p>完成搭建环境时就可以向老板和开发展示,环境已经搭建完, 下一步是收集日志</p>
<blockquote>
<p>这时又需要开发提供日志的目录, 以供收集, 并编写相应的使用文档, 给开发和老板使用</p>
</blockquote>
<p>当收集完成后, 这时开发的需求已经完成, 可以让开发进行测试, 看看对日志收集功能是否满意, 是否有其他需求, 如果没有其他需求, 那么可以进行到下一步,分析日志</p>
<blockquote>
<p>分析日志期间需要老板和开发的共同参与, 老板提供具体想要看到的信息, 开发方面可能需要修改日志格式,然后进行分析得出报表</p>
</blockquote>
<p>这时整个搭建完成, 只完成了开发和老板所需要的功能, 每完成1个步骤都向老板和开发反馈, 用户参与到了搭建过程中, 有新需求或者需求做的不对时, 能够很快的得到反馈并作出调整</p>
<hr>
<p>瀑布式开发模式结合到公司管理：</p>
<p>相对于一个创业公司,很多工作有时候并没有规范到位, 这就需要有一套完整流程规范来让别人遵守, 花费一段时间来制定一套规范标准, 比每次遇到问题各成员间不知如何合作, 不知道自己应该负责什么部分要好</p>

	
	</div>
  <a type="button" href="/2017/12/24/agile/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-11-15 </div>
			<div class="article-title"><a href="/2017/11/15/ELK/" >ELK搭建</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>系统：centos7.2 </li>
<li>redis：3.2.6 </li>
<li>filebeat：5.6.3</li>
<li>elasticsearch：5.6.3</li>
<li>kibana：5.6.3</li>
<li>x-pack：5.6.3</li>
<li>jdk：1.8</li>
</ul>
<p><strong>ELK的版本尽量统一</strong></p>
<h1 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">elasticsearch</div><div class="line">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.3.tar.gz</div><div class="line"></div><div class="line">filebeat</div><div class="line">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.6.3-linux-x86_64.tar.gz</div><div class="line"></div><div class="line">kibana</div><div class="line">https://artifacts.elastic.co/downloads/kibana/kibana-5.6.3-linux-x86_64.tar.gz</div><div class="line"></div><div class="line">logstash</div><div class="line">https://artifacts.elastic.co/downloads/logstash/logstash-5.6.3.tar.gz</div><div class="line"></div><div class="line">redis</div><div class="line">http://download.redis.io/releases/redis-3.2.6.tar.gz</div></pre></td></tr></table></figure>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote>
<p>安装的话只需要把下载回来的tar包解压即可,项目运行需要jdk支持, jdk自行安装</p>
</blockquote>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h3 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h3><blockquote>
<p>redis不是本文重点, 所以配置就不展开细说.</p>
</blockquote>
<h3 id="filebeat"><a href="#filebeat" class="headerlink" title="filebeat"></a>filebeat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"># 输入</div><div class="line">filebeat:</div><div class="line">  prospectors: # 可加多个, 用-分割, 每个prospectors可以有不同的配置</div><div class="line">    -</div><div class="line">      input_type: log</div><div class="line">      paths: # 可加多个, 每行一个用-分割</div><div class="line">        - /data/logs/portal/logs/info.log</div><div class="line">      fields: # 需要添加的字段</div><div class="line">        app: portal</div><div class="line">        host: zsmd2</div><div class="line">      include_lines: [&quot;ERROR&quot;] # 匹配包含&quot;INFO&quot;的消息</div><div class="line">      # 开启多行匹配</div><div class="line">      # pattern 消息按指定内容划分, </div><div class="line">      multiline.pattern: &apos;^\[&apos;</div><div class="line">      multiline.negate: true</div><div class="line">      multiline.match: after</div><div class="line">    -</div><div class="line">      input_type: log</div><div class="line">      paths: # 路径匹配也可以用正则</div><div class="line">        - /data/apps/ops/demo-service-provider*/bin/api.log</div><div class="line">      fields:</div><div class="line">        app: dubbo</div><div class="line">        host: zsmd2</div><div class="line">      multiline.pattern: &apos;^\d&#123;2&#125;:\d&#123;4&#125;:\d&#123;2&#125;&apos;</div><div class="line">      multiline.negate: true</div><div class="line">      multiline.match: after</div><div class="line">    -</div><div class="line">      input_type: log</div><div class="line">      paths:</div><div class="line">        - /data/apps/ops/smart-schedule/schedule/logs/error.log</div><div class="line">      fields:</div><div class="line">        app: schedule</div><div class="line">        host: zsmd2</div><div class="line">      multiline.pattern: &apos;^\[&apos;</div><div class="line">      multiline.negate: true</div><div class="line">      multiline.match: after</div><div class="line"></div><div class="line"># 输出</div><div class="line"># 输出到redis</div><div class="line">output.redis:</div><div class="line">   enabled: true</div><div class="line">   hosts: [&quot;172.16.0.237:6379&quot;] # 有多个的话用逗号分隔, 写在列表里边</div><div class="line">   key: &quot;zsdata&quot;</div><div class="line">   datatype: list</div><div class="line">   input_type: logs</div><div class="line">   password: &apos;redis&apos;</div><div class="line"></div><div class="line"># 输出到控制台, 可以省略, 搭建时主要为了方便看到数据</div><div class="line">output.console:</div><div class="line">  enabled: true</div><div class="line"></div><div class="line">参考：http://blog.csdn.net/chengxuyuanyonghu/article/details/54378778</div></pre></td></tr></table></figure>
<h3 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">cluster.name: elasticsearch-cluster # 集群名</div><div class="line">node.name: zsad1 # 节点名</div><div class="line">node.master: true </div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">discovery.zen.minimum_master_nodes: 1 # </div><div class="line"># xpack参数 不用的话可略, 下面再细讲xpack破解</div><div class="line">xpack.security.enabled: true</div></pre></td></tr></table></figure>
<h3 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"># 输入</div><div class="line">input&#123;</div><div class="line">    redis &#123;</div><div class="line">        host =&gt; &quot;172.16.0.237&quot;</div><div class="line">        port =&gt; 6379</div><div class="line">        threads =&gt; 5 </div><div class="line">        data_type =&gt; &quot;list&quot;</div><div class="line">        type =&gt; &apos;redis-input&apos;</div><div class="line">        key =&gt; &quot;zsdata&quot;</div><div class="line">        password =&gt; &apos;password&apos;</div><div class="line">    &#125;</div><div class="line"># 过滤</div><div class="line">    # 移除不需要的字段</div><div class="line">    mutate&#123;</div><div class="line">        remove_field =&gt; [&quot;type&quot;, &quot;input_type&quot;, &quot;offset&quot;, &quot;beat&quot;, &quot;\@version&quot;, &apos;@version&apos;, &quot;@version&quot;]</div><div class="line">    &#125;</div><div class="line"></div><div class="line"># 输出</div><div class="line">output&#123;</div><div class="line">    # 输出数据到elasticsearch</div><div class="line">    elasticsearch&#123;</div><div class="line">      hosts =&gt; [&quot;172.16.0.80:9200&quot;]</div><div class="line">      user =&gt; &apos;username&apos;</div><div class="line">      password =&gt; &apos;password&apos;</div><div class="line">      index =&gt; &quot;zsdata-%&#123;+dd-MM-YYYY&#125;&quot; # 索引</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    # 判断是否有错误日志, 有的话就调用脚本发送邮件,  127.0.0.1:5000是自己写的发送邮件脚本</div><div class="line">    if &quot;ERROR&quot; in [message] &#123;</div><div class="line">      exec &#123;</div><div class="line">         command =&gt; &quot;curl  -XPOST -H  &apos;Content-Type: application/json&apos; 127.0.0.1:5000/email -d &apos;&#123;\&quot;message\&quot;: \&quot;%&#123;message&#125;\nsource at %&#123;source&#125;\&quot;, \&quot;from\&quot;:\&quot;xxxxxxxx@qq.com\&quot;, \&quot;to\&quot;:\&quot;xxxxxxxx@qq.com\&quot;, \&quot;subject\&quot;: \&quot;%&#123;fields[app]&#125; Get Error log in  %&#123;fields[host]&#125;\&quot;&#125;&apos; &quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    # 输出到控制台, 方便调试</div><div class="line">    stdout&#123; codec=&gt; &quot;rubydebug&quot; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">server.host: 0.0.0.0</div><div class="line"># elasticsearch 的地址</div><div class="line">elasticsearch.url: &quot;http://172.16.0.80:9200&quot;</div><div class="line"># 使用xpack后需要登录 以下为默认账号</div><div class="line">elasticsearch.username: &quot;elastic&quot;</div><div class="line">elasticsearch.password: &quot;changeme&quot;</div><div class="line">xpack.monitoring.enabled: true</div><div class="line">i18n.defaultLocale: &quot;cn&quot;</div></pre></td></tr></table></figure>
<h3 id="xpack破解"><a href="#xpack破解" class="headerlink" title="xpack破解"></a>xpack破解</h3><p><a href="http://blog.csdn.net/mvpboss1004/article/details/65445023" target="_blank" rel="external">参考地址：http://blog.csdn.net/mvpboss1004/article/details/65445023</a></p>

	
	</div>
  <a type="button" href="/2017/11/15/ELK/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-10-24 </div>
			<div class="article-title"><a href="/2017/10/24/salt-file-backup/" >salt分发文件时自动备份</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>在日常工作中,我们经常会用saltstack来分发文件,但是如果稍有不慎就会不小心覆盖掉之前不想修改的文件,这样我们就需要回滚,但是又不知道具体被修改了那些地方,那么我们就需要一个备份的功能,每次分发文件时,如果有文件被修改,那么就将文件备份到指定目录,这样就算出错,我们也可以把原文件替换回去.</p>
</blockquote>
<hr>
<p>那么我们有2种方法:</p>
<ol>
<li>在minion的配置文件中添加backup_mode: minion</li>
<li>在执行分发文件的states时,添加参数backup: minion</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 借用官网的例子</div><div class="line">/etc/ssh/sshd_config:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://ssh/sshd_config</div><div class="line">    - backup: minion</div></pre></td></tr></table></figure>
<p>当sls 执行时发现sshd_config,被修改了的话,那么salt就会自动帮你备份sshd_config到/var/cache/salt/minion/file_backup(默认路径),并在文件名后面加上具体的日期方便查看.</p>
<p>这样就算我们误操作把原文件覆盖掉,我们也有备份文件可以还原.</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://note.youdao.com/" target="_blank" rel="external">https://docs.saltstack.com/en/latest/ref/states/backup_mode.html#file-state-backups</a></p>

	
	</div>
  <a type="button" href="/2017/10/24/salt-file-backup/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-29 </div>
			<div class="article-title"><a href="/2017/09/29/k-vim/" >k-vim安装配置</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h3 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h3><p><strong>本实验在centos7.2环境下执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install -y git python-devel.x86_64 the_silver_searcher cmake wget zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-develtk-devel gdbm-devel db4-devel libpcap-devel xz-devel readline</div><div class="line">yum groupinstall -y &apos;Development Tools&apos;</div><div class="line">rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</div></pre></td></tr></table></figure></p>
<h3 id="安装pip"><a href="#安装pip" class="headerlink" title="安装pip"></a>安装pip</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py</div><div class="line">python ./get-pip.py</div><div class="line"></div><div class="line"># pip 设置代理</div><div class="line">1. pip install xxx -i https://pypi.tuna.tsinghua.edu.cn/simple</div><div class="line"></div><div class="line">2. 用户家目录下新建.pip目录 添加pip.conf文件如下</div><div class="line">[global]</div><div class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</div></pre></td></tr></table></figure>
<h3 id="安装pyenv-virtualenv"><a href="#安装pyenv-virtualenv" class="headerlink" title="安装pyenv-virtualenv"></a>安装pyenv-virtualenv</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">curl -L https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer | bash</div><div class="line"></div><div class="line"># 添加到/etc/profile</div><div class="line">export PATH=&quot;~/.pyenv/bin:$PATH&quot;</div><div class="line">eval &quot;$(pyenv init -)&quot;</div><div class="line">eval &quot;$(pyenv virtualenv-init -)&quot;</div><div class="line"></div><div class="line"># soure一下添加到当前环境变量</div><div class="line">source /etc/profile</div></pre></td></tr></table></figure>
<h3 id="安装Python3-6"><a href="#安装Python3-6" class="headerlink" title="安装Python3.6"></a>安装Python3.6</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># 先添加环境变量  不然后边安装YCM会有坑！！！</div><div class="line">export PYTHON_CONFIGURE_OPTS=&quot;--enable-shared&quot;</div><div class="line">pyenv install  3.6.1</div><div class="line"></div><div class="line"># 安装本地软件包的方法</div><div class="line"># 指定安装URL</div><div class="line">export PYTHON_BUILD_MIRROR_URL=&quot;http://127.0.0.1:8000/&quot;</div><div class="line"># 到含有软件包的目录下运行</div><div class="line">python -m SimpleHTTPServer 8000</div><div class="line"># 然后新开一个终端执行</div><div class="line">pyenv install 3.6.1</div><div class="line"># 这时第一个终端会报错</div><div class="line">&quot;HEAD /a01810ddfcec216bcdb357a84bfaafdfaa0ca42bbdaa4cb7ff74f5a9961e4041 HTTP/1.1&quot; 404 -</div><div class="line"># 然后把python安装包命名为a01810ddfcec216bcdb357a84bfaafdfaa0ca42bbdaa4cb7ff74f5a9961e4041重新安装即可</div><div class="line">mv ./Python-3.6.1.tar.xz  ./a01810ddfcec216bcdb357a84bfaafdfaa0ca42bbdaa4cb7ff74f5a9961e4041</div><div class="line"># 这时候再次安装,pyenv就会到本地下载软件包</div><div class="line">pyenv install 3.6.1</div><div class="line"># 切换到3.6.1版本</div><div class="line">pyenv global 3.6.1</div></pre></td></tr></table></figure>
<h3 id="编译安装vim"><a href="#编译安装vim" class="headerlink" title="编译安装vim"></a>编译安装vim</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># 编译安装vim是为了让vim支持python3</div><div class="line"># 这里之所以把python2也加进去编译是因为不添加python2支持会导致安装YCM后无法打开vim</div><div class="line">wget ftp://ftp.vim.org/pub/vim/unix/vim-8.0.tar.bz2 -O vim-8.0.tar.bz2</div><div class="line">tar -xvf ./vim-8.0.tar.bz2</div><div class="line">cd ./vim80</div><div class="line">./configure --with-features=huge \</div><div class="line">            --enable-multibyte \</div><div class="line">            --enable-pythoninterp=yes \</div><div class="line">            --with-python-config-dir=/usr/lib64/python2.7/config \</div><div class="line">            --enable-python3interp=yes \</div><div class="line">            --with-python3-config-dir=/root/.pyenv/versions/3.6.1/lib/python3.6/config-3.6m-x86_64-linux-gnu \</div><div class="line">            --enable-gui=gtk3 --enable-cscope --prefix=/data/vim80</div><div class="line"></div><div class="line">make &amp;&amp; make install</div><div class="line"></div><div class="line"># 备份 vi</div><div class="line">mv /usr/bin/vi /usr/bin/vi.bak</div><div class="line">ln -s /data/vim80/bin/vim /usr/bin/vi</div><div class="line"># 检查vim  输出中有+python3即可</div><div class="line">vi --version</div></pre></td></tr></table></figure>
<h3 id="编译安装clang"><a href="#编译安装clang" class="headerlink" title="编译安装clang"></a>编译安装clang</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># 这里编译clang是为了等下编译YCM作准备. (PS:万恶的YCM)</div><div class="line">wget http://releases.llvm.org/3.3/llvm-3.3.src.tar.gz</div><div class="line">wget http://releases.llvm.org/3.3/cfe-3.3.src.tar.gz</div><div class="line">wget http://releases.llvm.org/3.3/clang-tools-extra-3.3.src.tar.gz</div><div class="line">wget http://releases.llvm.org/3.3/compiler-rt-3.3.src.tar.gz</div><div class="line">wget http://releases.llvm.org/3.3/libcxx-3.3.src.tar.gz</div><div class="line"></div><div class="line"># 分别解压</div><div class="line"></div><div class="line">mv cfe-3.3.src clang</div><div class="line">mv clang/ llvm-3.3.src/tools/</div><div class="line">mv clang-tools-extra-3.3.src extra</div><div class="line">mv extra/ llvm-3.3.src/tools/clang/</div><div class="line">mv compiler-rt-3.3.src compiler-rt</div><div class="line">mv compiler-rt llvm-3.3.src/projects/</div><div class="line"></div><div class="line">mkdir build-3.3</div><div class="line">cd ./build-3.3</div><div class="line"># 编译前换回系统默认的Python版本</div><div class="line">pyenv global system</div><div class="line">../llvm-3.3.src/configure --enable-optimized --enable-targets=host-only</div><div class="line">make -j8</div><div class="line">make install</div></pre></td></tr></table></figure>
<h3 id="安装k-vim"><a href="#安装k-vim" class="headerlink" title="安装k-vim"></a>安装k-vim</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">pip install flake8 yapf</div><div class="line">git clone https://github.com/wklken/k-vim.git k-vim</div><div class="line">cd k-vim</div><div class="line"># 先安装YCM</div><div class="line">mkdir ./bundle</div><div class="line">wget -O YouCompleteMe.tar.gz &quot;http://ohpunyak1.bkt.clouddn.com/YouCompleteMe.tar.gz?v=9999&quot;</div><div class="line">tar -zxvf ./YouCompleteMe.tar.gz</div><div class="line">cd ./YouCompleteMe</div><div class="line">CXX=&quot;/usr/local/bin/clang++&quot; ./install.py</div><div class="line"># 回到 k-vim的目录</div><div class="line">cd ~/k-vim</div><div class="line">sh ./install.sh</div><div class="line"># 这时候依然会报错,但是已经可以用了</div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">vi ~/k-vim/vimrc</div><div class="line"># F3 打开目录树 360行左右</div><div class="line">nnoremap &lt;F3&gt; :NERDTreeToggle  &lt;CR&gt;</div><div class="line"></div><div class="line"># 自动插入文件头 600行左右</div><div class="line"># 判断文件类型为py文件则添加一下内容,其他文件同理</div><div class="line">if &amp;filetype == &apos;python&apos;</div><div class="line">    call setline(1,&quot;\#!/usr/bin/env python&quot;)</div><div class="line">    call append(1,strftime(&quot;# %Y-%m-%d %H:%M:%S&quot;))</div><div class="line">    call append(1,&quot;\# arthur:Dear&quot;)</div><div class="line">    call append(1,&quot;\# -*- coding:utf-8 -*-&quot;)</div><div class="line">endif</div><div class="line"></div><div class="line"># 更换主题 660行左右</div><div class="line">&quot; colorscheme solarized</div><div class="line">colorscheme molokai</div><div class="line">&quot; colorscheme desert</div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2017/09/29/k-vim/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-21 </div>
			<div class="article-title"><a href="/2017/09/21/jinja2/" >django中使用jinja2模板</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<ol>
<li>添加env.py文件</li>
<li>添加backend.py文件</li>
<li>修改setting.py配置</li>
</ol>
<blockquote>
<p>env.py文件与backend.py文件添加到app目录下即可</p>
</blockquote>
<hr>
<h3 id="env-py"><a href="#env-py" class="headerlink" title="env.py"></a>env.py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">from django.contrib.staticfiles.storage import staticfiles_storage</div><div class="line">from django.urls import reverse</div><div class="line"></div><div class="line">from jinja2 import Environment</div><div class="line"></div><div class="line"></div><div class="line">def environment(**options):</div><div class="line">    env = Environment(**options)</div><div class="line">    env.globals.update(&#123;</div><div class="line">        &apos;static&apos;: staticfiles_storage.url,</div><div class="line">        &apos;url&apos;: reverse,</div><div class="line">    &#125;)</div><div class="line">    return env</div></pre></td></tr></table></figure>
<h3 id="backend-py"><a href="#backend-py" class="headerlink" title="backend.py"></a>backend.py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">import sys</div><div class="line"></div><div class="line">from django.template.backends import jinja2 as jinja2backend</div><div class="line">from django.template.backends.utils import csrf_input_lazy, csrf_token_lazy</div><div class="line">from django.template import TemplateDoesNotExist, TemplateSyntaxError</div><div class="line">from django.utils.module_loading import import_string</div><div class="line">import jinja2</div><div class="line">import six</div><div class="line"></div><div class="line"></div><div class="line"># Original link:</div><div class="line"># https://code.djangoproject.com/attachment/ticket/24694/24694.py</div><div class="line">__author__ = &apos;carljm&apos;</div><div class="line"></div><div class="line"></div><div class="line">class Jinja2Backend(jinja2backend.Jinja2):</div><div class="line">    def __init__(self, params):</div><div class="line">        self.context_processors = [</div><div class="line">            import_string(p)</div><div class="line">            for p in params[&apos;OPTIONS&apos;].pop(&apos;context_processors&apos;, [])</div><div class="line">        ]</div><div class="line">        super(Jinja2Backend, self).__init__(params)</div><div class="line"></div><div class="line">    def from_string(self, template_code):</div><div class="line">        return Template(</div><div class="line">            self.env.from_string(template_code), self.context_processors)</div><div class="line"></div><div class="line">    def get_template(self, template_name):</div><div class="line">        try:</div><div class="line">            return Template(</div><div class="line">                self.env.get_template(template_name), self.context_processors)</div><div class="line">        except jinja2.TemplateNotFound as exc:</div><div class="line">            six.reraise(TemplateDoesNotExist, TemplateDoesNotExist(exc.args),</div><div class="line">                        sys.exc_info()[2])</div><div class="line">        except jinja2.TemplateSyntaxError as exc:</div><div class="line">            six.reraise(TemplateSyntaxError, TemplateSyntaxError(exc.args),</div><div class="line">                        sys.exc_info()[2])</div><div class="line"></div><div class="line"></div><div class="line">class Template(jinja2backend.Template):</div><div class="line"></div><div class="line">    def __init__(self, template, context_processors):</div><div class="line">        self.template = template</div><div class="line">        self.context_processors = context_processors</div><div class="line"></div><div class="line">    def render(self, context=None, request=None):</div><div class="line">        if context is None:</div><div class="line">            context = &#123;&#125;</div><div class="line">        if request is not None:</div><div class="line">            context[&apos;request&apos;] = request</div><div class="line">            lazy_csrf_input = csrf_input_lazy(request)</div><div class="line">            context[&apos;csrf&apos;] = lambda: lazy_csrf_input</div><div class="line">            context[&apos;csrf_input&apos;] = lazy_csrf_input</div><div class="line">            context[&apos;csrf_token&apos;] = csrf_token_lazy(request)</div><div class="line">            for cp in self.context_processors:</div><div class="line">                context.update(cp(request))</div><div class="line">            print(context)</div><div class="line">        return self.template.render(context)</div></pre></td></tr></table></figure>
<h3 id="settings-py"><a href="#settings-py" class="headerlink" title="settings.py"></a>settings.py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">TEMPLATES = [ </div><div class="line">      &#123;   </div><div class="line">          &apos;BACKEND&apos;: &apos;django.template.backends.jinja2.Jinja2&apos;,</div><div class="line">          &apos;DIRS&apos;: [os.path.join(BASE_DIR, &apos;templates&apos;)],</div><div class="line">          &apos;APP_DIRS&apos;: True,</div><div class="line">          &apos;OPTIONS&apos;: &#123;</div><div class="line">              &apos;context_processors&apos;: [</div><div class="line">                  &apos;django.template.context_processors.debug&apos;,</div><div class="line">                  &apos;django.template.context_processors.request&apos;,</div><div class="line">                  &apos;django.contrib.auth.context_processors.auth&apos;,</div><div class="line">                  &apos;django.contrib.messages.context_processors.messages&apos;,</div><div class="line">                  &apos;yourappname.env.environment&apos;,</div><div class="line">              ],  </div><div class="line">          &#125;,  </div><div class="line">      &#125;,  </div><div class="line">]</div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2017/09/21/jinja2/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-14 </div>
			<div class="article-title"><a href="/2017/09/14/salt-sls/" >saltstack(四)sls编写</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>sls文件作为saltstack中重要的一环,是必须掌握的</p>
<h1 id="入门篇"><a href="#入门篇" class="headerlink" title="入门篇"></a>入门篇</h1><p>放在入门篇的开始,带大家来了解一下sls的执行顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;minion1&apos; state.sls nginx.install</div></pre></td></tr></table></figure>
<p>这是一个执行sls的命令,那么这个命令会读取那些文件呢?</p>
<ol>
<li>遍历saltstack配置文件里边的file_roots</li>
<li>寻找file_roots 里边的nginx目录</li>
<li>访问java目录下的nginx.sls</li>
</ol>
<p>上面命令执行时,指定了Java目录下的nginx.sls文件,而实际上有时候是可以不指定的,如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;minion1&apos; state.sls java</div></pre></td></tr></table></figure>
<p>这时候saltstack就会访问到java目录下的init.sls</p>
<hr>
<p>简单的sls编写:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">nginx_install:   # sls_id 不可重复</div><div class="line">  pkg.installed: # 模块方法</div><div class="line">    - pkgs:      # 参数</div><div class="line">      - nginx</div><div class="line"></div><div class="line">nginx_conf:</div><div class="line">  file.managed:</div><div class="line">    - name: /etc/nginx/nginx.conf</div><div class="line">    - source: salt://nginx.conf</div><div class="line">    - require:</div><div class="line">      - pkg: nginx_install</div></pre></td></tr></table></figure></p>
<ul>
<li>:与- 后需要空格</li>
<li>salt:// 想当于master的file_roots目录</li>
<li>多个 - 表示列表</li>
<li>每一级缩进由2个空格组成,不能用Tab</li>
</ul>
<p>就这一个简单的sls就可以安装nginx,并把nginx.conf替换成预先写好的配置文件</p>
<p>而再看一下这个:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">nginx:</div><div class="line">  pkg.installed:</div><div class="line"></div><div class="line">/etc/nginx/nginx.conf:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://nginx.conf</div><div class="line">    - require:</div><div class="line">      - pkg: nginx_install</div></pre></td></tr></table></figure></p>
<p>这次的代码对比上面, - pkgs 和 - names 的内容不见了,相反把sls_id 的名字分别改成了nginx<br>和/etc/nginx/nginx.conf</p>
<p>这样写和上面的效果是一样的,当sls执行需要指定名字是,如果sls里边没有定义,那么默认会用sls_id的值</p>
<p>至于更多的模块方法可以到官网去找到<a href="https://docs.saltstack.com/en/latest/contents.html" target="_blank" rel="external">saltstack官网</a></p>
<h3 id="引入其他sls文件"><a href="#引入其他sls文件" class="headerlink" title="引入其他sls文件"></a>引入其他sls文件</h3><p>include 就像nginx一样,include表示包含某个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">include:</div><div class="line">  - nginx.install</div><div class="line">  - nginx.config</div></pre></td></tr></table></figure>
<p>这样我们就在文件中引入了nginx目录下的install.sls(sls忽略不写了)和nginx.config.sls文件了</p>
<h3 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h3><p>经常会听到别人说sls执行时是无序的,那么我们怎么做才能使得sls安装我们预期来执行呢?</p>
<ol>
<li>include引入的文件会被先执行</li>
<li>每个sls定义时可以定义order值,order值从小到大执行</li>
<li>按照依赖关系执行</li>
</ol>
<p>下面看看order的用法,至于依赖关系,可以看回文章开始时的使用,分辨出require与require_in的作用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">nginx:</div><div class="line">  pkg:</div><div class="line">  - installed</div><div class="line">  - order: 1</div><div class="line"></div><div class="line">/etc/nginx/nginx.conf:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://nginx.conf</div><div class="line">    - require:</div><div class="line">      - pkg: nginx_install</div><div class="line">    - order: 2</div></pre></td></tr></table></figure></p>
<h1 id="进阶篇"><a href="#进阶篇" class="headerlink" title="进阶篇"></a>进阶篇</h1><p>在知道了更多的模块方法后,我们基本可以用sls来完成大部分事情,但这还不能满足我们,下面再来看看一些关于sls的小技巧</p>
<h3 id="jinja"><a href="#jinja" class="headerlink" title="jinja"></a>jinja</h3><p>在sls的文件中,我们还可以使用用jinja语法来控制sls执行,或者配置文件等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;% if grins[os] == &apos;Centos&apos; %&#125;</div><div class="line"></div><div class="line">nginx:</div><div class="line">  pkg.installed:</div><div class="line"></div><div class="line">/etc/nginx/nginx.conf:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://nginx.conf</div><div class="line">    - require:</div><div class="line">      - pkg: nginx_install</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
<p>一个十分简单的例子,但这并不能说明jinja的强大,除了if还有set,for,marco等等,jinja的强大之处还需要大家独自去领悟</p>
<h3 id="引用外部变量"><a href="#引用外部变量" class="headerlink" title="引用外部变量"></a>引用外部变量</h3><p>知道了jinja控制和引用变量之后也都不能满足与所有需求,有时候我们需要在执行时来定义变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;minion1&apos; state.sls nginx.install pillar=&apos;&#123;&quot;version&quot;:&quot;1.13.4&quot;&#125;&apos;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">nginx:</div><div class="line">  pkg.installed:</div><div class="line">&#123;% if pillar[&quot;version&quot;] %&#125;</div><div class="line">  - version: &#123;&#123; pillar[&quot;version&quot;] &#125;&#125;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
<p>当然我们并不会每次都在执行命令时附带参数,我们可以把pillar,grains的数据预先设定好.下面来看看如何引入其他变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;% set files = salt[&apos;cmd.run&apos;](&quot;ls /data&quot;,&quot;default&quot;) %&#125;</div><div class="line"></div><div class="line">echo_files_name:</div><div class="line">  cmd.run:</div><div class="line">    - names:</div><div class="line">&#123;% for file in files %&#125;</div><div class="line">      - echo &#123;&#123; file &#125;&#125;</div><div class="line">&#123;% endfor %&#125;</div></pre></td></tr></table></figure>
<ul>
<li>salt 固定写法</li>
<li>[‘cmd.run’] 表示执行cmd.run方法</li>
<li>ls /data 表示执行命令</li>
<li>“default” 最后的空字符代表默认值</li>
</ul>
<p>这种方法可以执行大部分salt命令来获取返回值,然后传入到sls文件中执行</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>有时候由于编写的sls文件太大,想测试一下刚添加进去的功能需要执行很久.</p>
<p>其实可以通过sls_id方法来执行sls文件内的某个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;minion1&apos; state.sls_id nginx_install nginx.install</div></pre></td></tr></table></figure>
<p>这时候saltstack只会执行nginx.install.sls里边的nginx_install,而不会执行其他,但是我们要注意它的依赖关系</p>
<h3 id="配置文件管理"><a href="#配置文件管理" class="headerlink" title="配置文件管理"></a>配置文件管理</h3><p>在很多时候,我们需要统一管理配置文件,但是每台机器的配置信息又不一样,我们想根据每一台机的具体配置来定义应用的配置文件</p>
<p>通过saltstack file模块管理的文件,其实也可以使用jinja来获取,定义变量的</p>
<p>下面来看一份postgres配置,由于配置过长,删减了部分<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">listen_addresses = &apos;*&apos;</div><div class="line">max_connections = &#123;&#123; conn &#125;&#125;</div><div class="line">&#123;% if ((grains.mem_total|int) / 4)|round|int &lt;= 8096 -%&#125;</div><div class="line">shared_buffers = &#123;&#123; ((grains.mem_total|int) / 4)|round|int &#125;&#125;MB</div><div class="line">&#123;% else -%&#125;</div><div class="line">shared_buffers = 4GB</div><div class="line">&#123;% endif -%&#125;</div><div class="line">work_mem = &#123;&#123; ((grains.mem_total|int) / conn * 2) |round|int &#125;&#125;MB</div><div class="line">&#123;% if ((grains.mem_total|int) / 16)|round|int &lt;= 2048 -%&#125;</div><div class="line">maintenance_work_mem = &#123;&#123; ((grains.mem_total|int) / 16)|round|int &#125;&#125;MB</div><div class="line">&#123;% else -%&#125;</div><div class="line">maintenance_work_mem = 2GB</div><div class="line">&#123;% endif -%&#125;</div><div class="line">temp_buffers = &#123;&#123; ((grains.mem_total|int) / conn) |round|int &#125;&#125;MB</div><div class="line">checkpoint_completion_target = 0.9</div><div class="line">effective_cache_size = &#123;&#123; (((grains.mem_total|int) * 3) / 4)|round|int &#125;&#125;MB</div></pre></td></tr></table></figure></p>
<p>可以看到,配置文件内大量使用了granis来读取机器的配置信息,从而动态生产配置文件,这样所有的服务器都可以共用一份配置文件.</p>

	
	</div>
  <a type="button" href="/2017/09/14/salt-sls/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-12 </div>
			<div class="article-title"><a href="/2017/09/12/salt-ssh/" >slatstack(三)salt-ssh批量安装minion</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>saltstack 对比 ansible</strong> </p>
<blockquote>
<p>最大的不同就是saltstack使用的是c/s架构,即要安装minion才能访问客户端,而ansible则是使用ssh协议访问.不得不说,有一部分人就是因为觉得saltstack需要安装客户端,感觉很麻烦而选用了ansible.那么下面来说说salt如何通过salt-ssh来安装minion</p>
</blockquote>
<h1 id="salt-ssh"><a href="#salt-ssh" class="headerlink" title="salt-ssh"></a>salt-ssh</h1><p>salt-ssh 并没有包含在salt-master中,所以需要单独安装<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install salt-ssh</div></pre></td></tr></table></figure></p>
<h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><p>salt-ssh 使用的前提条件就是roster,只有配置了roster文件后才能使用salt-ssh对机器进行操作</p>
<p>下面来看一个roster文件的配置<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">test1:</div><div class="line"> host: 192.168.1.101</div><div class="line"> user: salt</div><div class="line"> passwd: redhat</div><div class="line"> minion_opts:</div><div class="line">   - id: test1</div></pre></td></tr></table></figure></p>
<p>第1行test1: 表示该机器被salt-ssh识别到的id<br>第2-4行host: 指定机器的IP地址,用户,密码,用于ssh连接<br>第5行minion_opts: 表示执行命令时传递的参数</p>
<p><strong>如果客户端IP没有在master的known_hosts文件中,需要先添加上去</strong></p>
<p>测试连接是否成功<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt-ssh -i 'test1' test.ping</div></pre></td></tr></table></figure></p>
<h3 id="编写安装minion的sls"><a href="#编写安装minion的sls" class="headerlink" title="编写安装minion的sls"></a>编写安装minion的sls</h3><p>既然已经连接上客户端,那么只需要在客户端上装上minion并启动就好了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>同步yum的repo</div><div class="line">minion_yum:</div><div class="line">  file.recurse:</div><div class="line">    - name: /etc/yum.repos.d</div><div class="line">    - source: salt://minions/yum.repos.d ##提前准备的yum文件路径</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - file_mode: 644</div><div class="line">    - dir_mode: 755</div><div class="line">    - include_empty: True</div><div class="line">    - unless: test -e /etc/yum.repos.d/epel_aliyun.repo</div><div class="line"></div><div class="line"><span class="meta">#</span>安装minion</div><div class="line">minion_install:</div><div class="line">  pkg.installed:</div><div class="line">    - pkgs:</div><div class="line">      - salt-minion</div><div class="line">    - skip_verify: True</div><div class="line">    - require:</div><div class="line">      - file: minion_yum</div><div class="line">    - unless: rpm -qa | grep salt-minion</div><div class="line"></div><div class="line"><span class="meta">#</span>同步minion的配置文件</div><div class="line">minion_conf:</div><div class="line">  file.managed:</div><div class="line">    - name: /etc/salt/minion</div><div class="line">    - source: salt://minions/minion.conf  ##minion端需要配置的minion主配置文件</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - mode: 640</div><div class="line">    - template: jinja</div><div class="line">    - defaults:</div><div class="line">       minion_id: &#123;&#123; grains['id'] &#125;&#125;</div><div class="line">    - require:</div><div class="line">      - pkg: minion_install</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#</span>启动minion</div><div class="line">minion_service:</div><div class="line">  service.running:</div><div class="line">    - name: salt-minion</div><div class="line">    - enable: True</div><div class="line">    - require:</div><div class="line">      - file: minion_conf</div></pre></td></tr></table></figure>
<p><strong>文件需要自行准备,并放到salt root目录下</strong></p>
<p>minion的主要配置,其他可以自行修改<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">id: &#123;&#123; minion_id &#125;&#125; </div><div class="line">master: 192.168.1.100</div></pre></td></tr></table></figure></p>
<blockquote>
<p>执行完sls后,就可以到master上通过salt-key 直接添加minion进行管理</p>
</blockquote>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><ol>
<li>通过kickstart批量安装centos</li>
<li>通过Python脚本批量修改服务器IP</li>
<li>master批量插入主机信息到roster</li>
<li>salt-ssh 安装minion 进行管理</li>
</ol>
<h3 id="kickstart批量安装centos"><a href="#kickstart批量安装centos" class="headerlink" title="kickstart批量安装centos"></a>kickstart批量安装centos</h3><ol>
<li><a href="http://www.cnblogs.com/mchina/p/centos-pxe-kickstart-auto-install-os.html" target="_blank" rel="external">安装</a></li>
<li><a href="http://www.cnphp.info/quick-install-centos-6-0-with-kickstart.html" target="_blank" rel="external">配置脚本</a></li>
</ol>
<h3 id="批量插入主机信息到roster"><a href="#批量插入主机信息到roster" class="headerlink" title="批量插入主机信息到roster"></a>批量插入主机信息到roster</h3><p>为了更加方便,所以配置kickstart时,网络可以选择是dhcp模式,这样安装完系统之后就可以上网</p>
<p>master端<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> BaseHTTPRequestHandler, HTTPServer</div><div class="line"></div><div class="line">template = <span class="string">'''</span></div><div class="line"><span class="string">&#123;id&#125;:</span></div><div class="line"><span class="string">  host: &#123;ip&#125;</span></div><div class="line"><span class="string">  user: root</span></div><div class="line"><span class="string">  passwd: password</span></div><div class="line"><span class="string">  minion_opts:</span></div><div class="line"><span class="string">    - id: &#123;id&#125;</span></div><div class="line"><span class="string">'''</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestHandler</span><span class="params">(BaseHTTPRequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_POST</span><span class="params">(self)</span>:</span></div><div class="line">        response = self.rfile.read(int(self.headers[<span class="string">'content-length'</span>]))</div><div class="line">        self.send_response(<span class="number">200</span>)</div><div class="line">        self.send_header(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>)</div><div class="line">        self.end_headers()</div><div class="line">        self.data_parse(response)</div><div class="line">        self.do_insert(self.data)</div><div class="line">        result = (<span class="string">'data: %s, send OK\n'</span> % response).encode(<span class="string">'ascii'</span>)</div><div class="line">        self.wfile.write(result)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_insert</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">with</span> open(<span class="string">r'/etc/salt/roster'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(data + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data_parse</span><span class="params">(self, data)</span>:</span></div><div class="line">        print(data)</div><div class="line">        data = json.loads(data.decode(<span class="string">'utf-8'</span>))</div><div class="line">        print(data)</div><div class="line">        self.data = template.format(id=data[<span class="string">'id'</span>], ip=data[<span class="string">'ip'</span>])</div><div class="line">        print(self.data)</div><div class="line">        <span class="keyword">return</span> self.data</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    server_address = (<span class="string">''</span>, <span class="number">8099</span>)</div><div class="line">    httpd = HTTPServer(server_address, RequestHandler)</div><div class="line">    httpd.serve_forever()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure></p>
<p>minion端<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ip=`ifconfig | grep <span class="string">'inet'</span> |grep -v <span class="string">'127.0.0.1'</span>|grep -v inet6 | sed <span class="string">'s/^[ \t]*//g'</span>|cut -d<span class="string">" "</span> -f2`</div><div class="line">hostname=`hostname`</div><div class="line">data=&#123;<span class="string">"id"</span>:<span class="string">"$hostname"</span>, <span class="string">"ip"</span>:$ip&#125;</div><div class="line">curl -X POST -d <span class="string">'&#123;"id":"'</span>$hostname<span class="string">'", "ip":"'</span>$ip<span class="string">'"&#125;'</span> <span class="string">"http://127.0.0.1:8099"</span></div></pre></td></tr></table></figure></p>

	
	</div>
  <a type="button" href="/2017/09/12/salt-ssh/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="搜索" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>分类</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/django/">django</label></a></li>
		
			<li><a href="/categories/linux/">linux</label></a></li>
		
			<li><a href="/categories/python/">python</label></a></li>
		
			<li><a href="/categories/saltstack/">saltstack</label></a></li>
		
			<li><a href="/categories/sql/">sql</label></a></li>
		
		</ul>
	</div>


		
			
	<div class="widget">
		<h4>标签云</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/tags/sql/">sql</a></li>
		
			<li><a href="/tags/闭包/">闭包</a></li>
		
			<li><a href="/tags/saltstack/">saltstack</a></li>
		
			<li><a href="/tags/敏捷开发/">敏捷开发</a></li>
		
			<li><a href="/tags/异步/">异步</a></li>
		
			<li><a href="/tags/redis/">redis</a></li>
		
			<li><a href="/tags/python/">python</a></li>
		
			<li><a href="/tags/oop/">oop</a></li>
		
			<li><a href="/tags/函数/">函数</a></li>
		
			<li><a href="/tags/vim/">vim</a></li>
		
			<li><a href="/tags/代码优化/">代码优化</a></li>
		
			<li><a href="/tags/gc/">gc</a></li>
		
			<li><a href="/tags/ELK/">ELK</a></li>
		
			<li><a href="/tags/decorator/">decorator</a></li>
		
			<li><a href="/tags/rocketmq/">rocketmq</a></li>
		
			<li><a href="/tags/django/">django</a></li>
		
			<li><a href="/tags/uwsgi/">uwsgi</a></li>
		
			<li><a href="/tags/jinja/">jinja</a></li>
		
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>最新文章</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2018/03/14/junior-sql/" ><i class="fa fa-file-o"></i>sql简单语法</a>
      </li>
    
      <li>
        <a href="/2018/03/13/super/" ><i class="fa fa-file-o"></i>python之super</a>
      </li>
    
      <li>
        <a href="/2018/03/12/new-style-class-and-classic-class/" ><i class="fa fa-file-o"></i>python之新式类与旧式类</a>
      </li>
    
      <li>
        <a href="/2017/12/24/agile/" ><i class="fa fa-file-o"></i>初涉敏捷开发</a>
      </li>
    
      <li>
        <a href="/2017/11/15/ELK/" ><i class="fa fa-file-o"></i>ELK搭建</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>链接</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/DearEirs" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->


	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2018 Dear
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 




   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- syntax highlighting -->


</body>
   </html>
