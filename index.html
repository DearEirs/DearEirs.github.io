<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Dear&#39;s Blog</title>

  <meta name="author" content="Dear">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="renderer" content="webkit">

  
  <meta property="og:site_name" content="Dear&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
  

  <!-- CSS -->
  <!-- link rel="stylesheet" href="/css/themes/bootstrap.css" media="screen" type="text/css" -->
  <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight-default.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]>
  <![endif]-->

</script>
  <script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>
  
  <!-- analytics -->
  



  <meta name="baidu-site-verification" content="RXfcpfczu8" />
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Dear&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>目录
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>分类
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>标签
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>关于个人
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Welcome to Dear&#39;s Blog
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
        <!-- render top articles firstly -->
        
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
            
		
        
        <!-- render other articles -->
        
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-06-21 </div>
			<div class="article-title"><a href="/2018/06/21/cgi/" >cgi</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<p><img src="https://raw.githubusercontent.com/DearEirs/static/master/images/web.png" alt="image"></p>
<p>在处理一个页面请求时我们一般会需要用到一下信息:</p>
<ol>
<li>请求头, 请求头里边包含了很多的信息如COOKIE、URI等. 可以协助我们处理请求</li>
<li>提交的参数, 用户通过GET/POST请求提交上来的参数.</li>
<li>根据1-2的输入, 进行自定义的处理过程</li>
<li>输出html页面, 或json数据(API接口)</li>
</ol>
<p>如何获取请求头的信息<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 这是返回给客户端的请求头</span></div><div class="line">print(<span class="string">"Content-type: textml\n\n"</span>)</div><div class="line">print(os.environ)</div></pre></td></tr></table></figure></p>
<p>在输出界面我们就可以看到我们所提交过去的各种信息.</p>
<p>GET/POST的请求参数, GET的请求参数我们可以通过os.environ里的QUERY_STRING看到. 而事实上我们还可以通过CGI模块来获取</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> cgi</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 创建 FieldStorage 的实例化</span></div><div class="line">form = cgi.FieldStorage()</div><div class="line">username = form.getvalue(<span class="string">'username'</span>, default=<span class="keyword">None</span>)</div><div class="line">password = form.getvalue(<span class="string">'password'</span>, default=<span class="keyword">None</span>)</div><div class="line"></div><div class="line">print(<span class="string">"Content-type: textml\n\n"</span>)</div><div class="line">print(<span class="string">"Your username is %s, password is %s"</span>% (username, password))</div></pre></td></tr></table></figure>
<blockquote>
<p>无论是通过GET还是POST提交的参数, 都可以通过getvalue获取.</p>
</blockquote>
<p>cgi是通过stdin, stdout来传递数据的.要让可执行文件的输出不止于helloworld, 那么就需要把特定的信息输出到stdout从而输出至客户端. 对于REST风格的API而言, 可以使用json.dumps来生成返回数据. 而如果是作为网页形式, 需要返回整个html, 那么我们将需要输出html的dom、css、javascript, 要我们一行一行把这些东西给输出到stdout是非常麻烦的.  这时我们就可以通过模板语言来构建html.</p>
<p>因为CGI会直接启动一个进程来执行脚本, 那么我们就需要注意一个安全性的问题. 执行脚本的用户应该尽量少拥有无关的权限. 以防被恶意用户利用.</p>

	
	</div>
  <a type="button" href="/2018/06/21/cgi/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-06-21 </div>
			<div class="article-title"><a href="/2018/06/21/cache/" >cache</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="缓存常见问题"><a href="#缓存常见问题" class="headerlink" title="缓存常见问题"></a>缓存常见问题</h1><ul>
<li>缓存雪崩</li>
<li>缓存穿透</li>
<li>缓存占用过多内存</li>
</ul>
<h3 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h3><p>缓存雪崩指的是在某一个时间点里边, 有大量的Key过期, 然后引起大量请求同时访问到数据库<br>针对这个问题, 我们可以把Key的过期时间随机化或等差划分, 反正就是要消除掉大量缓存同时失效的情况.</p>
<h3 id="缓存穿透"><a href="#缓存穿透" class="headerlink" title="缓存穿透"></a>缓存穿透</h3><p>缓存穿透指的是访问到了缓存当中不存在的数据, 在缓存里边拿不到数据就会从数据库里边取, 如果并发数量大, 也会造成大量请求直接访问到数据库的现象</p>
<ol>
<li>如果请求访问的都是同一条缓存数据, 可以设置访问互斥锁, 只允许第一个请求访问数据库, 其他请求则添加到队列, 等第一个请求从数据库里拿到数据并更新缓存后, 队列里的请求直接访问缓存数据</li>
<li>如果请求访问的都是不同的数据, 且当数据库里查询不到数据后并不会更新缓存, 那么可以往缓存里边设置空对象, 简单直接, 碰到查询结果为空的键, 放一个空值在缓存中, 次再访问就立刻知道这个键无效, 而不会再次访问数据库</li>
</ol>
<h3 id="缓存占用过多内存"><a href="#缓存占用过多内存" class="headerlink" title="缓存占用过多内存"></a>缓存占用过多内存</h3><p>查看redis里各Key占用内存</p>

	
	</div>
  <a type="button" href="/2018/06/21/cache/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-06-21 </div>
			<div class="article-title"><a href="/2018/06/21/http/" >http</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="HTTP协议"><a href="#HTTP协议" class="headerlink" title="HTTP协议"></a>HTTP协议</h1><p>HTTP是一个应用层协议, 由请求和响应构成, 是一个标准的客户端服务器模型. 基于HTTP协议的CS模式的信息交换过程, 它分四个过程: 建立连接、发送请求信息、发送响应信息、关闭连接. 如图</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">sequenceDiagram</div><div class="line">A-&gt;&gt;B: 建立TCP连接</div><div class="line">A-&gt;&gt;B: 发起请求</div><div class="line">B-&gt;&gt;A: 响应请求</div><div class="line">B-&gt;&gt;A: 断开TCP连接</div></pre></td></tr></table></figure>
<p>我们可以看到, 每处理一个请求都需要建立与断开TCP连接, 我们称这样的连接为非持久连接.</p>
<p>http1.0里就是使用这样的方式来处理连接 在并发量不大的情况下这并不会影响到我们的使用, 但是如果并发量大, 那么服务器将需要消耗一部分的资源来专门干这事. </p>
<p>所以为了解决这个问题, http1.1里引用了持久连接, 而且默认使用的就是持久连接, 与非持久连接不同的是持久连接允许个连接中可以传输多个对象.<br>当然在http1.1里还是可以通过设置来使用非持久连接的.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">sequenceDiagram</div><div class="line">A-&gt;&gt;B: 建立TCP连接</div><div class="line">A-&gt;&gt;B: 发起请求1</div><div class="line">B-&gt;&gt;A: 响应请求1</div><div class="line">A-&gt;&gt;B: 发起请求2</div><div class="line">B-&gt;&gt;A: 响应请求2</div><div class="line">A-&gt;&gt;B: 发起请求n</div><div class="line">B-&gt;&gt;A: 响应请求n</div><div class="line">B-&gt;&gt;A: 断开TCP连接</div></pre></td></tr></table></figure>
<p>我们可以通过设置keep-alive参数来设置持久连接的相关参数, 如timeout</p>
<p>而在这个请求模式中还有一个问题就是只有当客户端发起请求时, 服务端才能向客户端发送/返回数据. 且当请求1被阻塞的时候, 必须等待服务器处理完成请求后才能发起后续请求, 这也是http的缺点之一. </p>
<p>目前服务器所使用的都是占比比较大的是http1.1版本, 它有如下缺点:</p>
<p>安全性问题:</p>
<ul>
<li>基于明文文本的通信内容可能被窃听</li>
<li>不验证通信双方的身份可能遭伪装</li>
<li>无法证明报文完整性可能遭篡改</li>
</ul>
<p>性能问题:</p>
<ul>
<li>一条连接上只可发一个请求(非持久连接)</li>
<li>队头阻塞</li>
<li>请求只能由客户端发起，客户端不可接受响应之外的指令</li>
<li>请求和响应的首部未经压缩就发送，首部信息越多延迟越大</li>
<li>发送冗长的首部，多次来回之间首部大部分字段都未改变，浪费资源</li>
<li>可选择任意压缩格式，不强制压缩后发送</li>
</ul>
<p>针对这些问题, 新版本的http(HTTP2.0)引入了</p>
<h3 id="http的请求"><a href="#http的请求" class="headerlink" title="http的请求"></a>http的请求</h3><p>我们想要对一个网络上的资源发起访问, 首先要知道它所在的位置. 对此我们用一个URL来指定所需要访问的资源路径. </p>
<p><a href="http://www.baidu.com:80/s?wd=http" target="_blank" rel="external">http://www.baidu.com:80/s?wd=http</a></p>
<p>这是一个普通的URL, http指定了所使用的协议, 除http外还有https、ftp等协议. </p>
<p>而www.baidu.com 这指定了我们所需要访问的服务器, 当然需要得到服务器的IP我们还需要通过DNS来解析.</p>
<p>80 代表了我们需要访问这台服务器的80端口, 当需要指定端口时前边要加”:”.而当我们没指定任何端口时会自动访问80端口, 而采用https协议的话则默认访问443端口  </p>
<p>/s 代表了资源所在服务器的路径. </p>
<p>?wd=http 相当于请求附带的query.</p>
<p>我们只需要把请求报文发送到指定的URL, 服务器就应该会把我们所需要的资源响应回来. </p>
<h3 id="http请求报文格式"><a href="#http请求报文格式" class="headerlink" title="http请求报文格式"></a>http请求报文格式</h3><p><img src="https://images2018.cnblogs.com/blog/1361655/201804/1361655-20180413120416720-1194570336.png" alt="image"><br>可以看到请求报文由请求行、请求头部、空行和请求数据4部分组成.<br>其中请求行包括请求方法, 所请求的资源的地址与使用的http版本. </p>
<p>请求头部中的内容一般用来描述客户端能兼容的类型.</p>
<p>请求数据则是需要提供给服务端处理的数据</p>
<h3 id="http响应报文格式"><a href="#http响应报文格式" class="headerlink" title="http响应报文格式"></a>http响应报文格式</h3><p><img src="https://camo.githubusercontent.com/7b4bafaefaa8241c599f1a0166dbd003cb8539a2/68747470733a2f2f692e696d6775722e636f6d2f723156723962412e706e67" alt="image"></p>
<p>这是一个响应报文示例, 可以看到响应报文也分为4个组成部分, 分别为状态行, 响应头部, 空行, 响应的消息</p>
<p>其中状态行包含了http的版本与一个状态码,<br>状态码由一个三位数组成，状态码大体有5种含义：</p>
<ul>
<li>1xx 信息, 请求已被服务端收到, 请继续.</li>
<li>2xx 成功. 请求已被服务端接收, 并处理完毕</li>
<li>3xx 重定向. 需要进一步的操作才能完成此请求</li>
<li>4xx 客户端错误. 请求含有词法错误, 或者无法被执行</li>
<li>5xx 服务器错误. 服务端在处理请求的过程中出现错误</li>
</ul>
<p>其中1xx 是在http1.1版本才加进去的, http1.0并没有. </p>
<p>而处理http已经规定好的状态码外, 我们还可以自行规定自己所需要的状态码. 只需使用双方都明确知道此状态码的含义即可. </p>
<h3 id="请求方法"><a href="#请求方法" class="headerlink" title="请求方法"></a>请求方法</h3><p>请求方法, 一般称为method, 每个method都表示对url所指定的资源执行一种不同的操作. 客户端通过指定method来告知服务端如何处理该资源.</p>
<ul>
<li>GET: 服务端只检索既有资源返回给客户端, 不应有其他副作用.</li>
<li>POST: 客户端将新建资源所需的数据携带在请求中, 使服务端创建一个新资源.</li>
<li>PUT: 客户端提供完整的资源信息给服务端, 服务端据此更新既有资源或创建新资源.</li>
<li>DELETE: 服务端删除指定的资源.</li>
<li>PATCH: 客户端提供指定资源的部分信息, 服务端据此对既有资源做局部更新.</li>
<li>HEAD: 服务端构造与GET方法一模一样的响应头部返回给客户端, 便于客户端获取该资源的元信息, 而非整体传输。常用于检查资源是否已改动.</li>
<li>TRACE: 返回客户端请求经由哪些跃点到达了服务端, 中间代理或网关在转发该请求时应将自己的IP或DNS名称添加到头部的Via字段中. 常用于诊断.</li>
<li>OPTIONS: 服务端返回该URL支持的请求方法. 通常请求’*’, 而非具体资源.</li>
</ul>
<p>而我们平时用的比较多的就是GET、POST、PUT、DELETE、HEAD. </p>

	
	</div>
  <a type="button" href="/2018/06/21/http/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-05-10 </div>
			<div class="article-title"><a href="/2018/05/10/flask/" >flask源码--处理过程</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="Flask"><a href="#Flask" class="headerlink" title="Flask"></a>Flask</h1><h3 id="Flask是什么"><a href="#Flask是什么" class="headerlink" title="Flask是什么?"></a>Flask是什么?</h3><p>Flask是一个使用 Python 编写的轻量级 Web 应用框架, 让我们可以使用Python语言快速搭建Web服务, Flask也被称为 “microframework” ，因为它使用简单的核心, 用 extension 增加其他功能</p>
<h3 id="为什么选择Flask"><a href="#为什么选择Flask" class="headerlink" title="为什么选择Flask?"></a>为什么选择Flask?</h3><p>我们先来看看python现在比较流行的web框架</p>
<ul>
<li>Flask</li>
<li>Django</li>
<li>Tornado</li>
<li>Sanic</li>
</ul>
<p>Flask: 轻, 组件间松耦合, 自由、灵活，可扩展性强，第三方库的选择面广的同时也增加了组件间兼容问题</p>
<p>Django: Django相当于一个全家桶, 几乎包括了所有web开发用到的模块(session管理、CSRF防伪造请求、Form表单处理、ORM数据库对象化、模板语言), 但是相对应的会造成一个紧耦合的情况, 对第三方插件不太友好</p>
<p>Tornado: 底层通过eventloop来实现异步处理请求, 处理效率高, 学习难度大, 处理稍有不慎很容易阻塞主进程导致不能正常提供服务, 新版本也支持asyncio</p>
<p>Sanic: 一个类Flask框架, 但是底层使用uvloop进行异步处理, 可以使用同步的方式编写异步代码, 而且运行效率十分高效. </p>
<h3 id="WSGI"><a href="#WSGI" class="headerlink" title="WSGI"></a>WSGI</h3><p>先来看看维基百科对WSGI的定义</p>
<p>Web服务器<strong>网关</strong>接口（Python Web Server Gateway Interface，缩写为WSGI）是为Python语言定义的Web服务器和Web应用程序或框架之间的一种简单而通用的接口.</p>
<p>何为网关, 即从客户端发出的每个请求(数据包)第一个到达的地方, 然后再根据路由进行转发处理. 而对于服务端发送过来的消息, 总是先通过网关层, 然后再转发至客户端</p>
<blockquote>
<p>那么可想而知, WSGI其实是作为一个网关接口, 来接受Server传递过来的信息,  然后通过这个接口调用后台app里的view function进行响应.</p>
</blockquote>
<p>先看一段有趣的对话:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">Nginx：Hey, WSGI, 我刚收到了一个请求，我需要你作些准备, 然后由Flask来处理这个请求. </div><div class="line">WSGI：OK, Nginx. 我会设置好环境变量, 然后将这个请求传递给Flask处理.</div><div class="line">Flask：Thanks. WSGI给我一些时间，我将会把请求的响应返回给你. </div><div class="line">WSGI：Alright, 那我等你. </div><div class="line">Flask：Okay, 我完成了, 这里是请求的响应结果, 请求把结果传递给Nginx.</div><div class="line">WSGI：Good job! Nginx, 这里是响应结果, 已经按照要求给你传递回来了. </div><div class="line">Nginx：Cool, 我收到了, 我把响应结果返回给客户端.大家合作愉快~</div></pre></td></tr></table></figure></p>
<p>对话里面可以清晰了解到WSGI、nginx、Flask三者的关系</p>
<p>下面来看看Flask中的wsgi接口(注意:每个进入Flask的请求都会调用Flask.__call__)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 摘自Flask源码 app.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></div><div class="line">    <span class="comment"># 中间省略</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__call__</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.wsgi_app(environ, start_response)</div><div class="line">            </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wsgi_app</span><span class="params">(self, environ, start_response)</span>:</span></div><div class="line">        <span class="comment"># environ: 一个包含全部HTTP请求信息的字典, 由WSGI Server解包HTTP请求生成</span></div><div class="line">        <span class="comment"># start_response: WSGI Server提供的函数, 调用可以发送响应的状态码和HTTP报文头,</span></div><div class="line">        <span class="comment"># 函数在返回前必须调用一次.</span></div><div class="line">        :param environ: A WSGI environment.</div><div class="line">        :param start_response: A callable accepting a status code,</div><div class="line">            a list of headers, <span class="keyword">and</span> an optional exception context to</div><div class="line">            start the response.</div><div class="line">        <span class="comment"># 创建上下文</span></div><div class="line">        ctx = self.request_context(environ)</div><div class="line">        error = <span class="keyword">None</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                <span class="comment"># 把上下文压栈</span></div><div class="line">                ctx.push()</div><div class="line">                <span class="comment"># 分发请求</span></div><div class="line">                response = self.full_dispatch_request()</div><div class="line">            <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">                error = e</div><div class="line">                response = self.handle_exception(e)</div><div class="line">            <span class="keyword">except</span>:</div><div class="line">                error = sys.exc_info()[<span class="number">1</span>]</div><div class="line">                <span class="keyword">raise</span></div><div class="line">            <span class="comment"># 返回结果</span></div><div class="line">            <span class="keyword">return</span> response(environ, start_response)</div><div class="line">        <span class="keyword">finally</span>:</div><div class="line">            <span class="keyword">if</span> self.should_ignore_error(error):</div><div class="line">                error = <span class="keyword">None</span></div><div class="line">                <span class="comment"># 上下文出栈</span></div><div class="line">                ctx.auto_pop(error)</div></pre></td></tr></table></figure>
<p>wsgi_app中定义的就是Flask处理一个请求的基本流程,</p>
<ol>
<li>创建上下文</li>
<li>把上下文入栈</li>
<li>分发请求</li>
<li>上下文出栈</li>
<li>返回结果</li>
</ol>
<p>其中response = self.full_dispatch_request()请求分发的过程我们需要关注一下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 摘自Flask源码 app.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></div><div class="line">    <span class="comment"># 中间省略</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">full_dispatch_request</span><span class="params">(self)</span>:</span></div><div class="line">        self.try_trigger_before_first_request_functions()</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            request_started.send(self)</div><div class="line">            rv = self.preprocess_request()</div><div class="line">            <span class="keyword">if</span> rv <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">                rv = self.dispatch_request()</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">            rv = self.handle_user_exception(e)</div><div class="line">        <span class="keyword">return</span> self.finalize_request(rv)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch_request</span><span class="params">(self)</span>:</span></div><div class="line">        req = _request_ctx_stack.top.request</div><div class="line">        <span class="keyword">if</span> req.routing_exception <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            self.raise_routing_exception(req)</div><div class="line">        rule = req.url_rule</div><div class="line">        <span class="keyword">if</span> getattr(rule, <span class="string">'provide_automatic_options'</span>, <span class="keyword">False</span>) \</div><div class="line">           <span class="keyword">and</span> req.method == <span class="string">'OPTIONS'</span>:</div><div class="line">            <span class="keyword">return</span> self.make_default_options_response()</div><div class="line">        <span class="keyword">return</span> self.view_functions[rule.endpoint](**req.view_args)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">finalize_request</span><span class="params">(self, rv, from_error_handler=False)</span>:</span></div><div class="line">        response = self.make_response(rv)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            response = self.process_response(response)</div><div class="line">            request_finished.send(self, response=response)</div><div class="line">        <span class="keyword">except</span> Exception:</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> from_error_handler:</div><div class="line">                <span class="keyword">raise</span></div><div class="line">            self.logger.exception(<span class="string">'Request finalizing failed with an '</span></div><div class="line">                                  <span class="string">'error while handling an error'</span>)</div><div class="line">        <span class="keyword">return</span> response</div></pre></td></tr></table></figure>
<p>我们可以看到, 请求分发的操作其实是由dispatch_request来完成的, 而在请求进行分发的前后我们可以看到Flask进行了如下操作:</p>
<ol>
<li>try_trigger_before_first_request_functions, 首次处理请求前的操作,通过@before_first_request定义,可以进行数据库连接</li>
<li>preprocess_request, 每次处理请求前进行的操作, 通过@before_request来定义, 可以拦截请求</li>
<li>process_response, 每次正常处理请求后进行的操作, 通过@after_request来定义, 可以统计接口访问成功的数量</li>
<li>finalize_request, 把视图函数的返回值转换成一个真正的响应对象</li>
</ol>
<p>以上的这些是Flask提供给我们使用的钩子(hook), 可以根据自身需求来定义,<br>而hook中还有@teardown_request, 是在每次处理请求后执行(无论是否有异常), 所以它是在上下文出栈的时候被调用</p>
<p>如果同时定义了四种钩子(hook), 那么执行顺序应该是  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">graph LR</div><div class="line">before_first_request --&gt; before_request</div><div class="line">before_request --&gt; after_request</div><div class="line">after_request --&gt; teardown_request</div></pre></td></tr></table></figure>
<blockquote>
<p>在请求函数和钩子函数之间，一般通过全局变量g实现数据共享</p>
</blockquote>
<p>现在的处理流程就变为:</p>
<ol>
<li>创建上下文</li>
<li>上下文入栈</li>
<li>执行before_first_request操作(如果是第一次处理请求)</li>
<li>执行before_request操作</li>
<li>分发请求</li>
<li>执行after_request操作</li>
<li>执行teardown_request操作</li>
<li>上下文出栈</li>
<li>返回结果</li>
</ol>
<p>其中3-7就是需要我们完成的部分.</p>
<h3 id="如何使用Flask"><a href="#如何使用Flask" class="headerlink" title="如何使用Flask"></a>如何使用Flask</h3><p>上面我们知道, Flask处理请求的步骤, 那么我们来试试<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask</div><div class="line">app = Flask(__name__)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.before_first_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_first_request</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'before_first_request run'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.before_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_request</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">'before_request run'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.after_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">after_request</span><span class="params">(param)</span>:</span></div><div class="line">    print(<span class="string">'after_request run'</span>)</div><div class="line">    <span class="keyword">return</span> param</div><div class="line"></div><div class="line"><span class="meta">@app.teardown_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">teardown_request</span><span class="params">(param)</span>:</span></div><div class="line">    print(<span class="string">'teardown_request run'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello_world</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'Hello World!'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    app.run()</div></pre></td></tr></table></figure></p>
<p>当运行flask进程时, 访问127.0.0.1:5000, 程序输出, 正好认证了我们之前说的执行顺序.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">before_first_request run</div><div class="line">before_request run</div><div class="line">after_request run</div><div class="line">teardown_request run</div><div class="line">127.0.0.1 - - [03/May/2018 18:42:52] &quot;GET / HTTP/1.1&quot; 200 -</div></pre></td></tr></table></figure></p>
<h3 id="路由分发"><a href="#路由分发" class="headerlink" title="路由分发"></a>路由分发</h3><p>看了上面的代码, 我们可能还是会有疑问, 为什么我们的请求就会跑到hello world 函数去处理呢？我们先来普及几个知识点:</p>
<ul>
<li>url: 客户端访问的网址</li>
<li>view_func: 即我们写的视图函数</li>
<li>rule: 定义的匹配路由的地址</li>
<li>url_map: 存放着rule与endpoint的映射关系</li>
<li>endpoint: 可以看作为每个view_func的ID</li>
<li>view_functions: 一个字典, 以endpoint为key, view_func 为value</li>
</ul>
<p>添加路由的方法:</p>
<ol>
<li>@app.route</li>
<li>add_url_rule</li>
</ol>
<p>我们先来看看@app.route干了什么事情<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 摘自Flask源码 app.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></div><div class="line">    <span class="comment"># 中间省略</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route</span><span class="params">(self, rule, **options)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(f)</span>:</span></div><div class="line">            endpoint = options.pop(<span class="string">'endpoint'</span>, <span class="keyword">None</span>)</div><div class="line">            self.add_url_rule(rule, endpoint, f, **options)</div><div class="line">            <span class="keyword">return</span> f</div><div class="line">        <span class="keyword">return</span> decorator</div></pre></td></tr></table></figure></p>
<p>我们可以看到, route函数是一个装饰器, 它在执行时会先获取endpoint, 然后再通过调用add_url_rule来添加路由, 也就是说所有添加路由的操作其实都是通过add_url_rule来完成的. 下面我们再来看看add_url_rule.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 摘自Flask源码 app.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Flask</span><span class="params">(_PackageBoundObject)</span>:</span></div><div class="line">    <span class="comment"># 中间省略</span></div><div class="line">    <span class="comment"># 定义view_functions</span></div><div class="line">    self.view_functions = &#123;&#125;</div><div class="line">    <span class="comment"># 定义url_map</span></div><div class="line">    self.url_map = Map()</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_url_rule</span><span class="params">(self, rule, endpoint=None, view_func=None,</span></span></div><div class="line"><span class="function"><span class="params">                     provide_automatic_options=None, **options)</span>:</span></div><div class="line">        <span class="comment"># 创建rule</span></div><div class="line">        rule = self.url_rule_class(rule, methods=methods, **options)</div><div class="line">        rule.provide_automatic_options = provide_automatic_options</div><div class="line">        <span class="comment"># 把rule添加到url_map</span></div><div class="line">        self.url_map.add(rule)</div><div class="line">        <span class="keyword">if</span> view_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            old_func = self.view_functions.get(endpoint)</div><div class="line">            <span class="keyword">if</span> old_func <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> old_func != view_func:</div><div class="line">                <span class="keyword">raise</span> AssertionError(<span class="string">'View function mapping is overwriting an '</span></div><div class="line">                                     <span class="string">'existing endpoint function: %s'</span> % endpoint)</div><div class="line">            <span class="comment"># 把view_func 添加到view_functions字典</span></div><div class="line">            self.view_functions[endpoint] = view_func</div></pre></td></tr></table></figure>
<p>可以看到, 当我们添加路由时, 会生成一个rule, 并把它存放到url_map里头, 然后把view_func与其对应的endpoint存到字典.</p>
<p>当一个请求进入时, Flask会先根据用户访问的Url到url_map里边根据rule来获取到endpoint, 然后再利用view_functions获取endpoint在里边所对应的视图函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">graph LR</div><div class="line">url1 --&gt;url_map</div><div class="line">url2 --&gt;url_map</div><div class="line">url3 --&gt;url_map</div><div class="line">urln --&gt;url_map</div><div class="line">url_map --&gt; endpoint</div><div class="line">endpoint --&gt; view_functions</div></pre></td></tr></table></figure>
<h3 id="上下文管理"><a href="#上下文管理" class="headerlink" title="上下文管理"></a>上下文管理</h3><p>下面我们再来看看之前一直忽略的上下文,什么是上下文呢?</p>
<p>上下文即语境、语意,是一句话中的语境，也就是语言环境. 一句莫名其妙的话出现会让人不理解什么意思, 如果有语言环境的说明, 则会更好, 这就是语境对语意的影响. 而对应到程序里往往就是程序中需要共享的信息，保存着程序运行或交互中需要保持或传递的信息.</p>
<p>Flask中有两种上下文分别为:应用上下文(AppContext)和请求上下文(RequestContext). 按照上面提到的我们很容易就联想到:应用上下文就是保存着应用运行或交互中需要保持或传递的信息, 如当前应用的应用名, 当前应用注册了什么路由, 又有什么视图函数等. 而请求上下文就保存着处理请求过程中需要保持或传递的信息, 如这次请求的url是什么, 参数又是什么, 请求的method又是什么等.</p>
<p>我们只需要在需要用到这些信息的时候把它从上下文中取出来即可. 而上下文是有生命周期的, 不是所有时候都能获取到.</p>
<p>上下文生命周期:</p>
<ul>
<li>RequestContext: 生命周期在处理一次请求期间, 请求处理完成后生命周期也就结束了.</li>
<li>AppContext: 生命周期最长, 只要当前应用还在运行, 就一直存在. (应用未运行前并不存在)</li>
</ul>
<p>那么上下文是在什么时候创建的呢？我们又要如何创建上下文: 刚才我们提到, 在wsgi_app处理请求的时候就会先创建上下文, 那个上下文其实是请求上下文, 那应用上下文呢？ </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 摘自Flask源码 ctx.py</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestContext</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="comment"># 中间省略</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">push</span><span class="params">(self)</span>:</span></div><div class="line">        top = _request_ctx_stack.top</div><div class="line">        <span class="keyword">if</span> top <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span> <span class="keyword">and</span> top.preserved:</div><div class="line">            top.pop(top._preserved_exc)</div><div class="line">        <span class="comment"># 获取应用上下文</span></div><div class="line">        app_ctx = _app_ctx_stack.top</div><div class="line">        <span class="comment"># 判断应用上下文是否存在并与当前应用一致</span></div><div class="line">        <span class="keyword">if</span> app_ctx <span class="keyword">is</span> <span class="keyword">None</span> <span class="keyword">or</span> app_ctx.app != self.app:</div><div class="line">            <span class="comment"># 创建应用上下文并入栈</span></div><div class="line">            app_ctx = self.app.app_context()</div><div class="line">            app_ctx.push()</div><div class="line">            self._implicit_app_ctx_stack.append(app_ctx)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._implicit_app_ctx_stack.append(<span class="keyword">None</span>)</div><div class="line"></div><div class="line">        <span class="keyword">if</span> hasattr(sys, <span class="string">'exc_clear'</span>):</div><div class="line">            sys.exc_clear()</div><div class="line">        <span class="comment"># 把请求上下文入栈</span></div><div class="line">        _request_ctx_stack.push(self)</div></pre></td></tr></table></figure>
<p>我们知道当有请求进入时, Flask会自动帮我们来创建请求上下文. 而通过上述代码我们可以看到,在创建请求上下文时会有一个判断操作, 如果应用上下文为空或与当前应用不匹配, 那么会重新创建一个应用上下文.  所以说一般情况下并不需要我们手动去创建, 当然如果需要, 你也可以显式调用app_context与request_context来创建应用上下文与请求上下文.</p>
<p>那么我们应该如何使用上下文呢？</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> flask <span class="keyword">import</span> Flask, request, g, current_app</div><div class="line"></div><div class="line"></div><div class="line">app = Flask(__name__)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.before_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">before_request</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'before_request run'</span></div><div class="line">    g.name=<span class="string">"Tom"</span></div><div class="line">    </div><div class="line">    </div><div class="line"><span class="meta">@app.after_request</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">after_request</span><span class="params">(response)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">'after_request run'</span></div><div class="line">    print(g.name)</div><div class="line">    <span class="keyword">return</span> response</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.route('/')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">()</span>:</span></div><div class="line">    print(request.url)</div><div class="line">    g.name = <span class="string">'Cat'</span></div><div class="line">    print(current_app.name)</div><div class="line">    </div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    app.run()</div></pre></td></tr></table></figure>
<p>访问127.0.0.1:5000时程序输出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">before_request run</div><div class="line">http://127.0.0.1:5000/</div><div class="line">flask_run</div><div class="line">after_request run</div><div class="line">Cat</div><div class="line">127.0.0.1 - - [04/May/2018 18:05:13] &quot;GET / HTTP/1.1&quot; 200 -</div></pre></td></tr></table></figure>
<p>代码里边应用到的current_app和g都属于应用上下文对象, 而request就是请求上下文.</p>
<ul>
<li>current_app 表示当前运行程序文件的程序实例</li>
<li>g: 处理请求时用作临时存储的对象.  每次请求都会重设这个变量 生命周期同RequestContext</li>
<li>request 代表的是当前的请求</li>
</ul>
<p>那么随之而来的问题是: 这些上下文的作用域是什么?</p>
<p>线程有个叫做ThreadLocal的类，也就是通常实现线程隔离的类. 而werkzeug自己实现了它的线程隔离类: werkzeug.local.Local. 而LocalStack就是用Local实现的.</p>
<p>这个我们可以通过globals.py可以看到<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 摘自Flask源码 globals.py</span></div><div class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</div><div class="line"><span class="keyword">from</span> werkzeug.local <span class="keyword">import</span> LocalStack, LocalProxy</div><div class="line"></div><div class="line"></div><div class="line">_request_ctx_stack = LocalStack()</div><div class="line">_app_ctx_stack = LocalStack()</div><div class="line">current_app = LocalProxy(_find_app)</div><div class="line">request = LocalProxy(partial(_lookup_req_object, <span class="string">'request'</span>))</div><div class="line">session = LocalProxy(partial(_lookup_req_object, <span class="string">'session'</span>))</div><div class="line">g = LocalProxy(partial(_lookup_app_object, <span class="string">'g'</span>))</div></pre></td></tr></table></figure></p>
<p>_lookup_app_object思就是说, 对于不同的线程, 它们访问这两个对象看到的结果是不一样的、完全隔离的. Flask通过这样的方式来隔离每个请求.</p>

	
	</div>
  <a type="button" href="/2018/05/10/flask/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-04-25 </div>
			<div class="article-title"><a href="/2018/04/25/redis-use/" >redis常用命令</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="Redis"><a href="#Redis" class="headerlink" title="Redis"></a>Redis</h1><p>Redis支持五种数据类型：</p>
<ul>
<li>string(字符串)</li>
<li>hash(哈希)</li>
<li>list(列表)</li>
<li>set(集合)</li>
<li>zset(有序集合)</li>
</ul>
<h3 id="String"><a href="#String" class="headerlink" title="String"></a>String</h3><blockquote>
<p>string是redis最基本的类型，你可以理解成与Memcached一模一样的类型，一个key对应一个value。string类型是二进制安全的。意思是redis的string可以包含任何数据。比如jpg图片或者序列化的对象 。string类型是Redis最基本的数据类型，一个键最大能存储512MB。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"># 添加或重新设置一个key</div><div class="line">set key value</div><div class="line"># 删除key</div><div class="line">del key</div><div class="line"># 修改key的名字</div><div class="line">rename oldkey newkey</div><div class="line"># 如果key已经存在并且是一个字符串， APPEND 命令会将value追加到key原来的值的末尾</div><div class="line">append key</div><div class="line"># 获取key的值</div><div class="line">get key</div><div class="line"># 获取多个key的值</div><div class="line">mget key1 key2</div><div class="line"># 设置多个key</div><div class="line">mset key1 value1 key2 value2</div><div class="line"># 设置key, 并设置过期时间(单位秒)</div><div class="line">setex key seconds value</div><div class="line"># 创建key(仅当key不存在时)</div><div class="line">setex key value</div><div class="line"># 将 key 中储存的数字值加一</div><div class="line">incr key</div><div class="line"># 将 key 所储存的值加上给定的增量值</div><div class="line">incrby key increment</div><div class="line"># 将 key 中储存的数字值减一</div><div class="line">decr key</div><div class="line"># 将 key 所储存的值减去给定的增量值</div><div class="line">decr key decrement</div><div class="line"># 获取key的值的长度</div><div class="line">strlen key</div><div class="line"># 查看key是否存在</div><div class="line">exists key</div><div class="line"># 设置key的过期时间</div><div class="line">ttl key</div><div class="line"># 查看key的过期时间</div><div class="line">pttl key</div><div class="line"># 移除key的过期时间, 没有过期时间即永久保存</div><div class="line">persist key</div></pre></td></tr></table></figure>
<h3 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h3><blockquote>
<p>Redis hash 是一个键值(key=&gt;value)对集合。Redis hash是一个string类型的field和value的映射表，hash特别适合用于存储对象。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># 获取存储在表中指定字段的值</div><div class="line">hget key field</div><div class="line"># 删除key的一个或多个字段</div><div class="line">hdel key field1 field2</div><div class="line"># 获取所有给定字段的值</div><div class="line">hmget key field1 field2</div><div class="line"># 同时将多个 field-value (域-值)对设置到表 中</div><div class="line">hmset key field1 value1 field2 value2</div><div class="line"># 只有在字段 field 不存在时，设置表字段的值</div><div class="line">hsetnx key field value</div><div class="line"># 查看表中字段是否存在</div><div class="line">hexists key field</div><div class="line"># 获取表所有字段与值</div><div class="line">hgetall key</div><div class="line"># 获取表中的字段</div><div class="line">hkeys key </div><div class="line"># 获取表中所有值</div><div class="line">hvals key</div><div class="line"># 获取表中字段的数量</div><div class="line">hlen key </div><div class="line"># 为表中指定字段的整数值加上增量 increment</div><div class="line">HINCRBY key field increment</div></pre></td></tr></table></figure>
<h3 id="List"><a href="#List" class="headerlink" title="List"></a>List</h3><blockquote>
<p>Redis 列表是简单的字符串列表，按照插入顺序排序。你可以添加一个元素到列表的头部（左边）或者尾部（右边）。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># 移出并获取列表的第一个元素， 如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止</div><div class="line">blpop key1 timeout</div><div class="line"># 移出并获取列表的最后一个元素， 如果列表没有元素会阻塞列表直到等待超时或发现可弹出元素为止</div><div class="line">brpop key1 timeout</div><div class="line"># 通过索引获取列表中的元素</div><div class="line">lindex key index </div><div class="line"># 在列表的元素前或者后插入元素</div><div class="line">linsert key before|after pivot value</div><div class="line"># 获取列表长度</div><div class="line">llen key</div><div class="line"># 移出并获取列表的第一个元素</div><div class="line">lpop key</div><div class="line"># 移除并获取列表最后一个元素</div><div class="line">rpop key</div><div class="line"># 将一个或多个值插入到列表头部</div><div class="line">lpush key value1 value2</div><div class="line"># 获取列表指定范围内的元素</div><div class="line">lrange key start end</div><div class="line"># 移除列表元素指定次数</div><div class="line">lrem key count value</div><div class="line"># 通过索引设置列表元素的值</div><div class="line">lset key index value</div></pre></td></tr></table></figure>
<h3 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h3><blockquote>
<p>Redis的Set是string类型的无序集合。集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是O(1)。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"># 向集合添加一个或多个成员</div><div class="line">sadd key member member</div><div class="line"># 移除并返回集合中的一个随机元素</div><div class="line">spop key </div><div class="line"># 返回集合中一个或多个随机数</div><div class="line">srandmember key [count] </div><div class="line"># 移除集合中一个或多个成员</div><div class="line">srem key member1 member2</div><div class="line"># 获取集合的成员数</div><div class="line">scard key</div><div class="line"># 返回所有给定集合的并集</div><div class="line">sunion key1 key2</div><div class="line"># 返回给定所有集合的差集</div><div class="line">sdiff key1 key2</div><div class="line"># 返回给定所有集合的交集</div><div class="line">sinter key1 key2</div><div class="line"># 判断元素member是否是集合key的成员</div><div class="line">sismember key member</div><div class="line"># 返回集合中的所有成员</div><div class="line">smembers key</div><div class="line"># 将member元素从source集合移动到destination集合</div><div class="line">smove source destination member</div></pre></td></tr></table></figure>
<h3 id="Sorted-Set"><a href="#Sorted-Set" class="headerlink" title="Sorted Set"></a>Sorted Set</h3><blockquote>
<p>Sorted Set与set 一样也是string类型元素的集合,且不允许重复的成员。不同的是每个元素都会关联一个double类型的分数。redis正是通过分数来为集合中的成员进行从小到大的排序。zset的成员是唯一的,但分数(score)却可以重复。</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Sorted Set 操作方法同Set, 只需把第一个字母s改成z, 用法相同</div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2018/04/25/redis-use/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-04-12 </div>
			<div class="article-title"><a href="/2018/04/12/salt-returner/" >saltstack获取minion执行返回信息</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="saltstack-returner"><a href="#saltstack-returner" class="headerlink" title="saltstack returner"></a>saltstack returner</h1><blockquote>
<p>在默认情况下master远程操作minion执行的命令, 执行的结果会返回到master终端显示出来, 但是saltstack 提供了接口可以输出到其他的系统, 如mysql, redis, postgresql等</p>
</blockquote>
<p>收集minion命令执行结果有2种方式:</p>
<ol>
<li>由minion执行完后直接return</li>
<li>由master端获取</li>
</ol>
<p>第一种方式是由master下发命令, 当命令执行完毕后, minion就直接把返回的信息给传到mysql即returner<br><img src="https://raw.githubusercontent.com/DearEirs/static/master/images/minion.png" alt="image"></p>
<p>第二种方式是master下发命令, 当minion执行命令完毕时, 还是照样把信息返回给master, 然后master再集中把返回信息存到数据库当中<br><img src="https://raw.githubusercontent.com/DearEirs/static/master/images/master.png" alt="image"></p>
<h3 id="返回的信息究竟是怎样的"><a href="#返回的信息究竟是怎样的" class="headerlink" title="返回的信息究竟是怎样的"></a>返回的信息究竟是怎样的</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"># 在执行saltstack命令时, 我们可以通过--return 参数来指定returner</div><div class="line"></div><div class="line">salt &apos;*&apos; test.ping --return syslog</div><div class="line"></div><div class="line"># 查看系统/var/log/message看到日志如下</div><div class="line">Apr 12 18:00:04 zsad1 salt-minion: &#123;&quot;fun_args&quot;: [], &quot;jid&quot;: &quot;20180412180004363873&quot;, &quot;return&quot;: true, &quot;retcode&quot;: 0, &quot;success&quot;: true, &quot;fun&quot;: &quot;test.ping&quot;, &quot;id&quot;: &quot;zsad1&quot;&#125;</div><div class="line"></div><div class="line"># 还可以同时使用多个returner, 以,分割即可</div><div class="line">salt &apos;*&apos; test.ping --return syslog,postgres</div></pre></td></tr></table></figure>
<ul>
<li>fun_args: 执行方法时传入的参数</li>
<li>jid: job_id 任务id</li>
<li>return: </li>
<li>retcode: 执行命令返回码</li>
<li>success: 是否成功</li>
<li>fun: 执行的方法</li>
<li>id: minion的id</li>
</ul>
<p>更多自带的returner可以查阅官网: <a href="https://docs.saltstack.com/en/latest/ref/returners/all/index.html" target="_blank" rel="external">点我打开</a></p>
<h1 id="使用returner"><a href="#使用returner" class="headerlink" title="使用returner"></a>使用returner</h1><h3 id="把信息存放到postgresql"><a href="#把信息存放到postgresql" class="headerlink" title="把信息存放到postgresql"></a>把信息存放到postgresql</h3><p>需要先安装psycopg2模块<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install psycopg2</div></pre></td></tr></table></figure></p>
<p>minion配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">returner.postgres.host: &apos;172.16.1.80&apos;</div><div class="line">returner.postgres.user: &apos;salt&apos;</div><div class="line">returner.postgres.passwd: &apos;salt&apos;</div><div class="line">returner.postgres.db: &apos;salt&apos;</div><div class="line">returner.postgres.port: 5432</div></pre></td></tr></table></figure></p>
<p>postgres创建数据库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line"># 在官网复制的</div><div class="line">psql &lt;&lt; EOF</div><div class="line">CREATE ROLE salt WITH PASSWORD &apos;salt&apos;;</div><div class="line">CREATE DATABASE salt WITH OWNER salt;</div><div class="line">EOF</div><div class="line"></div><div class="line">psql -h localhost -U salt &lt;&lt; EOF</div><div class="line">--</div><div class="line">-- Table structure for table &apos;jids&apos;</div><div class="line">--</div><div class="line"></div><div class="line">DROP TABLE IF EXISTS jids;</div><div class="line">CREATE TABLE jids (</div><div class="line">  jid   varchar(20) PRIMARY KEY,</div><div class="line">  load  text NOT NULL</div><div class="line">);</div><div class="line"></div><div class="line">--</div><div class="line">-- Table structure for table &apos;salt_returns&apos;</div><div class="line">--</div><div class="line"></div><div class="line">DROP TABLE IF EXISTS salt_returns;</div><div class="line">CREATE TABLE salt_returns (</div><div class="line">  fun       varchar(50) NOT NULL,</div><div class="line">  jid       varchar(255) NOT NULL,</div><div class="line">  return    text NOT NULL,</div><div class="line">  full_ret  text,</div><div class="line">  id        varchar(255) NOT NULL,</div><div class="line">  success   varchar(10) NOT NULL,</div><div class="line">  alter_time   TIMESTAMP WITH TIME ZONE DEFAULT now()</div><div class="line">);</div><div class="line"></div><div class="line">CREATE INDEX idx_salt_returns_id ON salt_returns (id);</div><div class="line">CREATE INDEX idx_salt_returns_jid ON salt_returns (jid);</div><div class="line">CREATE INDEX idx_salt_returns_fun ON salt_returns (fun);</div><div class="line">CREATE INDEX idx_salt_returns_updated ON salt_returns (alter_time);</div><div class="line"></div><div class="line">--</div><div class="line">-- Table structure for table `salt_events`</div><div class="line">--</div><div class="line"></div><div class="line">DROP TABLE IF EXISTS salt_events;</div><div class="line">DROP SEQUENCE IF EXISTS seq_salt_events_id;</div><div class="line">CREATE SEQUENCE seq_salt_events_id;</div><div class="line">CREATE TABLE salt_events (</div><div class="line">    id BIGINT NOT NULL UNIQUE DEFAULT nextval(&apos;seq_salt_events_id&apos;),</div><div class="line">    tag varchar(255) NOT NULL,</div><div class="line">    data text NOT NULL,</div><div class="line">    alter_time TIMESTAMP WITH TIME ZONE DEFAULT NOW(),</div><div class="line">    master_id varchar(255) NOT NULL</div><div class="line">);</div><div class="line"></div><div class="line">CREATE INDEX idx_salt_events_tag on salt_events (tag);</div><div class="line"></div><div class="line">EOF</div></pre></td></tr></table></figure></p>
<p>测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># minion修改完配置后需要先重启</div><div class="line">salt &apos;*&apos; test.ping --return postgres</div></pre></td></tr></table></figure></p>
<p>然后我们就可以看到返回的信息已经存到postgresql</p>
<blockquote>
<p>如果不想每次都在命令里指定returner, 可在master的配置文件上添加 return:mysql</p>
</blockquote>
<h3 id="自定义-returner"><a href="#自定义-returner" class="headerlink" title="自定义 returner"></a>自定义 returner</h3><p>saltstack 虽然自带了很多的returner, 但是还是不能满足我们所有的需求, 我们总想拿着数据干点事情, 比如存到本地文件, es上, 下面我们来看看如何自定义一个returner</p>
<blockquote>
<p>自定义的returner模块文件应存放在/srv/salt/_returners 目录下</p>
</blockquote>
<p>local_file.py<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python           </span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-          </span></div><div class="line"><span class="comment"># arthur:Dear                   </span></div><div class="line"><span class="comment"># 2018-04-12 18:22:59           </span></div><div class="line">       </div><div class="line">       </div><div class="line"><span class="keyword">import</span> salt.config              </div><div class="line">       </div><div class="line">       </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">__virtual__</span><span class="params">()</span>:</span>              </div><div class="line">    <span class="string">''' </span></div><div class="line"><span class="string">    返回命令行调用时指定的returner名称</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'local_file'</span></div><div class="line">       </div><div class="line">       </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_log_file</span><span class="params">(path_to_master_config)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line"><span class="string">    需要在minion的配置文件里配置RETURN_FILE为结果日志文件路径</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    config = salt.config.client_config(path_to_master_config)</div><div class="line">    log_file = config[<span class="string">'RETURN_FILE'</span>]</div><div class="line">    <span class="keyword">return</span> log_file</div><div class="line">       </div><div class="line">       </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">returner</span><span class="params">(ret)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line"><span class="string">    salt 默认调用的方法, 方法名必须为returner</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    log_file = get_log_file(<span class="string">'/etc/salt/minion'</span>)</div><div class="line">    <span class="keyword">with</span> open(log_file, <span class="string">'a+'</span>) <span class="keyword">as</span> f:</div><div class="line">        f.write(str(ret))</div></pre></td></tr></table></figure></p>
<p>把文件同步到minion上然后重启就可以使用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;*&apos; test.ping --return local_file</div></pre></td></tr></table></figure>
<h1 id="由master端收集返回信息"><a href="#由master端收集返回信息" class="headerlink" title="由master端收集返回信息"></a>由master端收集返回信息</h1><blockquote>
<p>第二种方法是通过event来获取minion执行的返回信息</p>
</blockquote>
<p>脚本如下:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> salt.config</div><div class="line"><span class="keyword">import</span> salt.utils.event</div><div class="line"></div><div class="line">__opts__ = salt.config.client_config(<span class="string">'/etc/salt/master'</span>)</div><div class="line">events = salt.utils.event.MasterEvent(__opts__[<span class="string">'sock_dir'</span>])</div><div class="line"></div><div class="line"><span class="keyword">for</span> event <span class="keyword">in</span> events.iter_events(full=<span class="keyword">True</span>):</div><div class="line">    print(<span class="string">'-'</span> * <span class="number">100</span>)</div><div class="line">    print(event)</div></pre></td></tr></table></figure></p>
<p>通过脚本, salt执行的操作(包括命令, key认证等) 都可以通过event获取到, 我们可以通过event的信息来入库, 甚至是监控salt的命令的执行情况.</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>通过returner方式来获取minion执行结果需要在所有minion上都进行配置, 如果数据需要入库的话, 还要保证所有minion与数据库的网络能够正常连接</p>
<p>通过event方式获取minion执行结果则没那么麻烦, 只需在master上执行脚本即可, 即便需要入库, 也只需master与数据库的连接, minion无需进行任何额外的配置, 但是需要注意的是event获取到的数据都是实时的, 如果不慎脚本出现错误或者挂掉了, 那么数据将会丢失, 直至脚本再次正常启动.</p>

	
	</div>
  <a type="button" href="/2018/04/12/salt-returner/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-04-12 </div>
			<div class="article-title"><a href="/2018/04/12/hadoop/" >Hadoop+Hive+Presto环境搭建</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h3 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h3><p>master: vertica1  172.16.1.234</p>
<p>slave1: vertica2  172.16.1.235</p>
<p>slave2: vertica3  172.16.1.236</p>
<p>postgresql: 172.16.0.80</p>
<p>版本:<br>jdk: 1.8</p>
<p>Hadoop: 2.8.3 <a href="http://mirrors.hust.edu.cn/apache/hadoop/common/hadoop-2.8.3/hadoop-2.8.3.tar.gz" target="_blank" rel="external">下载链接</a></p>
<p>Hive: 2.3.2<a href="http://mirrors.hust.edu.cn/apache/hive/hive-2.3.3/apache-hive-2.3.3-bin.tar.gz" target="_blank" rel="external">下载链接</a></p>
<p>Presto: 0.197<a href="https://repo1.maven.org/maven2/com/facebook/presto/presto-server/0.198/presto-server-0.198.tar.gz" target="_blank" rel="external">下载链接</a></p>
<p>sqoop: 1.4.7<a href="https://mirrors.tuna.tsinghua.edu.cn/apache/sqoop/1.4.7/sqoop-1.4.7.bin__hadoop-2.6.0.tar.gz" target="_blank" rel="external">下载链接</a></p>
<hr>
<h1 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h1><ol>
<li>用户创建</li>
<li>jdk安装</li>
<li>ssh免密钥登录</li>
<li>目录创建</li>
<li>配置hosts</li>
</ol>
<h3 id="用户创建"><a href="#用户创建" class="headerlink" title="用户创建"></a>用户创建</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">useradd hadoop</div><div class="line">echo  &apos;hadoop&apos;|passwd --stdin hadoop</div></pre></td></tr></table></figure>
<h3 id="jdk安装"><a href="#jdk安装" class="headerlink" title="jdk安装"></a>jdk安装</h3><p>略</p>
<h3 id="ssh免密钥登录"><a href="#ssh免密钥登录" class="headerlink" title="ssh免密钥登录"></a>ssh免密钥登录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># 生成密钥</div><div class="line">ssh-keygen -t rsa</div><div class="line"></div><div class="line"># 配置信任主机</div><div class="line">cd .ssh</div><div class="line">touch authorized_keys</div><div class="line">cat id_rsa.pub &gt;&gt; authorized_keys</div><div class="line"># 全部主机的公钥都要添加到authorized_keys上</div><div class="line"></div><div class="line"># 设置文件权限</div><div class="line">chmod 700 ../.ssh/</div><div class="line">chmod 600 ./authorized_keys </div><div class="line"></div><div class="line"># 测试</div><div class="line">ssh hadoop@172.16.1.235</div></pre></td></tr></table></figure>
<h3 id="目录创建"><a href="#目录创建" class="headerlink" title="目录创建"></a>目录创建</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"># /data/hadoop 作为hadoop的安装路径</div><div class="line">mkdir -p /data/hadoop</div><div class="line">chown -R hadoop.hadoop /data/hadoop</div></pre></td></tr></table></figure>
<h3 id="hosts文件配置"><a href="#hosts文件配置" class="headerlink" title="hosts文件配置"></a>hosts文件配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cat /etc/hosts</div><div class="line"></div><div class="line">127.0.0.1   localhost</div><div class="line">::1         localhost</div><div class="line">172.16.1.234   vertica1</div><div class="line">172.16.1.235   vertica2</div><div class="line">172.16.1.236   vertica3</div></pre></td></tr></table></figure>
<p><strong>配置操作均在hadoop用户下执行</strong></p>
<h1 id="Hadoop安装配置"><a href="#Hadoop安装配置" class="headerlink" title="Hadoop安装配置"></a>Hadoop安装配置</h1><p>core-site.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"># core-site.xml 是hdfs的配置</div><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;fs.defaultFS&lt;/name&gt;</div><div class="line">    &lt;value&gt;hdfs://vertica1:8020&lt;/value&gt;</div><div class="line">    &lt;description&gt; 设定namenode的主机名及端口 </div><div class="line">    &lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">       </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;io.file.buffer.size&lt;/name&gt;</div><div class="line">    &lt;value&gt;131072&lt;/value&gt;</div><div class="line">    &lt;description&gt;设置缓存大小 &lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hadoop.tmp.dir&lt;/name&gt;</div><div class="line">    &lt;value&gt;file://data/hadoop/tmp&lt;/value&gt;</div><div class="line">    &lt;description&gt;临时文件的目录 &lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure></p>
<p>hdfs-site.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.namenode.name.dir&lt;/name&gt;</div><div class="line">    &lt;value&gt;file:/data/hadoop/hdfs/name&lt;/value&gt;</div><div class="line">    &lt;description&gt;namenode存放命名空间与交换日志</div><div class="line">    &lt;/description&gt; </div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.datanode.data.dir&lt;/name&gt;</div><div class="line">    &lt;value&gt;file:/data/hadoop/hdfs/data&lt;/value&gt;</div><div class="line">    &lt;description&gt; DataNode 在本地存放块文件的目录</div><div class="line">    &lt;/description&gt; </div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.replication&lt;/name&gt;</div><div class="line">    &lt;value&gt;3&lt;/value&gt;</div><div class="line">    &lt;description&gt; HDFS 存储文件的副本个数,默认为3</div><div class="line">    &lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.webhdfs.enabled&lt;/name&gt;</div><div class="line">    &lt;value&gt;true&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure></p>
<p>yarn-site.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.nodemanager.aux-services&lt;/name&gt;</div><div class="line">    &lt;value&gt;mapreduce_shuffle&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.nodemanager.aux-services.mapreduce.shuffle.class&lt;/name&gt;</div><div class="line">    &lt;value&gt;org.apache.hadoop.mapred.ShuffleHandler&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.resourcemanager.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;vertica1:8032&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.resourcemanager.scheduler.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;vertica1:8030&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">       </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.resourcemanager.resource-tracker.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;vertica1:8031&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.resourcemanager.admin.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;vertica1:8033&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.resourcemanager.webapp.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;vertica1:8088&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure></p>
<p>mapred-site.xml<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;mapreduce.framework.name&lt;/name&gt;</div><div class="line">    &lt;value&gt;yarn&lt;/value&gt;</div><div class="line">    &lt;final&gt;true&lt;/final&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;mapreduce.jobtracker.http.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;vertica1:50030&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;mapreduce.jobhistory.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;vertica1:10020&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;vertica1:19888&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;mapred.job.tracker&lt;/name&gt;</div><div class="line">    &lt;value&gt;http://vertica1:9001&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure></p>
<p>slaves<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">cat ./slaves </div><div class="line"># slave配置的为datanode节点</div><div class="line">vertica1</div><div class="line">vertica2</div><div class="line">vertica3</div></pre></td></tr></table></figure></p>
<h3 id="环境变量配置"><a href="#环境变量配置" class="headerlink" title="环境变量配置"></a>环境变量配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"># 把下面内容加入到/etc/profile</div><div class="line"># 然后source /etc/profile</div><div class="line"></div><div class="line">JAVA_HOME=/usr/java/jdk1.8.0_112</div><div class="line">JRE_HOME=$JAVA_HOME/jre</div><div class="line">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar:$JRE_HOME/lib</div><div class="line"></div><div class="line">export HADOOP_INSTALL=/data/hadoop/hadoop</div><div class="line">export HADOOP_HOME=$HADOOP_INSTALL</div><div class="line">export HADOOP_CONF_DIR=$HADOOP_HOME/etc/hadoop</div><div class="line">export PATH=$PATH:$HADOOP_INSTALL/bin</div></pre></td></tr></table></figure>
<h3 id="启动hadoop"><a href="#启动hadoop" class="headerlink" title="启动hadoop"></a>启动hadoop</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># 初始化hdfs</div><div class="line">$HADOOP/bin/hdfs namenode -format</div><div class="line"># 启动hadoop各个组件</div><div class="line">$HADOOP/sbin/start-all.sh</div><div class="line"># 查看组件启动情况</div><div class="line">jps</div><div class="line"></div><div class="line">ResourceManager</div><div class="line">NodeManager</div><div class="line">NameNode</div><div class="line">DataNode</div><div class="line">SecondaryNameNode</div><div class="line"></div><div class="line"># master上应该有以上5个进程</div><div class="line"># slave上应该只有1个进程</div><div class="line"># 如果有个别进程没启动成功, 可查看具体日志</div></pre></td></tr></table></figure>
<h1 id="Hive安装配置"><a href="#Hive安装配置" class="headerlink" title="Hive安装配置"></a>Hive安装配置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line">&lt;configuration&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;</div><div class="line">    &lt;value&gt;jdbc:postgresql://172.16.1.80:5432/hive?create=true&amp;amp;useUnicode=true&amp;amp;characterEncoding=utf8&amp;amp;allowEncodingChanges=true&amp;amp;loglevel=1;useSSL=false&lt;/value&gt;</div><div class="line">    &lt;description&gt;metastore数据库连接&lt;/description&gt;</div><div class="line">  &lt;/property&gt; </div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;</div><div class="line">    &lt;value&gt;org.postgresql.Driver&lt;/value&gt;</div><div class="line">    &lt;description&gt;Driver class name for a JDBCmetastore&lt;/description&gt;</div><div class="line">  &lt;/property&gt; </div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;</div><div class="line">    &lt;value&gt;hadoop&lt;/value&gt;</div><div class="line">    &lt;description&gt;连接metastore的数据库用户&lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;</div><div class="line">    &lt;value&gt;hadoop&lt;/value&gt;</div><div class="line">    &lt;description&gt;连接metastore的数据库用户的密码&lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.server2.thrift.port&lt;/name&gt;</div><div class="line">    &lt;value&gt;10000&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.server2.thrift.bind.host&lt;/name&gt;</div><div class="line">    &lt;value&gt;vertica1&lt;/value&gt;</div><div class="line">    &lt;description&gt;主机名称&lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line"></div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.server2.authentication&lt;/name&gt;</div><div class="line">    &lt;value&gt;NONE&lt;/value&gt;</div><div class="line">    &lt;description&gt;&lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line"></div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.server2.enable.doAs&lt;/name&gt;</div><div class="line">    &lt;value&gt;true&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line"></div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;datanucleus.schema.autoCreateAll&lt;/name&gt;</div><div class="line">    &lt;value&gt;false&lt;/value&gt;</div><div class="line">    &lt;description&gt;自动创建metastore&lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.server2.logging.operation.log.location&lt;/name&gt;</div><div class="line">    &lt;value&gt;/data/hadoop/hive/tmp/$&#123;user.name&#125;/operation_logs&lt;/value&gt;</div><div class="line">    &lt;description&gt;操作日志路径&lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line"></div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.metastore.warehouse.dir&lt;/name&gt;</div><div class="line">    &lt;value&gt;/warehouse&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  </div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.exec.scratchdir&lt;/name&gt;</div><div class="line">    &lt;value&gt;/tmp/hive&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.querylog.location&lt;/name&gt;</div><div class="line">    &lt;value&gt;/log&lt;/value&gt;</div><div class="line">    &lt;description&gt;&lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line"></div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.metastore.uris&lt;/name&gt;</div><div class="line">    &lt;value&gt;thrift://172.16.1.234:9083&lt;/value&gt;</div><div class="line">    &lt;description&gt;Thrift URI for the remote metastore. Used by metastore client to connect to remote metastore.&lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line"></div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;hive.server2.transport.mode&lt;/name&gt;</div><div class="line">    &lt;value&gt;binary&lt;/value&gt;</div><div class="line">    &lt;description&gt;</div><div class="line">       当为binary的时候,只是启动10000端口,反之启用10001端口.    </div><div class="line">    &lt;/description&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">&lt;/configuration&gt;</div></pre></td></tr></table></figure>
<p>使用postgresql作为元数据库需要额外的配置, 可参考</p>
<p><a href="https://my.oschina.net/sucre/blog/365351" target="_blank" rel="external">https://my.oschina.net/sucre/blog/365351</a></p>
<h3 id="启动Hive"><a href="#启动Hive" class="headerlink" title="启动Hive"></a>启动Hive</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 初始化元数据库前需要先在postgresql创建数据库</div><div class="line"># 初始化成功后可以在数据库看到生成了很多的表</div><div class="line"># 初始化元数据</div><div class="line">schematool -dbType postgres -initSchema</div><div class="line"></div><div class="line"># 启动Hive</div><div class="line">nohup hive --service metastore &amp;</div></pre></td></tr></table></figure>
<h1 id="presto安装配置"><a href="#presto安装配置" class="headerlink" title="presto安装配置"></a>presto安装配置</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"># 解压presto后需要手动创建配置目录与文件</div><div class="line">cd /data/hadoop/presto</div><div class="line">mkdir -p ./etc/catalog</div><div class="line">touch ./etc/config.properties</div><div class="line">touch ./etc/jmx.properties</div><div class="line">touch ./etc/jvm.config</div><div class="line">touch ./etc/log.properties</div><div class="line">touch ./etc/node.properties</div></pre></td></tr></table></figure>
<p>config.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">node.environment=presto # 集群名字</div><div class="line">node.id=node1 # 节点名字</div><div class="line">node.data-dir=/data/hadoop/presto/data # 数据路径</div></pre></td></tr></table></figure></p>
<p>jvm.config<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">-server</div><div class="line">-Xmx4G</div><div class="line">-XX:+UseG1GC</div><div class="line">-XX:G1HeapRegionSize=32M</div><div class="line">-XX:+UseGCOverheadLimit</div><div class="line">-XX:+ExplicitGCInvokesConcurrent</div><div class="line">-XX:+HeapDumpOnOutOfMemoryError</div><div class="line">-XX:+ExitOnOutOfMemoryError</div></pre></td></tr></table></figure></p>
<p>config.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"># master</div><div class="line">coordinator=true # 是否作为协调员即master</div><div class="line"># 是否运行scheduler在coordinator的节点上运行, 从节点必须为True, 主节点可选</div><div class="line">node-scheduler.include-coordinator=true </div><div class="line">http-server.http.port=8080</div><div class="line">query.max-memory=4GB</div><div class="line">query.max-memory-per-node=1GB</div><div class="line">discovery-server.enabled=true</div><div class="line">discovery.uri=http://172.16.1.234:8080</div><div class="line"></div><div class="line"># slave</div><div class="line">coordinator=false</div><div class="line">http-server.http.port=8080</div><div class="line">query.max-memory=4GB</div><div class="line">query.max-memory-per-node=1GB</div><div class="line">discovery.uri=http://172.16.1.234:8080</div></pre></td></tr></table></figure></p>
<p>log.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">com.facebook.presto=INFO # 日志等级</div></pre></td></tr></table></figure></p>
<p>jmx.properties<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">connector.name=jmx</div></pre></td></tr></table></figure></p>
<p>配置好启动presto测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">/data/hadoop/presto/bin/launcher run # 前台启动</div><div class="line">/data/hadoop/presto/bin/launcher start # 后台启动</div></pre></td></tr></table></figure></p>
<hr>
<p>附sqoop数据导入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 把数据从postgresql导入hive</div><div class="line"># 先在hive创建数据库</div><div class="line">hive&gt; create database testdata</div><div class="line"># 导入数据, 数据会先从postgresql导入hdfs, 再由hdfs导入hive</div><div class="line">sqoop import-all-tables  --connect &quot;jdbc:postgresql://172.16.0.80/testdata&quot; --username username --password password --hive-database testdata -m 3 --direct  --hive-import   --create-hive-table</div></pre></td></tr></table></figure></p>

	
	</div>
  <a type="button" href="/2018/04/12/hadoop/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-03-14 </div>
			<div class="article-title"><a href="/2018/03/14/junior-sql/" >sql简单语法</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h3 id="查看命令"><a href="#查看命令" class="headerlink" title="查看命令"></a>查看命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">show databases; # 查看数据库</div><div class="line">show tables;    # 查看表</div><div class="line">show columns from table; # 查看列</div><div class="line">desc table;     # 查看列</div><div class="line">show status;    # 查看mysql状态信息</div><div class="line">show create database/table; # 查看建库/表语句</div><div class="line">show grants;    # 查看授权用户</div><div class="line">show errors/warnings; # 查看error, warning信息</div></pre></td></tr></table></figure>
<h3 id="查数据"><a href="#查数据" class="headerlink" title="查数据"></a>查数据</h3><ol>
<li>同时使用order by 与where子句时, order by子句应放于where子句后</li>
<li>AND 与 OR 同时使用时, 先计算AND, 若想先计算OR 可以()</li>
<li>group by 必须出现在where子句之后, 在order by子句之前</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span> 简单查询</div><div class="line">select column1, column2 from table; # 查看多列数据</div><div class="line">select * from table; # 查看所有列数据</div><div class="line">select  distinct id from table; # 查询不同的ID</div><div class="line">select * from table limit 5; # 查询前5条数据</div><div class="line">select * from table limit 5, 10; # 查询从第5行开始的前10条数据</div><div class="line"></div><div class="line"><span class="meta">#</span> 排序</div><div class="line">select * from table order by column1; # 按column1升序排列</div><div class="line">select * from table order by column1 ASC; # 按column1升序排列</div><div class="line">select * from table order by column1 desc; # 按column1降序排列</div><div class="line">select * from table order by column1, column2 desc; # 按column1升序排列后再按column2降序排列</div><div class="line"></div><div class="line"><span class="meta">#</span> 数据过滤</div><div class="line"></div><div class="line"><span class="meta">#</span> 操作符</div><div class="line">= : 等于</div><div class="line">&lt;&gt; : 不等于</div><div class="line">!= : 不等于</div><div class="line">&lt; : 小于</div><div class="line">&lt;= : 小于等于</div><div class="line"><span class="meta">&gt;</span> : 大于</div><div class="line"><span class="meta">&gt;</span>= : 大于等于</div><div class="line">between : 在两个数值之间</div><div class="line"></div><div class="line"><span class="meta">#</span> 单条件</div><div class="line">select * from table where id=1; # 查找表中, id=1的数据</div><div class="line">select * from table where id between 10 and 20; 查找表中id为10-20之间的数据(包括10, 20)</div><div class="line">select * from table where column1 is null; # 查找表中column1为Null的数据</div><div class="line"></div><div class="line"><span class="meta">#</span> 使用操作符过滤</div><div class="line">select * from table where id&gt;10 and column1 is not null; # 查找表中id&gt;10且column不为Null的数据</div><div class="line">select * from table where id&gt;10 or column1 is not null; # 查找表中id&gt;10或column不为Null的数据</div><div class="line">select * from table where id in (1,2,3); # 查找表中id为1、2、3的数据</div><div class="line"></div><div class="line">3¤</div><div class="line"><span class="meta">%</span> 匹配任意字符出现任意次数</div><div class="line">_ 匹配单个任意的字符</div><div class="line">select * from table where column1 like 'Dear%'; # 查找表中column1是以Dear开头的数据</div><div class="line">select * from table where column1 like '%Dear%'; # 查找表中column1包含字符Dear的数据</div><div class="line">select * from table where column1 like 'D_ar'; # 查找表中column1字段是4个字符的,其中以D开头, ar结束</div><div class="line"></div><div class="line"><span class="meta">#</span> 使用正则表达式过滤</div><div class="line"><span class="meta">#</span> 详情参考正则表达式</div><div class="line">select * from table where id regexp '[0-9]'; # 查找表中id为0至9的数据</div><div class="line"></div><div class="line"><span class="meta">#</span> 拼接字段</div><div class="line">select (name, 'is in class ' ,class) from student_info; # 把查询出来的结果拼接起来形成新的字符串</div><div class="line"></div><div class="line"><span class="meta">#</span> 使用别名</div><div class="line">select (name, 'is in class ' ,class) as info from student_info;</div><div class="line"></div><div class="line"><span class="meta">#</span> 字段计算</div><div class="line">select  item, inventory, price, inventory*price as total from items_info;</div><div class="line"></div><div class="line"><span class="meta">#</span> 文本处理函数</div><div class="line">RTrim()  去掉右边的空格</div><div class="line">LTrim()  去掉左边的空格</div><div class="line">Trim()   去掉左右两边的空格</div><div class="line">Upper()  将文本转为大写字符</div><div class="line">Lower()  将文本转为小写字符</div><div class="line">Left()   返回文本最左边的字符</div><div class="line">Right()  返回文本最右边的字符</div><div class="line">Length() 返回文本长度</div><div class="line"></div><div class="line"><span class="meta">#</span> 日期处理函数</div><div class="line">AddDate() 增加一个日期(天、周等)</div><div class="line">AddTime() 增加一个时间(时、分等)</div><div class="line">CurDate() 返回当前日期</div><div class="line">CurTime() 返回当前时间</div><div class="line">Date()    返回日期时间和日期部分</div><div class="line">Datediff() 计算两个日期的差</div><div class="line">Date_Format() 返回一个格式化的日期或时间串</div><div class="line">DayOfWeek() 返回日期对应的是星期几</div><div class="line">Time()    返回一个日期时间的时间部分</div><div class="line">Year()    返回一个日期的年份部分</div><div class="line">Month()   返回日期的月数部分</div><div class="line">Day()     返回日期的天数部分</div><div class="line">Hour()    返回日期的小时部分</div><div class="line">Minute()  返回日期的分钟部分</div><div class="line">Second()  返回日期的秒数部分</div><div class="line">Now()     返回当前时间</div><div class="line"></div><div class="line"><span class="meta">#</span> 数值处理函数</div><div class="line">Abs()     返回一个数的绝对值</div><div class="line">Sqrt()    返回一个数的平方根</div><div class="line">Exp()     返回一个数的指数值</div><div class="line">Mod()     返回除操作的余数</div><div class="line">Pi()      返回圆周率</div><div class="line">Rand()    返回一个随机数</div><div class="line">Sin()     返回一个角度的正弦</div><div class="line">Cos()     返回一个角度的余弦</div><div class="line">Tan()     返回一个角度的正切</div><div class="line"></div><div class="line"><span class="meta">#</span> 汇聚函数</div><div class="line">AVG()     返回某列的平均值</div><div class="line">MAX()     返回某列的最大值</div><div class="line">MIN()     返回某列的最小值</div><div class="line">SUM()     返回某列的值的总和</div><div class="line">COUNT()   返回某列的行数</div><div class="line"></div><div class="line"><span class="meta">#</span> 数据分组</div><div class="line">select class, count(*) from student_info group by class # 查看每个班级有多少学生</div><div class="line">select class, count(*) from student_info group by class having count(*) &gt;40 # 查看班级人数大于40人的班级</div><div class="line"><span class="meta">#</span> where 过滤行数据, having 过滤分组数据</div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2018/03/14/junior-sql/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-03-13 </div>
			<div class="article-title"><a href="/2018/03/13/super/" >python之super</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h3 id="为什么需要super"><a href="#为什么需要super" class="headerlink" title="为什么需要super"></a>为什么需要super</h3><p>在python没有引入super之前, 如果需要在子类中引用父类的方法, 一般写法如下:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Father</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">whoami</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"I am father"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Child</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">whoami</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"I am child"</span>)</div><div class="line">    Father.whoami(self)</div></pre></td></tr></table></figure>
<p>这样看好像没什么问题, 就算没有super也能正常调用父类的方法, 但是如果有一天Father类需要修改类名为Father1, 那么子类Child中也必须跟着修改.<br>想象下如果一个类有很多个子类, 这样一来我们就需要修改每个子类中引用父类的语句</p>
<h3 id="怎么使用super"><a href="#怎么使用super" class="headerlink" title="怎么使用super"></a>怎么使用super</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Help on <span class="class"><span class="keyword">class</span> <span class="title">super</span> <span class="title">in</span> <span class="title">module</span> <span class="title">builtins</span>:</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">super</span><span class="params">(object)</span></span></div><div class="line"><span class="class"> |  <span class="title">super</span><span class="params">()</span> -&gt; same as super(__class__, &lt;first argument&gt;)</span></div><div class="line"><span class="class"> |  super(type) -&gt; unbound super object</span></div><div class="line"><span class="class"> |  super(type, obj) -&gt; bound super object; requires isinstance(obj, type)</span></div><div class="line"><span class="class"> |  super(type, type2) -&gt; bound super object; requires issubclass(type2, type)</span></div><div class="line"><span class="class"> |  Typical use to call a cooperative superclass method:</span></div><div class="line"> |  <span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(B)</span>:</span></div><div class="line"> |      <span class="function"><span class="keyword">def</span> <span class="title">meth</span><span class="params">(self, arg)</span>:</span></div><div class="line"> |          super().meth(arg)</div><div class="line"> |  This works <span class="keyword">for</span> <span class="class"><span class="keyword">class</span> <span class="title">methods</span> <span class="title">too</span>:</span></div><div class="line"> |  <span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(B)</span>:</span></div><div class="line"> |      @classmethod</div><div class="line"> |      <span class="function"><span class="keyword">def</span> <span class="title">cmeth</span><span class="params">(cls, arg)</span>:</span></div><div class="line"> |          super().cmeth(arg)</div></pre></td></tr></table></figure>
<p>我们来看看super的帮助文档, 首先super是一个类, 它的调用方法有如下几种:</p>
<ol>
<li>super()</li>
<li>super(type)</li>
<li>super(type, obj)</li>
<li>super(type, type2)</li>
</ol>
<p>我们推荐用第一种方法来使用super, 因为它并不需要显式传递任何参数.但是要注意一点, super只能在新式类中使用.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is A"</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    super().__init__()</div><div class="line">    print(<span class="string">"this is B"</span>)</div><div class="line"></div><div class="line"></div><div class="line">b = B()</div><div class="line"></div><div class="line"><span class="string">"""</span></div><div class="line"><span class="string">this is A</span></div><div class="line"><span class="string">this is B</span></div><div class="line"><span class="string">"""</span></div></pre></td></tr></table></figure>
<p>看起来super就像直接调用了B的父类A的__init__, 其实并不是这样的, 我们看看super在多继承下的使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is A"</span>)</div><div class="line">    print(<span class="string">"leave A"</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(A)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is B"</span>)</div><div class="line">    super().__init__()</div><div class="line">    print(<span class="string">"leave B"</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(A)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is C"</span>)</div><div class="line">    super().__init__()</div><div class="line">    print(<span class="string">"leave C"</span>)</div><div class="line">  </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(B, C)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">"this is D"</span>)</div><div class="line">    super().__init__()</div><div class="line">    print(<span class="string">"leave D"</span>)</div><div class="line">    </div><div class="line">    </div><div class="line">d = D()</div><div class="line"></div><div class="line"><span class="string">"""</span></div><div class="line"><span class="string">this is D</span></div><div class="line"><span class="string">this is B</span></div><div class="line"><span class="string">this is C</span></div><div class="line"><span class="string">this is A</span></div><div class="line"><span class="string">leave A</span></div><div class="line"><span class="string">leave C</span></div><div class="line"><span class="string">leave B</span></div><div class="line"><span class="string">leave D</span></div><div class="line"><span class="string">"""</span></div><div class="line"></div><div class="line">print(D.__mro__)</div><div class="line"><span class="string">"""</span></div><div class="line"><span class="string">(&lt;class '__main__.D'&gt;, </span></div><div class="line"><span class="string">&lt;class '__main__.B'&gt;, </span></div><div class="line"><span class="string">&lt;class '__main__.C'&gt;, </span></div><div class="line"><span class="string">&lt;class '__main__.A'&gt;, </span></div><div class="line"><span class="string">&lt;class 'object'&gt;)</span></div><div class="line"><span class="string">"""</span></div></pre></td></tr></table></figure>
<blockquote>
<p>这里可以看到, 如果super只是简单调用父类的方法的话, 那么调用了B的__init__ 方法之后, 应该调用A的__init__ 才对, 但是调用的却是C的__init__ 方法</p>
</blockquote>
<p>这是因为super调用的是当前类在MRO列表中的后一个类, 而并不是简单地调用当前类的父类</p>
<blockquote>
<p>python并没有强制性限制我们使用super调用父类, 我们还是可以使用原始的方法来调用父类中的方法, 但是需要注意的是调用父类的方法要统一, 即全用super或全不用super, 而用super 的话, 调用的方式也最好是统一的</p>
</blockquote>

	
	</div>
  <a type="button" href="/2018/03/13/super/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2018-03-12 </div>
			<div class="article-title"><a href="/2018/03/12/new-style-class-and-classic-class/" >python之新式类与旧式类</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>本文中代码运行的python版本一律采取2.7.13</strong></p>
<p>科普:</p>
<p>经典类:classic class</p>
<p>新式类:new-style class</p>
<ol>
<li><p>python2.2 之前并没有新式类</p>
</li>
<li><p>python2.2-2.7 新式类与经典类并存, 默认使用经典类, 除非显式继承object</p>
</li>
<li><p>python3.X 中去除了经典类, 用户定义的所有类都隐式继承自object</p>
</li>
</ol>
<h3 id="如何使用新式类"><a href="#如何使用新式类" class="headerlink" title="如何使用新式类"></a>如何使用新式类</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">New</span><span class="params">(object)</span>:</span> <span class="comment"># 显式继承object类</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Old</span>:</span>  </div><div class="line">  <span class="keyword">pass</span></div><div class="line">  </div><div class="line">  </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Old2</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">pass</span></div></pre></td></tr></table></figure>
<p>上述代码中的3种定义类的方法, 只有第一种方法定义的是新式类.</p>
<h3 id="新式类VS经典类"><a href="#新式类VS经典类" class="headerlink" title="新式类VS经典类"></a>新式类VS经典类</h3><blockquote>
<p>新式类与经典类最主要的区别在于继承顺序, 事实上, 对于用户定义的每一个类, python 都会计算出一个<strong>方法解析顺序（Method Resolution Order, MRO）列表，它代表了类继承的顺序</strong>, 而由于经典类与新式类采用的算法不一致, 相同的继承关系可能会出现不一样的MRO列表.</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> inspect</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(D)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(D)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(B, C)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line">    </div><div class="line"></div><div class="line"><span class="keyword">print</span> inspect.getmro(A)</div><div class="line"></div><div class="line"><span class="comment"># (&lt;class __main__.A at 0x000000000322BB88&gt;, </span></div><div class="line"><span class="comment"># &lt;class __main__.B at 0x000000000322B9A8&gt;, </span></div><div class="line"><span class="comment"># &lt;class __main__.D at 0x000000000322BC48&gt;, </span></div><div class="line"><span class="comment"># &lt;class __main__.C at 0x000000000322B948&gt;)</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">D</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">C</span><span class="params">(D)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">B</span><span class="params">(D)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"> </div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span><span class="params">(B, C)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="keyword">print</span> inspect.getmro(A)</div><div class="line"></div><div class="line"><span class="comment"># (&lt;class '__main__.A'&gt;, </span></div><div class="line">&lt;class '__main__.B'&gt;, </div><div class="line">&lt;class '__main__.C'&gt;, </div><div class="line">&lt;class '__main__.D'&gt;, </div><div class="line">&lt;type <span class="string">'object'</span>&gt;)</div></pre></td></tr></table></figure>
<p>可以看到, 经典类的MRO顺序A-B-D-C 与新式类的MRO顺序 A-B-C-D-object 是存在差异的, 这可能会是我们日常会遇到的坑. </p>
<p>而除了继承顺序的差异, 新式类还添加了内置属性__slots__</p>
<blockquote>
<p>一般来说, 每个实例都有一个字典来管理实例的属性, 我们可以用__dict__ 来查看(__dict__并不保存类属性),它允许我们动态地修改实例的属性, 但是这也意味着每个实例都会有1个独立的字典需要我们去维护, 当我们需要创建大量的实例时, 这个操作是十分消耗内存的.</p>
<p>当我们在定义类时添加了__slots__属性后, 对象在实例化时就不会创建字典来管理实例属性, 而实例只能定义在__slots__里边已经设定好的属性名, 不允许动态添加其他未在__slots__里定义的属性</p>
</blockquote>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(object)</span>:</span></div><div class="line">  __slots__ = (<span class="string">'id'</span>, <span class="string">'name'</span>, <span class="string">'gender'</span>)</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">exam</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line">s1 = Student()</div><div class="line"><span class="string">'__dict__'</span> <span class="keyword">in</span> dir(s1) <span class="comment"># False</span></div><div class="line">s1.id = <span class="number">10001</span></div><div class="line">s1.<span class="keyword">class</span> = <span class="number">1</span> </div><div class="line"><span class="comment"># AttributeError: 'Student' object has no attribute 'class'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line">s1.exam = func </div><div class="line"><span class="comment"># AttributeError: 'Student' object attribute 'f' is read-only</span></div></pre></td></tr></table></figure>
<p>使用__slots__ 后我们不再能够动态地修改实例的属性, 那么使用__slots__究竟有什么好处呢?</p>
<p>优点：</p>
<ol>
<li>节省内存</li>
<li>提高属性访问速度</li>
</ol>
<p>缺点:</p>
<ol>
<li>不能动态修改实例属性</li>
</ol>
<hr>
<p>当然, 除了继承顺序和__slots__, 新式类添加了__getattribute__方法, 还修改了实例的类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">New</span><span class="params">(object)</span>:</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line">  </div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Old</span>:</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line">  </div><div class="line"> </div><div class="line">new = New()</div><div class="line">old = Old()</div><div class="line">print(new)</div><div class="line"><span class="comment"># &lt;__main__.New object at 0x0000000003262208&gt;</span></div><div class="line">print(old)</div><div class="line"><span class="comment"># &lt;__main__.Old instance at 0x000000000321C6C8&gt;</span></div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2018/03/12/new-style-class-and-classic-class/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
          <li class="prev disabled"><a><i class="fa fa-arrow-circle-o-left"></i>上一页</a></li>
        

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/2/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="搜索" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>分类</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/database/">database</label></a></li>
		
			<li><a href="/categories/django/">django</label></a></li>
		
			<li><a href="/categories/linux/">linux</label></a></li>
		
			<li><a href="/categories/python/">python</label></a></li>
		
			<li><a href="/categories/saltstack/">saltstack</label></a></li>
		
			<li><a href="/categories/web/">web</label></a></li>
		
			<li><a href="/categories/协议/">协议</label></a></li>
		
			<li><a href="/categories/大数据/">大数据</label></a></li>
		
		</ul>
	</div>


		
			
	<div class="widget">
		<h4>标签云</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/tags/mysql/">mysql</a></li>
		
			<li><a href="/tags/oop/">oop</a></li>
		
			<li><a href="/tags/django/">django</a></li>
		
			<li><a href="/tags/python/">python</a></li>
		
			<li><a href="/tags/函数/">函数</a></li>
		
			<li><a href="/tags/saltstack/">saltstack</a></li>
		
			<li><a href="/tags/代码优化/">代码优化</a></li>
		
			<li><a href="/tags/cgi/">cgi</a></li>
		
			<li><a href="/tags/rocketmq/">rocketmq</a></li>
		
			<li><a href="/tags/flask/">flask</a></li>
		
			<li><a href="/tags/异步/">异步</a></li>
		
			<li><a href="/tags/uwsgi/">uwsgi</a></li>
		
			<li><a href="/tags/jinja/">jinja</a></li>
		
			<li><a href="/tags/gc/">gc</a></li>
		
			<li><a href="/tags/vim/">vim</a></li>
		
			<li><a href="/tags/大数据/">大数据</a></li>
		
			<li><a href="/tags/http/">http</a></li>
		
			<li><a href="/tags/decorator/">decorator</a></li>
		
			<li><a href="/tags/闭包/">闭包</a></li>
		
			<li><a href="/tags/ELK/">ELK</a></li>
		
		
		   <li><a href="/tags">...<span>23</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>最新文章</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2018/06/21/cgi/" ><i class="fa fa-file-o"></i>cgi</a>
      </li>
    
      <li>
        <a href="/2018/06/21/cache/" ><i class="fa fa-file-o"></i>cache</a>
      </li>
    
      <li>
        <a href="/2018/06/21/http/" ><i class="fa fa-file-o"></i>http</a>
      </li>
    
      <li>
        <a href="/2018/05/10/flask/" ><i class="fa fa-file-o"></i>flask源码--处理过程</a>
      </li>
    
      <li>
        <a href="/2018/04/25/redis-use/" ><i class="fa fa-file-o"></i>redis常用命令</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>链接</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/DearEirs" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->


	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2018 Dear
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 




   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- syntax highlighting -->


</body>
   </html>
