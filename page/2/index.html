<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>第 2 页 | Dear&#39;s Blog</title>

  <meta name="author" content="Dear">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta name="renderer" content="webkit">

  
  <meta property="og:site_name" content="Dear&#39;s Blog"/>

  
    <meta property="og:image" content=""/>
  

  
  

  <!-- CSS -->
  <!-- link rel="stylesheet" href="/css/themes/bootstrap.css" media="screen" type="text/css" -->
  <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.6/css/bootstrap.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight-default.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/comment.css" media="screen" type="text/css">
  <!--[if lt IE 9]>
  <![endif]-->

</script>
  <script src="https://cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script>
  
  <!-- analytics -->
  



  <meta name="baidu-site-verification" content="RXfcpfczu8" />
</head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-default navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
	<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
       <a class="navbar-brand" href="/">Dear&#39;s Blog</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>目录
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>分类
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>标签
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>关于个人
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 <div class="row page">

	
	<div class="col-md-9">
	

		<div class="slogan">
      <i class="fa fa-heart"></i>
      Welcome to Dear&#39;s Blog
</div>    
		<div id="top_search"></div>
		<div class="mypage">
		
		<!-- title and entry -->
        <!-- render top articles firstly -->
        
        <!-- render other articles -->
        
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-12-24 </div>
			<div class="article-title"><a href="/2017/12/24/agile/" >初涉敏捷开发</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="传统开发"><a href="#传统开发" class="headerlink" title="传统开发"></a>传统开发</h1><h3 id="瀑布模型"><a href="#瀑布模型" class="headerlink" title="瀑布模型"></a>瀑布模型</h3><p><img src="https://raw.githubusercontent.com/DearEirs/learn_python/master/AgileDevelopment/%E7%80%91%E5%B8%83%E6%A8%A1%E5%9E%8B.png" alt=""></p>
<p>优点：</p>
<pre><code>瀑布模型中把开发过程细分成多个步骤, 每个人各司其职,
开发人员只需按照文档完成需求即可
</code></pre><p>缺点：</p>
<pre><code>- 需要编写过多的文档
- 开发周期长,每个步骤都需要等待上一个步骤完成后才可
以开展工作
- 需求响应慢,每有一个新需求,都需要完整地走一遍流程
- 用户没有参与开发过程,不能很好地知道开发出来的产品
有没有符合客户的要求
</code></pre><h1 id="敏捷开发"><a href="#敏捷开发" class="headerlink" title="敏捷开发"></a>敏捷开发</h1><h3 id="敏捷开发是什么"><a href="#敏捷开发是什么" class="headerlink" title="敏捷开发是什么"></a>敏捷开发是什么</h3><p>敏捷开发不是一套明确的流程,也不是一种方法或者工具,敏捷开发是遵循着敏捷宣言的一种思想, 所有遵循这种思想的实践都可以称为敏捷开发.</p>
<p>敏捷开发的核心思想：<strong>以人为本，专注交付对客户有价值的软件。在高度协作的环境中，使用迭代式的方式进行增量开发，经常根据反馈进行思考、反省和总结，不停地自我调整和完善，让软件开发与交付轻量而敏捷。</strong></p>
<h5 id="敏捷宣言"><a href="#敏捷宣言" class="headerlink" title="敏捷宣言"></a>敏捷宣言</h5><ul>
<li>个体和互动 高于 流程和工具</li>
<li>工作的文件 高于 详尽的文档</li>
<li>客户合作 高于 合同谈判</li>
<li>响应变化 高于 遵循计划</li>
</ul>
<h3 id="敏捷开发怎么做"><a href="#敏捷开发怎么做" class="headerlink" title="敏捷开发怎么做"></a>敏捷开发怎么做</h3><p>敏捷开发是一种思想, 那么XP(极限编程), Scrum, DSDM等就是这种思想具体的实践</p>
<h4 id="XP"><a href="#XP" class="headerlink" title="XP"></a>XP</h4><p>XP是一种使用于在需求不明,或快速多变的情况下进行软件开发的轻量级方法学,其核心价值观为：</p>
<ul>
<li>简单：只做必做的、最小设计、持续重构</li>
<li>沟通：及时有效，目的是一起创造最好的解决方案</li>
<li>反馈：严重承诺，尽快交付，认真听取反馈并及时改进</li>
<li>尊重：互相尊重，通过努力工作获得认同</li>
<li>勇气：如实反馈进展和预估，不为没完成的计划找借口，<br>勇于根据根据情况随时调整工作方式</li>
</ul>
<p><img src="https://raw.githubusercontent.com/DearEirs/learn_python/master/AgileDevelopment/XP.png" alt=""></p>
<p>XP的核心实践：</p>
<ul>
<li>Whole Team: 用户参与到开发团队, 协作开发更好地开发出用户所需要的功能</li>
<li>Planning Game：用户通过用户故事提出需求,开发人员作出发布计划和迭代计划并作出承诺如期完成任务</li>
<li>Customer Test：验收测试, 由客户来检验系统是否完成了既定的功能</li>
<li>Small Releases：最小发布, 即每开发出一个可正常工作的功能就可以发布</li>
<li>Collective Code Ownership： 集体代码所有权, 项目中的每个人都可以看到项目完整的代码</li>
<li>Coding Standards：编码风格统一</li>
<li>Sustainable Pace: 可持续的开发速度</li>
<li>Metaphor：全项目命名风格统一</li>
<li>Continuous Integration：持续集成</li>
<li>Test-driven development：测试驱动开发,编写覆盖率高的测试用例</li>
<li>Simple Design：用最简单的设计来完成工作</li>
<li>Refactoring：重构,去掉冗余代码,提高代码质量</li>
<li>Pair Programming：结对编程, 由两个程序员完成同一个需求, 可以再实现功能的同时review代码</li>
</ul>
<p>XP的过程：从用户根据用户故事提起需求后, 进行架构刺探, 功能刺探, 然后指定发布计划, 每次迭代发布周期为1-2周, 开发出完整功能后进行验收测试, 通过方可发布.</p>
<hr>
<h4 id="Scrum"><a href="#Scrum" class="headerlink" title="Scrum"></a>Scrum</h4><p><img src="https://raw.githubusercontent.com/DearEirs/learn_python/master/AgileDevelopment/Scrum.png" alt=""></p>
<p>由用户提起需求, 产品经理分析用户需求做出产品订单后, 进行冲刺计划会议, 制定每次冲刺需要完成的需求, 而一次冲刺的周期为3-4周,在冲刺过程中,成员自由领取冲刺订单,冲刺订单中包含着细化后的需求信息.冲刺期间每日都要召开站立会议,成员们各自讲述自己昨天你完成了哪些工作?今天你打算做什么?完成你的目标是否存在什么障碍?而在冲刺结束后, 同样会有冲刺回顾会议,会议上所有成员对这次会议进行反思</p>
<h4 id="XP-VS-Scrum"><a href="#XP-VS-Scrum" class="headerlink" title="XP VS Scrum"></a>XP VS Scrum</h4><p>XP相对于Scrum：</p>
<ul>
<li>迭代周期: XP迭代周期为1-2周, Scrum迭代周期为3-4周(现在多为1-2周)</li>
<li>应付新需求: 在XP中, 有限制地允许用户更改需求, 而Scrum中则不允许这样做, 一旦需求确定, 不可更改</li>
<li>开发过程: 在开发过程中, XP严格按照需求的优先级来开发, 而Scrum可以不按照需求优先级开发</li>
<li>实施规范: Scrum实施的过程中, 并没有规定采用XP中要求的结对编程、TDD、简单设计等行为</li>
</ul>
<h4 id="精益"><a href="#精益" class="headerlink" title="精益"></a>精益</h4><p>拉动式生产, 即当有需求的时候才开始生产, 这样做可以避免资源浪费,<br>自动化生产, 提高生产的效率</p>
<h3 id="为什么要使用敏捷开发"><a href="#为什么要使用敏捷开发" class="headerlink" title="为什么要使用敏捷开发"></a>为什么要使用敏捷开发</h3><p>在传统瀑布式开发的过程中存在的问题：</p>
<ul>
<li>项目文档繁重, 在编写文档上花费了过多的时间</li>
<li>用户对开发进度一无所知</li>
</ul>
<p>而在XP和Scrum中我们可以发现其共同点, 这也是敏捷开发的优势：</p>
<ul>
<li>持续集成, 产品一直处于可运行状态, 而开发人员只进行增量开发</li>
<li>开发前, 不需要编写太多的文档</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>并不是说敏捷开发就一定要比传统的瀑布式开发要好, 只能说各有所长, 而敏捷开发更适用于当前的软件开发当中.</p>
<hr>
<p>敏捷开发结合到自身工作中：</p>
<p>项目：ELK日志收集</p>
<p>需求：</p>
<ul>
<li>开发：可以看到系统日志, 用于发现,修复问题</li>
<li>老板：可以看到系统的访问量, 查询的响应时间的信息</li>
</ul>
<p>计划：</p>
<ul>
<li>搭建环境, 耗时0.5天</li>
<li>收集系统日志, 耗时0.5天</li>
<li>分析系统日志, 耗时0.5天</li>
</ul>
<blockquote>
<p>搭建环境时, 需要开发参与, 日志具体是在那台机器上, 并到对应的机器上安装所需软件.</p>
</blockquote>
<p>完成搭建环境时就可以向老板和开发展示,环境已经搭建完, 下一步是收集日志</p>
<blockquote>
<p>这时又需要开发提供日志的目录, 以供收集, 并编写相应的使用文档, 给开发和老板使用</p>
</blockquote>
<p>当收集完成后, 这时开发的需求已经完成, 可以让开发进行测试, 看看对日志收集功能是否满意, 是否有其他需求, 如果没有其他需求, 那么可以进行到下一步,分析日志</p>
<blockquote>
<p>分析日志期间需要老板和开发的共同参与, 老板提供具体想要看到的信息, 开发方面可能需要修改日志格式,然后进行分析得出报表</p>
</blockquote>
<p>这时整个搭建完成, 只完成了开发和老板所需要的功能, 每完成1个步骤都向老板和开发反馈, 用户参与到了搭建过程中, 有新需求或者需求做的不对时, 能够很快的得到反馈并作出调整</p>
<hr>
<p>瀑布式开发模式结合到公司管理：</p>
<p>相对于一个创业公司,很多工作有时候并没有规范到位, 这就需要有一套完整流程规范来让别人遵守, 花费一段时间来制定一套规范标准, 比每次遇到问题各成员间不知如何合作, 不知道自己应该负责什么部分要好</p>

	
	</div>
  <a type="button" href="/2017/12/24/agile/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-11-15 </div>
			<div class="article-title"><a href="/2017/11/15/ELK/" >ELK搭建</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="环境"><a href="#环境" class="headerlink" title="环境"></a>环境</h1><ul>
<li>系统：centos7.2 </li>
<li>redis：3.2.6 </li>
<li>filebeat：5.6.3</li>
<li>elasticsearch：5.6.3</li>
<li>kibana：5.6.3</li>
<li>x-pack：5.6.3</li>
<li>jdk：1.8</li>
</ul>
<p><strong>ELK的版本尽量统一</strong></p>
<h1 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">elasticsearch</div><div class="line">https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.6.3.tar.gz</div><div class="line"></div><div class="line">filebeat</div><div class="line">https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.6.3-linux-x86_64.tar.gz</div><div class="line"></div><div class="line">kibana</div><div class="line">https://artifacts.elastic.co/downloads/kibana/kibana-5.6.3-linux-x86_64.tar.gz</div><div class="line"></div><div class="line">logstash</div><div class="line">https://artifacts.elastic.co/downloads/logstash/logstash-5.6.3.tar.gz</div><div class="line"></div><div class="line">redis</div><div class="line">http://download.redis.io/releases/redis-3.2.6.tar.gz</div></pre></td></tr></table></figure>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><blockquote>
<p>安装的话只需要把下载回来的tar包解压即可,项目运行需要jdk支持, jdk自行安装</p>
</blockquote>
<h1 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h1><h3 id="redis"><a href="#redis" class="headerlink" title="redis"></a>redis</h3><blockquote>
<p>redis不是本文重点, 所以配置就不展开细说.</p>
</blockquote>
<h3 id="filebeat"><a href="#filebeat" class="headerlink" title="filebeat"></a>filebeat</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"># 输入</div><div class="line">filebeat:</div><div class="line">  prospectors: # 可加多个, 用-分割, 每个prospectors可以有不同的配置</div><div class="line">    -</div><div class="line">      input_type: log</div><div class="line">      paths: # 可加多个, 每行一个用-分割</div><div class="line">        - /data/logs/portal/logs/info.log</div><div class="line">      fields: # 需要添加的字段</div><div class="line">        app: portal</div><div class="line">        host: zsmd2</div><div class="line">      include_lines: [&quot;ERROR&quot;] # 匹配包含&quot;INFO&quot;的消息</div><div class="line">      # 开启多行匹配</div><div class="line">      # pattern 消息按指定内容划分, </div><div class="line">      multiline.pattern: &apos;^\[&apos;</div><div class="line">      multiline.negate: true</div><div class="line">      multiline.match: after</div><div class="line">    -</div><div class="line">      input_type: log</div><div class="line">      paths: # 路径匹配也可以用正则</div><div class="line">        - /data/apps/ops/demo-service-provider*/bin/api.log</div><div class="line">      fields:</div><div class="line">        app: dubbo</div><div class="line">        host: zsmd2</div><div class="line">      multiline.pattern: &apos;^\d&#123;2&#125;:\d&#123;4&#125;:\d&#123;2&#125;&apos;</div><div class="line">      multiline.negate: true</div><div class="line">      multiline.match: after</div><div class="line">    -</div><div class="line">      input_type: log</div><div class="line">      paths:</div><div class="line">        - /data/apps/ops/smart-schedule/schedule/logs/error.log</div><div class="line">      fields:</div><div class="line">        app: schedule</div><div class="line">        host: zsmd2</div><div class="line">      multiline.pattern: &apos;^\[&apos;</div><div class="line">      multiline.negate: true</div><div class="line">      multiline.match: after</div><div class="line"></div><div class="line"># 输出</div><div class="line"># 输出到redis</div><div class="line">output.redis:</div><div class="line">   enabled: true</div><div class="line">   hosts: [&quot;172.16.0.237:6379&quot;] # 有多个的话用逗号分隔, 写在列表里边</div><div class="line">   key: &quot;zsdata&quot;</div><div class="line">   datatype: list</div><div class="line">   input_type: logs</div><div class="line">   password: &apos;redis&apos;</div><div class="line"></div><div class="line"># 输出到控制台, 可以省略, 搭建时主要为了方便看到数据</div><div class="line">output.console:</div><div class="line">  enabled: true</div><div class="line"></div><div class="line">参考：http://blog.csdn.net/chengxuyuanyonghu/article/details/54378778</div></pre></td></tr></table></figure>
<h3 id="elasticsearch"><a href="#elasticsearch" class="headerlink" title="elasticsearch"></a>elasticsearch</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">cluster.name: elasticsearch-cluster # 集群名</div><div class="line">node.name: zsad1 # 节点名</div><div class="line">node.master: true </div><div class="line">network.host: 0.0.0.0</div><div class="line">http.port: 9200</div><div class="line">discovery.zen.minimum_master_nodes: 1 # </div><div class="line"># xpack参数 不用的话可略, 下面再细讲xpack破解</div><div class="line">xpack.security.enabled: true</div></pre></td></tr></table></figure>
<h3 id="logstash"><a href="#logstash" class="headerlink" title="logstash"></a>logstash</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"># 输入</div><div class="line">input&#123;</div><div class="line">    redis &#123;</div><div class="line">        host =&gt; &quot;172.16.0.237&quot;</div><div class="line">        port =&gt; 6379</div><div class="line">        threads =&gt; 5 </div><div class="line">        data_type =&gt; &quot;list&quot;</div><div class="line">        type =&gt; &apos;redis-input&apos;</div><div class="line">        key =&gt; &quot;zsdata&quot;</div><div class="line">        password =&gt; &apos;password&apos;</div><div class="line">    &#125;</div><div class="line"># 过滤</div><div class="line">    # 移除不需要的字段</div><div class="line">    mutate&#123;</div><div class="line">        remove_field =&gt; [&quot;type&quot;, &quot;input_type&quot;, &quot;offset&quot;, &quot;beat&quot;, &quot;\@version&quot;, &apos;@version&apos;, &quot;@version&quot;]</div><div class="line">    &#125;</div><div class="line"></div><div class="line"># 输出</div><div class="line">output&#123;</div><div class="line">    # 输出数据到elasticsearch</div><div class="line">    elasticsearch&#123;</div><div class="line">      hosts =&gt; [&quot;172.16.0.80:9200&quot;]</div><div class="line">      user =&gt; &apos;username&apos;</div><div class="line">      password =&gt; &apos;password&apos;</div><div class="line">      index =&gt; &quot;zsdata-%&#123;+dd-MM-YYYY&#125;&quot; # 索引</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    # 判断是否有错误日志, 有的话就调用脚本发送邮件,  127.0.0.1:5000是自己写的发送邮件脚本</div><div class="line">    if &quot;ERROR&quot; in [message] &#123;</div><div class="line">      exec &#123;</div><div class="line">         command =&gt; &quot;curl  -XPOST -H  &apos;Content-Type: application/json&apos; 127.0.0.1:5000/email -d &apos;&#123;\&quot;message\&quot;: \&quot;%&#123;message&#125;\nsource at %&#123;source&#125;\&quot;, \&quot;from\&quot;:\&quot;xxxxxxxx@qq.com\&quot;, \&quot;to\&quot;:\&quot;xxxxxxxx@qq.com\&quot;, \&quot;subject\&quot;: \&quot;%&#123;fields[app]&#125; Get Error log in  %&#123;fields[host]&#125;\&quot;&#125;&apos; &quot;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    # 输出到控制台, 方便调试</div><div class="line">    stdout&#123; codec=&gt; &quot;rubydebug&quot; &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="kibana"><a href="#kibana" class="headerlink" title="kibana"></a>kibana</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">server.host: 0.0.0.0</div><div class="line"># elasticsearch 的地址</div><div class="line">elasticsearch.url: &quot;http://172.16.0.80:9200&quot;</div><div class="line"># 使用xpack后需要登录 以下为默认账号</div><div class="line">elasticsearch.username: &quot;elastic&quot;</div><div class="line">elasticsearch.password: &quot;changeme&quot;</div><div class="line">xpack.monitoring.enabled: true</div><div class="line">i18n.defaultLocale: &quot;cn&quot;</div></pre></td></tr></table></figure>
<h3 id="xpack破解"><a href="#xpack破解" class="headerlink" title="xpack破解"></a>xpack破解</h3><p><a href="http://blog.csdn.net/mvpboss1004/article/details/65445023" target="_blank" rel="external">参考地址：http://blog.csdn.net/mvpboss1004/article/details/65445023</a></p>

	
	</div>
  <a type="button" href="/2017/11/15/ELK/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-10-24 </div>
			<div class="article-title"><a href="/2017/10/24/salt-file-backup/" >salt分发文件时自动备份</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p>在日常工作中,我们经常会用saltstack来分发文件,但是如果稍有不慎就会不小心覆盖掉之前不想修改的文件,这样我们就需要回滚,但是又不知道具体被修改了那些地方,那么我们就需要一个备份的功能,每次分发文件时,如果有文件被修改,那么就将文件备份到指定目录,这样就算出错,我们也可以把原文件替换回去.</p>
</blockquote>
<hr>
<p>那么我们有2种方法:</p>
<ol>
<li>在minion的配置文件中添加backup_mode: minion</li>
<li>在执行分发文件的states时,添加参数backup: minion</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 借用官网的例子</div><div class="line">/etc/ssh/sshd_config:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://ssh/sshd_config</div><div class="line">    - backup: minion</div></pre></td></tr></table></figure>
<p>当sls 执行时发现sshd_config,被修改了的话,那么salt就会自动帮你备份sshd_config到/var/cache/salt/minion/file_backup(默认路径),并在文件名后面加上具体的日期方便查看.</p>
<p>这样就算我们误操作把原文件覆盖掉,我们也有备份文件可以还原.</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://note.youdao.com/" target="_blank" rel="external">https://docs.saltstack.com/en/latest/ref/states/backup_mode.html#file-state-backups</a></p>

	
	</div>
  <a type="button" href="/2017/10/24/salt-file-backup/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-29 </div>
			<div class="article-title"><a href="/2017/09/29/k-vim/" >k-vim安装配置</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h3 id="安装环境"><a href="#安装环境" class="headerlink" title="安装环境"></a>安装环境</h3><p><strong>本实验在centos7.2环境下执行</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install -y git python-devel.x86_64 the_silver_searcher cmake wget zlib-devel bzip2-devel openssl-devel ncurses-devel sqlite-devel readline-develtk-devel gdbm-devel db4-devel libpcap-devel xz-devel readline</div><div class="line">yum groupinstall -y &apos;Development Tools&apos;</div><div class="line">rpm -Uvh https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm</div></pre></td></tr></table></figure></p>
<h3 id="安装pip"><a href="#安装pip" class="headerlink" title="安装pip"></a>安装pip</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">curl https://bootstrap.pypa.io/get-pip.py -o get-pip.py</div><div class="line">python ./get-pip.py</div><div class="line"></div><div class="line"># pip 设置代理</div><div class="line">1. pip install xxx -i https://pypi.tuna.tsinghua.edu.cn/simple</div><div class="line"></div><div class="line">2. 用户家目录下新建.pip目录 添加pip.conf文件如下</div><div class="line">[global]</div><div class="line">index-url = https://pypi.tuna.tsinghua.edu.cn/simple</div></pre></td></tr></table></figure>
<h3 id="安装pyenv-virtualenv"><a href="#安装pyenv-virtualenv" class="headerlink" title="安装pyenv-virtualenv"></a>安装pyenv-virtualenv</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">curl -L https://raw.githubusercontent.com/yyuu/pyenv-installer/master/bin/pyenv-installer | bash</div><div class="line"></div><div class="line"># 添加到/etc/profile</div><div class="line">export PATH=&quot;~/.pyenv/bin:$PATH&quot;</div><div class="line">eval &quot;$(pyenv init -)&quot;</div><div class="line">eval &quot;$(pyenv virtualenv-init -)&quot;</div><div class="line"></div><div class="line"># soure一下添加到当前环境变量</div><div class="line">source /etc/profile</div></pre></td></tr></table></figure>
<h3 id="安装Python3-6"><a href="#安装Python3-6" class="headerlink" title="安装Python3.6"></a>安装Python3.6</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"># 先添加环境变量  不然后边安装YCM会有坑！！！</div><div class="line">export PYTHON_CONFIGURE_OPTS=&quot;--enable-shared&quot;</div><div class="line">pyenv install  3.6.1</div><div class="line"></div><div class="line"># 安装本地软件包的方法</div><div class="line"># 指定安装URL</div><div class="line">export PYTHON_BUILD_MIRROR_URL=&quot;http://127.0.0.1:8000/&quot;</div><div class="line"># 到含有软件包的目录下运行</div><div class="line">python -m SimpleHTTPServer 8000</div><div class="line"># 然后新开一个终端执行</div><div class="line">pyenv install 3.6.1</div><div class="line"># 这时第一个终端会报错</div><div class="line">&quot;HEAD /a01810ddfcec216bcdb357a84bfaafdfaa0ca42bbdaa4cb7ff74f5a9961e4041 HTTP/1.1&quot; 404 -</div><div class="line"># 然后把python安装包命名为a01810ddfcec216bcdb357a84bfaafdfaa0ca42bbdaa4cb7ff74f5a9961e4041重新安装即可</div><div class="line">mv ./Python-3.6.1.tar.xz  ./a01810ddfcec216bcdb357a84bfaafdfaa0ca42bbdaa4cb7ff74f5a9961e4041</div><div class="line"># 这时候再次安装,pyenv就会到本地下载软件包</div><div class="line">pyenv install 3.6.1</div><div class="line"># 切换到3.6.1版本</div><div class="line">pyenv global 3.6.1</div></pre></td></tr></table></figure>
<h3 id="编译安装vim"><a href="#编译安装vim" class="headerlink" title="编译安装vim"></a>编译安装vim</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"># 编译安装vim是为了让vim支持python3</div><div class="line"># 这里之所以把python2也加进去编译是因为不添加python2支持会导致安装YCM后无法打开vim</div><div class="line">wget ftp://ftp.vim.org/pub/vim/unix/vim-8.0.tar.bz2 -O vim-8.0.tar.bz2</div><div class="line">tar -xvf ./vim-8.0.tar.bz2</div><div class="line">cd ./vim80</div><div class="line">./configure --with-features=huge \</div><div class="line">            --enable-multibyte \</div><div class="line">            --enable-pythoninterp=yes \</div><div class="line">            --with-python-config-dir=/usr/lib64/python2.7/config \</div><div class="line">            --enable-python3interp=yes \</div><div class="line">            --with-python3-config-dir=/root/.pyenv/versions/3.6.1/lib/python3.6/config-3.6m-x86_64-linux-gnu \</div><div class="line">            --enable-gui=gtk3 --enable-cscope --prefix=/data/vim80</div><div class="line"></div><div class="line">make &amp;&amp; make install</div><div class="line"></div><div class="line"># 备份 vi</div><div class="line">mv /usr/bin/vi /usr/bin/vi.bak</div><div class="line">ln -s /data/vim80/bin/vim /usr/bin/vi</div><div class="line"># 检查vim  输出中有+python3即可</div><div class="line">vi --version</div></pre></td></tr></table></figure>
<h3 id="编译安装clang"><a href="#编译安装clang" class="headerlink" title="编译安装clang"></a>编译安装clang</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"># 这里编译clang是为了等下编译YCM作准备. (PS:万恶的YCM)</div><div class="line">wget http://releases.llvm.org/3.3/llvm-3.3.src.tar.gz</div><div class="line">wget http://releases.llvm.org/3.3/cfe-3.3.src.tar.gz</div><div class="line">wget http://releases.llvm.org/3.3/clang-tools-extra-3.3.src.tar.gz</div><div class="line">wget http://releases.llvm.org/3.3/compiler-rt-3.3.src.tar.gz</div><div class="line">wget http://releases.llvm.org/3.3/libcxx-3.3.src.tar.gz</div><div class="line"></div><div class="line"># 分别解压</div><div class="line"></div><div class="line">mv cfe-3.3.src clang</div><div class="line">mv clang/ llvm-3.3.src/tools/</div><div class="line">mv clang-tools-extra-3.3.src extra</div><div class="line">mv extra/ llvm-3.3.src/tools/clang/</div><div class="line">mv compiler-rt-3.3.src compiler-rt</div><div class="line">mv compiler-rt llvm-3.3.src/projects/</div><div class="line"></div><div class="line">mkdir build-3.3</div><div class="line">cd ./build-3.3</div><div class="line"># 编译前换回系统默认的Python版本</div><div class="line">pyenv global system</div><div class="line">../llvm-3.3.src/configure --enable-optimized --enable-targets=host-only</div><div class="line">make -j8</div><div class="line">make install</div></pre></td></tr></table></figure>
<h3 id="安装k-vim"><a href="#安装k-vim" class="headerlink" title="安装k-vim"></a>安装k-vim</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">pip install flake8 yapf</div><div class="line">git clone https://github.com/wklken/k-vim.git k-vim</div><div class="line">cd k-vim</div><div class="line"># 先安装YCM</div><div class="line">mkdir ./bundle</div><div class="line">wget -O YouCompleteMe.tar.gz &quot;http://ohpunyak1.bkt.clouddn.com/YouCompleteMe.tar.gz?v=9999&quot;</div><div class="line">tar -zxvf ./YouCompleteMe.tar.gz</div><div class="line">cd ./YouCompleteMe</div><div class="line">CXX=&quot;/usr/local/bin/clang++&quot; ./install.py</div><div class="line"># 回到 k-vim的目录</div><div class="line">cd ~/k-vim</div><div class="line">sh ./install.sh</div><div class="line"># 这时候依然会报错,但是已经可以用了</div></pre></td></tr></table></figure>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">vi ~/k-vim/vimrc</div><div class="line"># F3 打开目录树 360行左右</div><div class="line">nnoremap &lt;F3&gt; :NERDTreeToggle  &lt;CR&gt;</div><div class="line"></div><div class="line"># 自动插入文件头 600行左右</div><div class="line"># 判断文件类型为py文件则添加一下内容,其他文件同理</div><div class="line">if &amp;filetype == &apos;python&apos;</div><div class="line">    call setline(1,&quot;\#!/usr/bin/env python&quot;)</div><div class="line">    call append(1,strftime(&quot;# %Y-%m-%d %H:%M:%S&quot;))</div><div class="line">    call append(1,&quot;\# arthur:Dear&quot;)</div><div class="line">    call append(1,&quot;\# -*- coding:utf-8 -*-&quot;)</div><div class="line">endif</div><div class="line"></div><div class="line"># 更换主题 660行左右</div><div class="line">&quot; colorscheme solarized</div><div class="line">colorscheme molokai</div><div class="line">&quot; colorscheme desert</div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2017/09/29/k-vim/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-21 </div>
			<div class="article-title"><a href="/2017/09/21/jinja2/" >django中使用jinja2模板</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<ol>
<li>添加env.py文件</li>
<li>添加backend.py文件</li>
<li>修改setting.py配置</li>
</ol>
<blockquote>
<p>env.py文件与backend.py文件添加到app目录下即可</p>
</blockquote>
<hr>
<h3 id="env-py"><a href="#env-py" class="headerlink" title="env.py"></a>env.py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">from django.contrib.staticfiles.storage import staticfiles_storage</div><div class="line">from django.urls import reverse</div><div class="line"></div><div class="line">from jinja2 import Environment</div><div class="line"></div><div class="line"></div><div class="line">def environment(**options):</div><div class="line">    env = Environment(**options)</div><div class="line">    env.globals.update(&#123;</div><div class="line">        &apos;static&apos;: staticfiles_storage.url,</div><div class="line">        &apos;url&apos;: reverse,</div><div class="line">    &#125;)</div><div class="line">    return env</div></pre></td></tr></table></figure>
<h3 id="backend-py"><a href="#backend-py" class="headerlink" title="backend.py"></a>backend.py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">import sys</div><div class="line"></div><div class="line">from django.template.backends import jinja2 as jinja2backend</div><div class="line">from django.template.backends.utils import csrf_input_lazy, csrf_token_lazy</div><div class="line">from django.template import TemplateDoesNotExist, TemplateSyntaxError</div><div class="line">from django.utils.module_loading import import_string</div><div class="line">import jinja2</div><div class="line">import six</div><div class="line"></div><div class="line"></div><div class="line"># Original link:</div><div class="line"># https://code.djangoproject.com/attachment/ticket/24694/24694.py</div><div class="line">__author__ = &apos;carljm&apos;</div><div class="line"></div><div class="line"></div><div class="line">class Jinja2Backend(jinja2backend.Jinja2):</div><div class="line">    def __init__(self, params):</div><div class="line">        self.context_processors = [</div><div class="line">            import_string(p)</div><div class="line">            for p in params[&apos;OPTIONS&apos;].pop(&apos;context_processors&apos;, [])</div><div class="line">        ]</div><div class="line">        super(Jinja2Backend, self).__init__(params)</div><div class="line"></div><div class="line">    def from_string(self, template_code):</div><div class="line">        return Template(</div><div class="line">            self.env.from_string(template_code), self.context_processors)</div><div class="line"></div><div class="line">    def get_template(self, template_name):</div><div class="line">        try:</div><div class="line">            return Template(</div><div class="line">                self.env.get_template(template_name), self.context_processors)</div><div class="line">        except jinja2.TemplateNotFound as exc:</div><div class="line">            six.reraise(TemplateDoesNotExist, TemplateDoesNotExist(exc.args),</div><div class="line">                        sys.exc_info()[2])</div><div class="line">        except jinja2.TemplateSyntaxError as exc:</div><div class="line">            six.reraise(TemplateSyntaxError, TemplateSyntaxError(exc.args),</div><div class="line">                        sys.exc_info()[2])</div><div class="line"></div><div class="line"></div><div class="line">class Template(jinja2backend.Template):</div><div class="line"></div><div class="line">    def __init__(self, template, context_processors):</div><div class="line">        self.template = template</div><div class="line">        self.context_processors = context_processors</div><div class="line"></div><div class="line">    def render(self, context=None, request=None):</div><div class="line">        if context is None:</div><div class="line">            context = &#123;&#125;</div><div class="line">        if request is not None:</div><div class="line">            context[&apos;request&apos;] = request</div><div class="line">            lazy_csrf_input = csrf_input_lazy(request)</div><div class="line">            context[&apos;csrf&apos;] = lambda: lazy_csrf_input</div><div class="line">            context[&apos;csrf_input&apos;] = lazy_csrf_input</div><div class="line">            context[&apos;csrf_token&apos;] = csrf_token_lazy(request)</div><div class="line">            for cp in self.context_processors:</div><div class="line">                context.update(cp(request))</div><div class="line">            print(context)</div><div class="line">        return self.template.render(context)</div></pre></td></tr></table></figure>
<h3 id="settings-py"><a href="#settings-py" class="headerlink" title="settings.py"></a>settings.py</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">TEMPLATES = [ </div><div class="line">      &#123;   </div><div class="line">          &apos;BACKEND&apos;: &apos;django.template.backends.jinja2.Jinja2&apos;,</div><div class="line">          &apos;DIRS&apos;: [os.path.join(BASE_DIR, &apos;templates&apos;)],</div><div class="line">          &apos;APP_DIRS&apos;: True,</div><div class="line">          &apos;OPTIONS&apos;: &#123;</div><div class="line">              &apos;context_processors&apos;: [</div><div class="line">                  &apos;django.template.context_processors.debug&apos;,</div><div class="line">                  &apos;django.template.context_processors.request&apos;,</div><div class="line">                  &apos;django.contrib.auth.context_processors.auth&apos;,</div><div class="line">                  &apos;django.contrib.messages.context_processors.messages&apos;,</div><div class="line">                  &apos;yourappname.env.environment&apos;,</div><div class="line">              ],  </div><div class="line">          &#125;,  </div><div class="line">      &#125;,  </div><div class="line">]</div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2017/09/21/jinja2/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-14 </div>
			<div class="article-title"><a href="/2017/09/14/salt-sls/" >saltstack(四)sls编写</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>sls文件作为saltstack中重要的一环,是必须掌握的</p>
<h1 id="入门篇"><a href="#入门篇" class="headerlink" title="入门篇"></a>入门篇</h1><p>放在入门篇的开始,带大家来了解一下sls的执行顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;minion1&apos; state.sls nginx.install</div></pre></td></tr></table></figure>
<p>这是一个执行sls的命令,那么这个命令会读取那些文件呢?</p>
<ol>
<li>遍历saltstack配置文件里边的file_roots</li>
<li>寻找file_roots 里边的nginx目录</li>
<li>访问java目录下的nginx.sls</li>
</ol>
<p>上面命令执行时,指定了Java目录下的nginx.sls文件,而实际上有时候是可以不指定的,如:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;minion1&apos; state.sls java</div></pre></td></tr></table></figure>
<p>这时候saltstack就会访问到java目录下的init.sls</p>
<hr>
<p>简单的sls编写:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">nginx_install:   # sls_id 不可重复</div><div class="line">  pkg.installed: # 模块方法</div><div class="line">    - pkgs:      # 参数</div><div class="line">      - nginx</div><div class="line"></div><div class="line">nginx_conf:</div><div class="line">  file.managed:</div><div class="line">    - name: /etc/nginx/nginx.conf</div><div class="line">    - source: salt://nginx.conf</div><div class="line">    - require:</div><div class="line">      - pkg: nginx_install</div></pre></td></tr></table></figure></p>
<ul>
<li>:与- 后需要空格</li>
<li>salt:// 想当于master的file_roots目录</li>
<li>多个 - 表示列表</li>
<li>每一级缩进由2个空格组成,不能用Tab</li>
</ul>
<p>就这一个简单的sls就可以安装nginx,并把nginx.conf替换成预先写好的配置文件</p>
<p>而再看一下这个:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">nginx:</div><div class="line">  pkg.installed:</div><div class="line"></div><div class="line">/etc/nginx/nginx.conf:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://nginx.conf</div><div class="line">    - require:</div><div class="line">      - pkg: nginx_install</div></pre></td></tr></table></figure></p>
<p>这次的代码对比上面, - pkgs 和 - names 的内容不见了,相反把sls_id 的名字分别改成了nginx<br>和/etc/nginx/nginx.conf</p>
<p>这样写和上面的效果是一样的,当sls执行需要指定名字是,如果sls里边没有定义,那么默认会用sls_id的值</p>
<p>至于更多的模块方法可以到官网去找到<a href="https://docs.saltstack.com/en/latest/contents.html" target="_blank" rel="external">saltstack官网</a></p>
<h3 id="引入其他sls文件"><a href="#引入其他sls文件" class="headerlink" title="引入其他sls文件"></a>引入其他sls文件</h3><p>include 就像nginx一样,include表示包含某个文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">include:</div><div class="line">  - nginx.install</div><div class="line">  - nginx.config</div></pre></td></tr></table></figure>
<p>这样我们就在文件中引入了nginx目录下的install.sls(sls忽略不写了)和nginx.config.sls文件了</p>
<h3 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h3><p>经常会听到别人说sls执行时是无序的,那么我们怎么做才能使得sls安装我们预期来执行呢?</p>
<ol>
<li>include引入的文件会被先执行</li>
<li>每个sls定义时可以定义order值,order值从小到大执行</li>
<li>按照依赖关系执行</li>
</ol>
<p>下面看看order的用法,至于依赖关系,可以看回文章开始时的使用,分辨出require与require_in的作用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">nginx:</div><div class="line">  pkg:</div><div class="line">  - installed</div><div class="line">  - order: 1</div><div class="line"></div><div class="line">/etc/nginx/nginx.conf:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://nginx.conf</div><div class="line">    - require:</div><div class="line">      - pkg: nginx_install</div><div class="line">    - order: 2</div></pre></td></tr></table></figure></p>
<h1 id="进阶篇"><a href="#进阶篇" class="headerlink" title="进阶篇"></a>进阶篇</h1><p>在知道了更多的模块方法后,我们基本可以用sls来完成大部分事情,但这还不能满足我们,下面再来看看一些关于sls的小技巧</p>
<h3 id="jinja"><a href="#jinja" class="headerlink" title="jinja"></a>jinja</h3><p>在sls的文件中,我们还可以使用用jinja语法来控制sls执行,或者配置文件等</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;% if grins[os] == &apos;Centos&apos; %&#125;</div><div class="line"></div><div class="line">nginx:</div><div class="line">  pkg.installed:</div><div class="line"></div><div class="line">/etc/nginx/nginx.conf:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://nginx.conf</div><div class="line">    - require:</div><div class="line">      - pkg: nginx_install</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
<p>一个十分简单的例子,但这并不能说明jinja的强大,除了if还有set,for,marco等等,jinja的强大之处还需要大家独自去领悟</p>
<h3 id="引用外部变量"><a href="#引用外部变量" class="headerlink" title="引用外部变量"></a>引用外部变量</h3><p>知道了jinja控制和引用变量之后也都不能满足与所有需求,有时候我们需要在执行时来定义变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;minion1&apos; state.sls nginx.install pillar=&apos;&#123;&quot;version&quot;:&quot;1.13.4&quot;&#125;&apos;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">nginx:</div><div class="line">  pkg.installed:</div><div class="line">&#123;% if pillar[&quot;version&quot;] %&#125;</div><div class="line">  - version: &#123;&#123; pillar[&quot;version&quot;] &#125;&#125;</div><div class="line">&#123;% endif %&#125;</div></pre></td></tr></table></figure>
<p>当然我们并不会每次都在执行命令时附带参数,我们可以把pillar,grains的数据预先设定好.下面来看看如何引入其他变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;% set files = salt[&apos;cmd.run&apos;](&quot;ls /data&quot;,&quot;default&quot;) %&#125;</div><div class="line"></div><div class="line">echo_files_name:</div><div class="line">  cmd.run:</div><div class="line">    - names:</div><div class="line">&#123;% for file in files %&#125;</div><div class="line">      - echo &#123;&#123; file &#125;&#125;</div><div class="line">&#123;% endfor %&#125;</div></pre></td></tr></table></figure>
<ul>
<li>salt 固定写法</li>
<li>[‘cmd.run’] 表示执行cmd.run方法</li>
<li>ls /data 表示执行命令</li>
<li>“default” 最后的空字符代表默认值</li>
</ul>
<p>这种方法可以执行大部分salt命令来获取返回值,然后传入到sls文件中执行</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>有时候由于编写的sls文件太大,想测试一下刚添加进去的功能需要执行很久.</p>
<p>其实可以通过sls_id方法来执行sls文件内的某个方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;minion1&apos; state.sls_id nginx_install nginx.install</div></pre></td></tr></table></figure>
<p>这时候saltstack只会执行nginx.install.sls里边的nginx_install,而不会执行其他,但是我们要注意它的依赖关系</p>
<h3 id="配置文件管理"><a href="#配置文件管理" class="headerlink" title="配置文件管理"></a>配置文件管理</h3><p>在很多时候,我们需要统一管理配置文件,但是每台机器的配置信息又不一样,我们想根据每一台机的具体配置来定义应用的配置文件</p>
<p>通过saltstack file模块管理的文件,其实也可以使用jinja来获取,定义变量的</p>
<p>下面来看一份postgres配置,由于配置过长,删减了部分<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">listen_addresses = &apos;*&apos;</div><div class="line">max_connections = &#123;&#123; conn &#125;&#125;</div><div class="line">&#123;% if ((grains.mem_total|int) / 4)|round|int &lt;= 8096 -%&#125;</div><div class="line">shared_buffers = &#123;&#123; ((grains.mem_total|int) / 4)|round|int &#125;&#125;MB</div><div class="line">&#123;% else -%&#125;</div><div class="line">shared_buffers = 4GB</div><div class="line">&#123;% endif -%&#125;</div><div class="line">work_mem = &#123;&#123; ((grains.mem_total|int) / conn * 2) |round|int &#125;&#125;MB</div><div class="line">&#123;% if ((grains.mem_total|int) / 16)|round|int &lt;= 2048 -%&#125;</div><div class="line">maintenance_work_mem = &#123;&#123; ((grains.mem_total|int) / 16)|round|int &#125;&#125;MB</div><div class="line">&#123;% else -%&#125;</div><div class="line">maintenance_work_mem = 2GB</div><div class="line">&#123;% endif -%&#125;</div><div class="line">temp_buffers = &#123;&#123; ((grains.mem_total|int) / conn) |round|int &#125;&#125;MB</div><div class="line">checkpoint_completion_target = 0.9</div><div class="line">effective_cache_size = &#123;&#123; (((grains.mem_total|int) * 3) / 4)|round|int &#125;&#125;MB</div></pre></td></tr></table></figure></p>
<p>可以看到,配置文件内大量使用了granis来读取机器的配置信息,从而动态生产配置文件,这样所有的服务器都可以共用一份配置文件.</p>

	
	</div>
  <a type="button" href="/2017/09/14/salt-sls/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-12 </div>
			<div class="article-title"><a href="/2017/09/12/salt-ssh/" >slatstack(三)salt-ssh批量安装minion</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>saltstack 对比 ansible</strong> </p>
<blockquote>
<p>最大的不同就是saltstack使用的是c/s架构,即要安装minion才能访问客户端,而ansible则是使用ssh协议访问.不得不说,有一部分人就是因为觉得saltstack需要安装客户端,感觉很麻烦而选用了ansible.那么下面来说说salt如何通过salt-ssh来安装minion</p>
</blockquote>
<h1 id="salt-ssh"><a href="#salt-ssh" class="headerlink" title="salt-ssh"></a>salt-ssh</h1><p>salt-ssh 并没有包含在salt-master中,所以需要单独安装<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install salt-ssh</div></pre></td></tr></table></figure></p>
<h3 id="前提条件"><a href="#前提条件" class="headerlink" title="前提条件"></a>前提条件</h3><p>salt-ssh 使用的前提条件就是roster,只有配置了roster文件后才能使用salt-ssh对机器进行操作</p>
<p>下面来看一个roster文件的配置<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">test1:</div><div class="line"> host: 192.168.1.101</div><div class="line"> user: salt</div><div class="line"> passwd: redhat</div><div class="line"> minion_opts:</div><div class="line">   - id: test1</div></pre></td></tr></table></figure></p>
<p>第1行test1: 表示该机器被salt-ssh识别到的id<br>第2-4行host: 指定机器的IP地址,用户,密码,用于ssh连接<br>第5行minion_opts: 表示执行命令时传递的参数</p>
<p><strong>如果客户端IP没有在master的known_hosts文件中,需要先添加上去</strong></p>
<p>测试连接是否成功<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt-ssh -i 'test1' test.ping</div></pre></td></tr></table></figure></p>
<h3 id="编写安装minion的sls"><a href="#编写安装minion的sls" class="headerlink" title="编写安装minion的sls"></a>编写安装minion的sls</h3><p>既然已经连接上客户端,那么只需要在客户端上装上minion并启动就好了</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#</span>同步yum的repo</div><div class="line">minion_yum:</div><div class="line">  file.recurse:</div><div class="line">    - name: /etc/yum.repos.d</div><div class="line">    - source: salt://minions/yum.repos.d ##提前准备的yum文件路径</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - file_mode: 644</div><div class="line">    - dir_mode: 755</div><div class="line">    - include_empty: True</div><div class="line">    - unless: test -e /etc/yum.repos.d/epel_aliyun.repo</div><div class="line"></div><div class="line"><span class="meta">#</span>安装minion</div><div class="line">minion_install:</div><div class="line">  pkg.installed:</div><div class="line">    - pkgs:</div><div class="line">      - salt-minion</div><div class="line">    - skip_verify: True</div><div class="line">    - require:</div><div class="line">      - file: minion_yum</div><div class="line">    - unless: rpm -qa | grep salt-minion</div><div class="line"></div><div class="line"><span class="meta">#</span>同步minion的配置文件</div><div class="line">minion_conf:</div><div class="line">  file.managed:</div><div class="line">    - name: /etc/salt/minion</div><div class="line">    - source: salt://minions/minion.conf  ##minion端需要配置的minion主配置文件</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - mode: 640</div><div class="line">    - template: jinja</div><div class="line">    - defaults:</div><div class="line">       minion_id: &#123;&#123; grains['id'] &#125;&#125;</div><div class="line">    - require:</div><div class="line">      - pkg: minion_install</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">#</span>启动minion</div><div class="line">minion_service:</div><div class="line">  service.running:</div><div class="line">    - name: salt-minion</div><div class="line">    - enable: True</div><div class="line">    - require:</div><div class="line">      - file: minion_conf</div></pre></td></tr></table></figure>
<p><strong>文件需要自行准备,并放到salt root目录下</strong></p>
<p>minion的主要配置,其他可以自行修改<br><figure class="highlight shell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">id: &#123;&#123; minion_id &#125;&#125; </div><div class="line">master: 192.168.1.100</div></pre></td></tr></table></figure></p>
<blockquote>
<p>执行完sls后,就可以到master上通过salt-key 直接添加minion进行管理</p>
</blockquote>
<h1 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h1><ol>
<li>通过kickstart批量安装centos</li>
<li>通过Python脚本批量修改服务器IP</li>
<li>master批量插入主机信息到roster</li>
<li>salt-ssh 安装minion 进行管理</li>
</ol>
<h3 id="kickstart批量安装centos"><a href="#kickstart批量安装centos" class="headerlink" title="kickstart批量安装centos"></a>kickstart批量安装centos</h3><ol>
<li><a href="http://www.cnblogs.com/mchina/p/centos-pxe-kickstart-auto-install-os.html" target="_blank" rel="external">安装</a></li>
<li><a href="http://www.cnphp.info/quick-install-centos-6-0-with-kickstart.html" target="_blank" rel="external">配置脚本</a></li>
</ol>
<h3 id="批量插入主机信息到roster"><a href="#批量插入主机信息到roster" class="headerlink" title="批量插入主机信息到roster"></a>批量插入主机信息到roster</h3><p>为了更加方便,所以配置kickstart时,网络可以选择是dhcp模式,这样安装完系统之后就可以上网</p>
<p>master端<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> BaseHTTPRequestHandler, HTTPServer</div><div class="line"></div><div class="line">template = <span class="string">'''</span></div><div class="line"><span class="string">&#123;id&#125;:</span></div><div class="line"><span class="string">  host: &#123;ip&#125;</span></div><div class="line"><span class="string">  user: root</span></div><div class="line"><span class="string">  passwd: password</span></div><div class="line"><span class="string">  minion_opts:</span></div><div class="line"><span class="string">    - id: &#123;id&#125;</span></div><div class="line"><span class="string">'''</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RequestHandler</span><span class="params">(BaseHTTPRequestHandler)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_POST</span><span class="params">(self)</span>:</span></div><div class="line">        response = self.rfile.read(int(self.headers[<span class="string">'content-length'</span>]))</div><div class="line">        self.send_response(<span class="number">200</span>)</div><div class="line">        self.send_header(<span class="string">'Content-Type'</span>, <span class="string">'application/json'</span>)</div><div class="line">        self.end_headers()</div><div class="line">        self.data_parse(response)</div><div class="line">        self.do_insert(self.data)</div><div class="line">        result = (<span class="string">'data: %s, send OK\n'</span> % response).encode(<span class="string">'ascii'</span>)</div><div class="line">        self.wfile.write(result)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">do_insert</span><span class="params">(self, data)</span>:</span></div><div class="line">        <span class="keyword">with</span> open(<span class="string">r'/etc/salt/roster'</span>, <span class="string">'a'</span>) <span class="keyword">as</span> f:</div><div class="line">            f.write(data + <span class="string">'\n'</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data_parse</span><span class="params">(self, data)</span>:</span></div><div class="line">        print(data)</div><div class="line">        data = json.loads(data.decode(<span class="string">'utf-8'</span>))</div><div class="line">        print(data)</div><div class="line">        self.data = template.format(id=data[<span class="string">'id'</span>], ip=data[<span class="string">'ip'</span>])</div><div class="line">        print(self.data)</div><div class="line">        <span class="keyword">return</span> self.data</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span><span class="params">()</span>:</span></div><div class="line">    server_address = (<span class="string">''</span>, <span class="number">8099</span>)</div><div class="line">    httpd = HTTPServer(server_address, RequestHandler)</div><div class="line">    httpd.serve_forever()</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    main()</div></pre></td></tr></table></figure></p>
<p>minion端<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ip=`ifconfig | grep <span class="string">'inet'</span> |grep -v <span class="string">'127.0.0.1'</span>|grep -v inet6 | sed <span class="string">'s/^[ \t]*//g'</span>|cut -d<span class="string">" "</span> -f2`</div><div class="line">hostname=`hostname`</div><div class="line">data=&#123;<span class="string">"id"</span>:<span class="string">"$hostname"</span>, <span class="string">"ip"</span>:$ip&#125;</div><div class="line">curl -X POST -d <span class="string">'&#123;"id":"'</span>$hostname<span class="string">'", "ip":"'</span>$ip<span class="string">'"&#125;'</span> <span class="string">"http://127.0.0.1:8099"</span></div></pre></td></tr></table></figure></p>

	
	</div>
  <a type="button" href="/2017/09/12/salt-ssh/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-12 </div>
			<div class="article-title"><a href="/2017/09/12/optimization/" >python之代码优化</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="代码的基本优化-调试"><a href="#代码的基本优化-调试" class="headerlink" title="代码的基本优化,调试"></a>代码的基本优化,调试</h1><h3 id="构造与初始化方法"><a href="#构造与初始化方法" class="headerlink" title="构造与初始化方法"></a>构造与初始化方法</h3><ul>
<li><strong>init</strong>() 不是构造方法，它负责控制对象变量的初始化</li>
<li><strong>new</strong>() 才是构造方法，它负责控制对象的创建</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__new__</span><span class="params">(cls)</span>:</span></div><div class="line">    print(<span class="string">'正在创建类'</span>)</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(cls)</span>:</span></div><div class="line">    print(<span class="string">'类已经被创建'</span>)</div><div class="line">    print(<span class="string">'正在初始化类变量'</span>)</div><div class="line"></div><div class="line">a = A()</div></pre></td></tr></table></figure>
<h3 id="对象序列化"><a href="#对象序列化" class="headerlink" title="对象序列化"></a>对象序列化</h3><ul>
<li>json：最常见，效率稍差，但跨平台、跨语言、结构好</li>
<li>pickle：比json效率稍微高一点点，只支持Python</li>
<li>cPickle：效率比上述两者都高很多</li>
<li>protobuf：Google提供的第三方库，效率更高，跨平台，跨语言，结构紧凑体积小，内存节省和传输效率更好，<br>但需引入第三方库，提前设计好的数据结构不可随意改动</li>
</ul>
<p>在序列化还没成为程序的瓶颈时,一般来说使用json就可以满足大部分需求.</p>
<p>序列化：是把对象转换成可以write到文件里边的数字、字符、字符串<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">dict1 = &#123;<span class="string">'key%i'</span> % i:<span class="string">'value%i'</span> % i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>)&#125;</div><div class="line">f = open(<span class="string">r'C:\Users\Dear\Desktop\test.txt'</span>,<span class="string">'ab'</span>)</div><div class="line"></div><div class="line">json.dump(d,f) <span class="comment">#直接写入文件</span></div><div class="line">j = json.dumps(dict1) <span class="comment">#把dict1 转换成json格式</span></div><div class="line">d = json.loads(j) <span class="comment"># 把j反序列化为dict格式</span></div><div class="line"></div><div class="line"></div><div class="line">pickle.dump(dict1,f) <span class="comment">#直接写入文件</span></div><div class="line">p = pickle.dumps(d)  <span class="comment">#输出序列化后的二进制字符串</span></div><div class="line">d = pickle.loads(p) <span class="comment"># 把p反序列化为dict格式</span></div><div class="line"></div><div class="line"></div><div class="line">f.close()</div></pre></td></tr></table></figure></p>
<h3 id="配置文件解析"><a href="#配置文件解析" class="headerlink" title="配置文件解析"></a>配置文件解析</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line"><span class="string">configparser INI风格</span></div><div class="line"><span class="string">文本形式类似 key value</span></div><div class="line"><span class="string">'''</span></div><div class="line"></div><div class="line">[db]</div><div class="line">db_host = <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></div><div class="line">db_port = <span class="number">22</span></div><div class="line">db_user = root</div><div class="line">db_pass = rootroot</div><div class="line"></div><div class="line">[concurrent]</div><div class="line">thread = <span class="number">10</span></div><div class="line">processor = <span class="number">20</span></div><div class="line"><span class="string">'''</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">conf = configparser.ConfigParser()</span></div><div class="line"><span class="string">conf.read(r'C:\Users\Dear\Desktop\default.conf')</span></div><div class="line"><span class="string">conf.sections() --&gt; ['db', 'concurrent']</span></div><div class="line"><span class="string">conf.options('db') --&gt; ['db_host', 'db_port', 'db_user', 'db_pass']</span></div></pre></td></tr></table></figure>
<h3 id="多个分支条件"><a href="#多个分支条件" class="headerlink" title="多个分支条件"></a>多个分支条件</h3><ul>
<li>if…elif…elif…</li>
<li>借助字典消除这种风格</li>
<li>实在消除不掉注意先后顺序安排(在可读性差不多的情况下,尽量把匹配率高的条件写在前面)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 需求需要多重判断,实现类似与其他语言中switch case的效果</span></div><div class="line"></div><div class="line">ansers_dict = &#123;</div><div class="line">          <span class="string">'a'</span> : <span class="number">1</span>,</div><div class="line">          <span class="string">'b'</span> : <span class="number">2</span>,</div><div class="line">          <span class="string">'c'</span> : <span class="number">3</span>,</div><div class="line">          <span class="string">'d'</span> : <span class="number">4</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">question = (<span class="string">'人有多少个鼻子?'</span>)</div><div class="line">print(ansers_dict)</div><div class="line"><span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">  anser = read(<span class="string">'请选择 a,b,c,d中的一个'</span>)</div><div class="line">  <span class="keyword">if</span> anser <span class="keyword">in</span> ansers_dict:</div><div class="line">    print(<span class="string">'你选择的是%s,人有%s个鼻子'</span>, % (anser,ansers_dict[anser]))</div><div class="line">    <span class="keyword">break</span></div></pre></td></tr></table></figure>
<h3 id="短路运算"><a href="#短路运算" class="headerlink" title="短路运算"></a>短路运算</h3><ul>
<li>and：前一个表达式为假不再进行后一个表达式的计算</li>
<li>or：前一个表达式为真不再进行后一个表达式的计算</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># and</span></div><div class="line">timeit.timeit('if 0 and 1 : pass',number=100000000) --&gt; 1.397503963655573</div><div class="line">timeit.timeit('if 1 and 0 : pass',number=100000000) --&gt; 2.149041756294938</div><div class="line"></div><div class="line"><span class="comment"># or</span></div><div class="line">timeit.timeit('if 1 or 0 : pass',number=100000000)  --&gt; 1.587524198216385</div><div class="line">timeit.timeit('if 0 or 1 : pass',number=100000000)  --&gt; 2.823067097259937</div></pre></td></tr></table></figure>
<h3 id="成员测试"><a href="#成员测试" class="headerlink" title="成员测试"></a>成员测试</h3><p>判断一个元素是否在某个容器（列表、集合、字典、字符串序列）时，直接用 in 或 not in 操作符判断，无需用 find 、 index 等方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">timeit.timeit('list1 = [i for i in range(1000,1010)];list1.index(1005)',number=10000000) --&gt; 11.784954835659846</div><div class="line">timeit.timeit('list1 = [i for i in range(1000,1010)];1005 in list1 ',number=10000000) --&gt; 9.56750599126508</div></pre></td></tr></table></figure>
<h3 id="内置排序"><a href="#内置排序" class="headerlink" title="内置排序"></a>内置排序</h3><ul>
<li>sort(): 只是 list 的一个方法，直接修改原列表，返回值为None</li>
<li>sorted(): 可排序所有可迭代对象，返回排序后的结果</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">list1 = [<span class="number">3</span>,<span class="number">41</span>,<span class="number">2</span>,<span class="number">5</span>,<span class="number">1</span>]</div><div class="line"></div><div class="line">new_list = sorted(list1)</div><div class="line">print(list1) --&gt; [3,41,2,5,1]</div><div class="line">print(new_list) --&gt; [1,2,3,5,41]</div><div class="line"></div><div class="line">list1.sort()</div><div class="line">print(list1) --&gt; [1,2,3,5,41]</div></pre></td></tr></table></figure>
<h3 id="list、tuple、set选择"><a href="#list、tuple、set选择" class="headerlink" title="list、tuple、set选择"></a>list、tuple、set选择</h3><ul>
<li>list：有序、可变长、元素可重复</li>
<li>tuple：有序、不可变长、元素可重复</li>
<li>set：无序、可变长、元素不可重复</li>
</ul>
<p>拒绝万年list,拒绝万年list,拒绝万年list,</p>
<p>一般来说:<br>长度,元素不可变的情况下 选tuple<br>对顺序无要求,元素不可重复的情况下,选set<br>其他情况下才考虑list</p>
<h3 id="避免命名空间污染"><a href="#避免命名空间污染" class="headerlink" title="避免命名空间污染"></a>避免命名空间污染</h3><p>尽量使用 import a.B 的形式，而不是使用 from a import B</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> a <span class="keyword">import</span> B</div><div class="line"><span class="keyword">import</span> a.b</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">b</span>:</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">b(1) --&gt; Error</div><div class="line">a.b(1) --&gt; Sucess</div></pre></td></tr></table></figure>
<h3 id="True-amp-False"><a href="#True-amp-False" class="headerlink" title="True &amp; False"></a>True &amp; False</h3><p>python2.x 中 if True 会比 if 1 慢<br>python3.x 中 没有这个问题</p>
<p>python2.x 中 True相当于一个指向1的变量,使用True时 需要先把内存中的1提取出来再做判断</p>
<p>#python2.x<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; def func():</div><div class="line">...   if 1:</div><div class="line">...     pass</div><div class="line">...</div><div class="line">&gt;&gt;&gt; def func2():</div><div class="line">...   if True:</div><div class="line">...     pass</div><div class="line">...</div><div class="line">&gt;&gt;&gt; dis.dis(func)</div><div class="line">  3           0 LOAD_CONST               0 (None)</div><div class="line">              3 RETURN_VALUE</div><div class="line">&gt;&gt;&gt; dis.dis(func2)</div><div class="line">  2           0 LOAD_GLOBAL              0 (True)   </div><div class="line">              3 POP_JUMP_IF_FALSE        9</div><div class="line"></div><div class="line">  3           6 JUMP_FORWARD             0 (to 9)</div><div class="line">        &gt;&gt;    9 LOAD_CONST               0 (None)</div><div class="line">             12 RETURN_VALUE</div></pre></td></tr></table></figure></p>
<p>#python3.x<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; import dis</div><div class="line">&gt;&gt;&gt; def func():</div><div class="line">...   if 1:</div><div class="line">...     pass</div><div class="line">...</div><div class="line">&gt;&gt;&gt; def func2():</div><div class="line">...   if True:</div><div class="line">...     pass</div><div class="line">...</div><div class="line">&gt;&gt;&gt; dis.dis(func)</div><div class="line">  3           0 LOAD_CONST               0 (None)</div><div class="line">              2 RETURN_VALUE</div><div class="line">&gt;&gt;&gt; dis.dis(func2)</div><div class="line">  3           0 LOAD_CONST               0 (None)</div><div class="line">              2 RETURN_VALUE</div></pre></td></tr></table></figure></p>
<h3 id="变量值交换"><a href="#变量值交换" class="headerlink" title="变量值交换"></a>变量值交换</h3><p>推荐使用 x, y = y, x<br>性能更快且可读性高</p>
<h3 id="上下文管理器"><a href="#上下文管理器" class="headerlink" title="上下文管理器"></a>上下文管理器</h3><p>尽量使用 with…as… 来实现对象的上下文管理，避免忘记显式地关闭资源<br>with 结束时 系统会自动关闭打开的对象<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"># 写一个可用于上下文管理的对象</div><div class="line"># __enter__()  open时触发</div><div class="line"># __exit__()  with 结束时触发</div><div class="line"></div><div class="line">class WithTest:</div><div class="line">  def __enter__(self):</div><div class="line">    print(&apos;start&apos;)</div><div class="line">    self.file = open(&apos;myfile&apos;)</div><div class="line">    return self.file</div><div class="line">  def __exit__(self, *args):</div><div class="line">    print(&apos;end&apos;)</div><div class="line">    return True</div><div class="line"></div><div class="line">wt = WithTest()</div><div class="line"></div><div class="line">with a as file:</div><div class="line">  file.readlines()</div></pre></td></tr></table></figure></p>
<h3 id="字符串连接"><a href="#字符串连接" class="headerlink" title="字符串连接"></a>字符串连接</h3><ul>
<li>join 与 + 两种方式</li>
<li>前者更省内存</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">list1 = [<span class="string">'a'</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>)]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">  s = <span class="string">''</span>.join(list1)</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span>:</span></div><div class="line">  s = <span class="string">''</span></div><div class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> list1:</div><div class="line">    s += i</div><div class="line"></div><div class="line">timeit.timeit(func,number=10000) --&gt; 4.525133861871087</div><div class="line">timeit.timeit(func2number=10000) --&gt;</div></pre></td></tr></table></figure>
<h3 id="深浅拷贝"><a href="#深浅拷贝" class="headerlink" title="深浅拷贝"></a>深浅拷贝</h3><ul>
<li>浅拷贝 copy.copy(obj) 只拷贝“第一层”对象</li>
<li>深拷贝 copy.deepcopy(obj) 递归拷贝“每一层”对象</li>
<li>不论深浅拷贝，不会为 全由不可变对象组成的对象 申请新内存空间</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#深、浅拷贝</span></div><div class="line">l = [<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,[<span class="string">'d'</span>]]</div><div class="line">l1 = copy.copy(l)</div><div class="line">l2 = copy.deepcopy(l)</div><div class="line"></div><div class="line">l is l1  --&gt; False</div><div class="line">l is l2  --&gt; False</div><div class="line"></div><div class="line">l[3] is l1[3] --&gt; True</div><div class="line">l[3] is l2[3] --&gt; False</div><div class="line"></div><div class="line"><span class="comment">#浅拷贝只会拷贝第一层对象,而对于深层的对象 引用的还是原来的内存地址的值</span></div><div class="line"><span class="comment">#深拷贝会进行递归拷贝,拷贝出来的对象与原对象除了值一样,没有其他关系</span></div><div class="line"></div><div class="line">l[<span class="number">-1</span>][<span class="number">0</span>] = <span class="string">'e'</span></div><div class="line">print(l)  --&gt; ['a', 'b', 'c', ['e']]</div><div class="line">print(l1) --&gt; ['a', 'b', 'c', ['e']]</div><div class="line">print(l2) --&gt; ['a', 'b', 'c', ['d']]</div><div class="line"></div><div class="line"><span class="comment">#不论深浅拷贝，不会为 全由不可变对象组成的对象 申请新内存空间</span></div><div class="line"></div><div class="line">t = (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</div><div class="line">id(t) --&gt; 46640872</div><div class="line">t1 = copy.copy(t)</div><div class="line">id(t1) --&gt; 46640872</div><div class="line">t2 = copy.deepcopy(t)</div><div class="line">id(t2) --&gt; 46640872</div></pre></td></tr></table></figure>
<h3 id="节省内存开销"><a href="#节省内存开销" class="headerlink" title="节省内存开销"></a>节省内存开销</h3><ul>
<li>生成器惰性求值，只迭代一遍</li>
<li>f = open(‘filename’); “for line in f”  vs for line in f.readlines()</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">list1 = [i <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>)]</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> list1:</div><div class="line">   <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> list1:</div><div class="line">    <span class="keyword">yield</span> i</div><div class="line"></div><div class="line">timeit.timeit(func,number=1000) --&gt; 0.9298560397275537</div><div class="line">timeit.timeit(func,number=1000) --&gt; 0.0002835632612345762</div></pre></td></tr></table></figure>
<h3 id="循环优化"><a href="#循环优化" class="headerlink" title="循环优化"></a>循环优化</h3><ul>
<li>尽量减少循环体内操作</li>
<li>尽量减少循环嵌套层数</li>
<li>大多数情况下大循环放在更里层效率更高</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>):</div><div class="line">      <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span><span class="params">()</span>:</span></div><div class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100000</span>):</div><div class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</div><div class="line">      <span class="keyword">pass</span></div><div class="line"></div><div class="line">timeit.timeit(func,number=1000) --&gt; 20.439412046114683</div><div class="line">timeit.timeit(func2,number=1000) --&gt; 38.57239906224004</div><div class="line"></div><div class="line">- 时间局部性: 如果一个信息项正在被访问，那么在近期它很可能还会被再次访问。</div><div class="line">- 空间局部性: 在最近的将来将用到的信息很可能与现在正在使用的信息在空间地址上是临近的。</div></pre></td></tr></table></figure>
<h3 id="变量命名空间"><a href="#变量命名空间" class="headerlink" title="变量命名空间"></a>变量命名空间</h3><ul>
<li>能使用局部变量就不要使用全局变量</li>
<li>能放在循环更外层的就不要放到循环更里层</li>
<li>最小权限原则</li>
</ul>
<blockquote>
</blockquote>

	
	</div>
  <a type="button" href="/2017/09/12/optimization/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-12 </div>
			<div class="article-title"><a href="/2017/09/12/async/" >python之异步编程</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h1 id="线-进程池"><a href="#线-进程池" class="headerlink" title="线/进程池"></a>线/进程池</h1><p>python 3.2开始在标准库中新增了concurrent.futures模块,它主要提供了’ProcessPoolExecutor’, ‘ThreadPoolExecutor’ 两个类,提供了线/进程池的支持</p>
<p>它们的使用方法相同:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">with</span> ProcessPoolExecutor(max_workers) <span class="keyword">as</span> pool:</div><div class="line">    pool.submit(task, args) <span class="comment"># 返回Future对象</span></div><div class="line">    pool.running() <span class="comment"># 判断task是否在运行</span></div><div class="line">    pool.done() <span class="comment"># 判断task是否执行完成</span></div><div class="line">    pool.result() <span class="comment"># 获取task的返回值 (阻塞)</span></div><div class="line">    pool.map(task, iterable) <span class="comment"># 迭代iterable,并当作参数传到task执行(有序)</span></div></pre></td></tr></table></figure></p>
<ol>
<li>pool.submit 会返回Future对象</li>
<li>Future:可以简单理解为是未来将会完成的操作</li>
<li>异步编程就是把需要等待的操作变成future,而释放CPU去执行其它代码</li>
</ol>
<h1 id="初涉异步"><a href="#初涉异步" class="headerlink" title="初涉异步"></a>初涉异步</h1><h1 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h1><ul>
<li>阻塞:程序在等待某个操作完成期间，自身无法继续干别的事情，则称该程序在该操作上是阻塞的。</li>
<li>非阻塞:程序在等待某操作过程中，自身不被阻塞，可以继续运行干别的事情，则称该程序在该操作上是非阻塞的。</li>
<li>同步:不同程序单元为了完成某个任务，在执行过程中需靠某种通信方式以协调一致，称这些程序单元是同步执行的。</li>
<li>异常:为完成某个任务，不同程序单元之间过程中无需通信协调，也能完成任务的方式。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">import</span> time</div><div class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, ProcessPoolExecutor</div><div class="line"></div><div class="line"></div><div class="line">urls = [</div><div class="line">    <span class="string">'https://www.duanwenxue.com/article/4642780.html'</span>,</div><div class="line">    <span class="string">'https://www.duanwenxue.com/article/4642781.html'</span>,</div><div class="line">    <span class="string">'https://www.duanwenxue.com/article/4642782.html'</span>,</div><div class="line">    <span class="string">'https://www.duanwenxue.com/article/4642783.html'</span>,</div><div class="line">    <span class="string">'https://www.duanwenxue.com/article/4642784.html'</span>,</div><div class="line">    <span class="string">'https://www.duanwenxue.com/article/4642785.html'</span>,</div><div class="line">    <span class="string">'https://www.duanwenxue.com/article/4642786.html'</span>,</div><div class="line">    <span class="string">'https://www.duanwenxue.com/article/4642787.html'</span>,</div><div class="line">    <span class="string">'https://www.duanwenxue.com/article/4642788.html'</span>,</div><div class="line">]</div><div class="line"></div><div class="line">domain = <span class="string">'duanwenxue.com'</span></div><div class="line"></div><div class="line"><span class="comment"># 同步阻塞</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">blocking_way</span><span class="params">(url)</span>:</span></div><div class="line">    sock = socket.socket()</div><div class="line">    sock.connect((domain, <span class="number">80</span>))</div><div class="line">    request = <span class="string">'GET &#123;0&#125; HTTP/1.0\r\nHost: &#123;1&#125;\r\n\r\n'</span>.format(url, domain)</div><div class="line">    sock.send(request.encode(<span class="string">'ascii'</span>))</div><div class="line">    response = <span class="string">b''</span></div><div class="line">    block = sock.recv(<span class="number">4096</span>)</div><div class="line">    <span class="keyword">while</span> block:</div><div class="line">        response += block</div><div class="line">        block = sock.recv(<span class="number">4096</span>)</div><div class="line">    <span class="keyword">return</span> response</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">asyn_way</span><span class="params">()</span>:</span></div><div class="line">    start = time.time()</div><div class="line">    response = []</div><div class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls:</div><div class="line">        response.append(blocking_way(url))</div><div class="line">    <span class="comment"># use 1.8566324710845947</span></div><div class="line">    print(time.time() - start)</div><div class="line">    <span class="keyword">return</span> response</div></pre></td></tr></table></figure>
<p>因为socket需要3次握手成功才能建立起连接,而3次握手的过程中,需要通过网络来传递信息,这需要的时间是不确定的,socket连接是会一直阻塞进程,直至3次握手成功,才继续执行下面的代码.<br>但是,如果对方服务器出现网络问题,而无法握手成功,那么socket就会一直阻塞,直至timeout,即使网络通畅,socket连接仍然需要不短时间<br>这时程序处理请求需要很长时间,假如处理1个请求要1秒,那么处理10个请求就需要10秒</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 多进程</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">multiproc_way</span><span class="params">()</span>:</span></div><div class="line">    start = time.time()</div><div class="line">    <span class="keyword">with</span> ProcessPoolExecutor(<span class="number">10</span>) <span class="keyword">as</span> executor:</div><div class="line">        proc_pool = &#123;executor.submit(blocking_way, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls&#125;</div><div class="line">    <span class="comment"># use 0.6353843212127686</span></div><div class="line">    result = [proc.result() <span class="keyword">for</span> proc <span class="keyword">in</span> proc_pool]</div><div class="line">    print(time.time() - start)</div><div class="line">    <span class="keyword">return</span> proc_pool</div></pre></td></tr></table></figure>
<p>多进程的使用使用,使得处理时间大幅度降低,利用多核CPU的资源,使得多个进程并行,从而加快程序处理速度, 但是这样做的代价就是需要消耗更多的资源.<br>下面来看多线程:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 多线程</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">multithread_way</span><span class="params">()</span>:</span></div><div class="line">    start = time.time()</div><div class="line">    <span class="keyword">with</span> ThreadPoolExecutor(<span class="number">10</span>) <span class="keyword">as</span> executor:</div><div class="line">        thread_pool = &#123;executor.submit(blocking_way, url) <span class="keyword">for</span> url <span class="keyword">in</span> urls&#125;</div><div class="line">    <span class="comment"># use 0.5409300327301025</span></div><div class="line">    result = [proc.result() <span class="keyword">for</span> proc <span class="keyword">in</span> thread_pool]</div><div class="line">    print(time.time() - start)</div></pre></td></tr></table></figure></p>
<p>多线程执行时,其实每个线程还是阻塞的,<br>python中,由于有GIL的存在,多个线程之间实际上是不能在同一个时间并行的<br>多个线程中,其实每个线程还是阻塞的,只不过每个线程执行指定的指令数或者指定的时间就会释放GIL锁,让其他线程继续执行<br>实际运行的只有获取到GIL锁的那个线程,而当线程中遇到需要等待的操作时,切换到其他线程中继续执行代码,无形中就会减少代码的运行时间</p>
<hr>
<p>下面来看看非阻塞方式<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 非阻塞方式</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">nonbroking_way</span><span class="params">()</span>:</span></div><div class="line">    sock = socket.socket()</div><div class="line">    sock.setblocking(<span class="keyword">False</span>)</div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        sock.connect((<span class="string">"www.duanwenxue.com"</span>, <span class="number">80</span>))</div><div class="line">    <span class="keyword">except</span> BlockingIOError:</div><div class="line">        <span class="keyword">pass</span></div><div class="line">    request = <span class="string">'GET &#123;0&#125; HTTP/1.0\r\nHost: &#123;1&#125;\r\n\r\n'</span>.format(url, domain)</div><div class="line">    data = request.encode(<span class="string">'ascii'</span>)</div><div class="line">    While <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            sock.send(data)</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">except</span> OSError:</div><div class="line">            <span class="keyword">pass</span></div><div class="line"></div><div class="line">    response = <span class="string">b''</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            chunk = sock.recv(<span class="number">4096</span>)</div><div class="line">            <span class="keyword">while</span> chunk:</div><div class="line">                response += chunk</div><div class="line">                chunk = sock.recv(<span class="number">4096</span>)</div><div class="line">            <span class="keyword">break</span></div><div class="line">        <span class="keyword">except</span> OSError:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        <span class="keyword">return</span> response</div></pre></td></tr></table></figure></p>
<p>sock.setblocking(False) 把socket设置为非阻塞模式,那么socket 执行connect, recv等操作时是不会阻塞程序的<br>但是问题随之而来socket 执行完connect后再执行send操作,send的时候如何才能知道socket的连接已经成功建立了呢？<br>这时就需要不断循环去尝试,直至连接建立,并发送请求后,才继续执行下面的代码,而recv时也是同理.</p>
<p>这样看起来,程序更加复杂,而且效率也没有得到提升,因为socket虽然是非阻塞的,但是代码中在send,recv时还是需要等待上一步的操作完成时才能执行<br>那么如果有一个人可以在socket建立完成时来通知程序,可以执行send操作了,那样在等待socket建立的过程中,CPU就可以去干其他的事情了.<br>简单的例子:周末去吃饭,但是餐厅人很多,需要等位,这时候如果你一直在这里等,你就不能走开去干其他事情,直至吃完饭之后.<br>那么如果你把电话号码留给服务员,让他在轮到你的时候给你电话,让你过来吃饭,那么在等待电话到来之前,你可以去干你想干的事情.</p>
<ul>
<li>epoll:提供了专门的系统模块让应用程序可以接收事件通知(把电话号码留给服务员)</li>
<li>callback:在知道I/O状态发生改变后所需要执行的操作(服务员打电话通知可以过去吃饭)<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> DefaultSelector, EVENT_WRITE, EVENT_READ</div><div class="line"></div><div class="line">selector = DefaultSelector()</div><div class="line">stopped = <span class="keyword">False</span> </div><div class="line">urls_todo = [<span class="string">'/'</span>, <span class="string">'/1'</span>, <span class="string">'/2'</span>, <span class="string">'/3'</span>, <span class="string">'/4'</span>, <span class="string">'/5'</span>, <span class="string">'/6'</span>, <span class="string">'/7'</span>, <span class="string">'/8'</span>, <span class="string">'/9'</span>]</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Crawler</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, url)</span>:</span></div><div class="line">        self.url = url</div><div class="line">        self.sock = <span class="keyword">None</span></div><div class="line">        self.response = <span class="string">b''</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">fetch</span><span class="params">(self)</span>:</span></div><div class="line">        self.sock = socket.socket()</div><div class="line">        self.sock.setblocking(<span class="keyword">False</span>)</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            self.sock.connect((<span class="string">'www.baidu.com'</span>, <span class="number">80</span>))</div><div class="line">        <span class="keyword">except</span> BlockingIOError:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        selector.register(self.sock.fileno(), EVENT_WRITE, self.connected)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connected</span><span class="params">(self, key, mask)</span>:</span></div><div class="line">        selector.unregister(key.fd)</div><div class="line">        get = <span class="string">'GET &#123;0&#125; HTTP/1.0\r\nHost: www.baidu.com\r\n\r\n'</span>.format(self.url)</div><div class="line">        self.sock.send(get.encode(<span class="string">'ascii'</span>))</div><div class="line">        selector.register(key.fd, EVENT_READ, self.read_response)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">read_response</span><span class="params">(self, key, mask)</span>:</span></div><div class="line">        <span class="keyword">global</span> stopped</div><div class="line">        chunk = self.sock.recv(<span class="number">4096</span>)</div><div class="line">        <span class="keyword">if</span> chunk:</div><div class="line">            self.response += chunk</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            selector.unregister(key.fd)</div><div class="line">            urls_todo.remove(self.url)</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> urls_todo:</div><div class="line">                stopped = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stopped:</div><div class="line">        events = selector.select()</div><div class="line">        <span class="keyword">for</span> event_key, event_mask <span class="keyword">in</span> events:</div><div class="line">            callback = event_key.data</div><div class="line">            callback(event_key, event_mask)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    <span class="keyword">import</span> time</div><div class="line">    start = time.time()</div><div class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> urls_todo:</div><div class="line">        crawl = Crawler(<span class="string">'url'</span>)</div><div class="line">        crawl.fetch()</div><div class="line">    loop()</div><div class="line">    print(time.time() - start)</div></pre></td></tr></table></figure>
</li>
</ul>
<p>register(fileobj, events, data=None) </p>
<ul>
<li>fileobj:可以是文件描述符也可以是文件对象</li>
<li>events:位掩码，指明发生的是什么事件</li>
<li>data:与指定文件与指定事件绑定在一起的数据</li>
</ul>
<p>selector.register 在该socket的写事件上绑定了回调函数connected.在该socket上第一次发生的写事件意味着连接的建立后会调用connected函数</p>
<p>而connected函数在连接建立成功后再解除了该socket上所有绑定的数据。</p>
<p>在connect函数中同样也用selector.register 绑定了read_response函数,当socket发生可读事件(即服务器已经返回数据)时调用read_response函数.</p>
<p>这些事件触发后,我们就要执行回调了,我们可以用selector.select()来获取所触发的事件,当没有事件被触发时selector.select()会阻塞,直至事件触发.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> socket</div><div class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> DefaultSelector, EVENT_READ</div><div class="line"></div><div class="line">selector = DefaultSelector()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Chat</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, host, port, max_clients)</span>:</span></div><div class="line">        self.clients = []</div><div class="line">        self.host = host</div><div class="line">        self.port = port</div><div class="line">        self.stoped = <span class="keyword">False</span></div><div class="line">        self.max_clients = max_clients</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        self.sock = socket.socket()</div><div class="line">        self.sock.bind((self.host, self.port))</div><div class="line">        self.sock.listen(self.max_clients)</div><div class="line">        self.sock.setblocking(<span class="keyword">False</span>)</div><div class="line">        selector.register(self.sock, EVENT_READ, self.accept)</div><div class="line">        self.loop()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">accept</span><span class="params">(self, key, mask)</span>:</span></div><div class="line">        print(<span class="string">'accept'</span>)</div><div class="line">        conn, addr = self.sock.accept()</div><div class="line">        self.clients.append(addr)</div><div class="line">        conn.setblocking(<span class="keyword">False</span>)</div><div class="line">        selector.register(conn, EVENT_READ, self.handle)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self, key, mask)</span>:</span></div><div class="line">        selector.unregister(key.fd)</div><div class="line">        print(<span class="string">'send'</span>)</div><div class="line">        conn = key.fileobj</div><div class="line">        print(conn.getpeername())</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            data = conn.recv(<span class="number">4096</span>)</div><div class="line">        <span class="keyword">except</span> BlockingIOError:</div><div class="line">            <span class="keyword">pass</span></div><div class="line">        <span class="keyword">if</span> data:</div><div class="line">            <span class="keyword">for</span> client <span class="keyword">in</span> self.clients:</div><div class="line">                <span class="keyword">if</span> client != conn.getpeername():</div><div class="line">                    self.sock.sendto(data, client)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">loop</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">not</span> self.stoped:</div><div class="line">            events = selector.select()</div><div class="line">            <span class="keyword">for</span> event_key, event_mask <span class="keyword">in</span> events:</div><div class="line">                callback = event_key.data</div><div class="line">                callback(event_key, event_mask)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self)</span>:</span></div><div class="line">        self.stoped = <span class="keyword">True</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    chat = Chat(<span class="string">'localhost'</span>, <span class="number">8000</span>, <span class="number">10</span>)</div><div class="line">    chat.run()</div></pre></td></tr></table></figure>
<p>原理与刚才一样,当Chat.run()时在该socket的写事件上绑定了回调函数accept函数.在该socket上第一次发生的读事件意味着有新客户端连接后会调用accept函数<br>执行accept时又会把socket绑定到handle函数上,当socket发生可读事件(即有数据可获取时),调用handle函数,获取clinet发过来的数据,并转发到其他的client</p>

	
	</div>
  <a type="button" href="/2017/09/12/async/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		
           
			  
	
	<!-- display as entry -->	
		<h3 class="title">
			<div class="date"> 2017-09-12 </div>
			<div class="article-title"><a href="/2017/09/12/func/" >python之函数、闭包</a></div>
		</h3>
	


			  <div class="entry">
  <div class="row">
	
	
		<h3 id="函数的意义"><a href="#函数的意义" class="headerlink" title="函数的意义"></a>函数的意义</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#函数是对单一相关操作的有组织的可重用代码的块的封装</span></div><div class="line"><span class="comment">#为应用程序提供更好的模块化以及提高代码的复用程度</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">(x, y, z)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + y + z</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func2</span><span class="params">()</span>:</span></div><div class="line">    x, y, z = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></div><div class="line">    <span class="keyword">return</span> x + y + z </div><div class="line"></div><div class="line">func1(x=<span class="number">1</span>,y=<span class="number">2</span>,z=<span class="number">3</span>)</div><div class="line">func2()</div><div class="line"></div><div class="line"><span class="comment"># 函数并不意味着对一段重复使用的代码进行封装 如func2,在x, y, z,不变的情况下这样使用好像不会出问题</span></div><div class="line"><span class="comment"># 但是我们要的不仅仅是这个,在有可能的情况下,应该尽可能地提高函数的自定义程度,</span></div><div class="line">如同func1，传到函数里边的可以是<span class="number">3</span>个str,<span class="number">3</span>个int,<span class="number">3</span>个list等等,让使用者来自己定义函数的输入</div></pre></td></tr></table></figure>
<h3 id="定义和调用规则"><a href="#定义和调用规则" class="headerlink" title="定义和调用规则"></a>定义和调用规则</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">send_mail</span><span class="params">(sender, password, receiver,  message, subject=None, smtpserver=<span class="string">'qq.smtp.com'</span>)</span> -&gt; bool:</span></div><div class="line">    <span class="string">''' function send_mail</span></div><div class="line"><span class="string">    </span></div><div class="line"><span class="string">    :param sender: 发件人的邮箱地址</span></div><div class="line"><span class="string">    :type sender: str</span></div><div class="line"><span class="string">    </span></div><div class="line"><span class="string">    :param password: 发件人的邮箱密码</span></div><div class="line"><span class="string">    :type password: str</span></div><div class="line"><span class="string">    </span></div><div class="line"><span class="string">    :param receiver: 收件人的邮箱地址</span></div><div class="line"><span class="string">    :type receiver: list</span></div><div class="line"><span class="string">    </span></div><div class="line"><span class="string">    :param message: 邮件内容</span></div><div class="line"><span class="string">    :type message: str</span></div><div class="line"><span class="string">    </span></div><div class="line"><span class="string">    :param subject: 邮件标题</span></div><div class="line"><span class="string">    :type subject: str</span></div><div class="line"><span class="string">    </span></div><div class="line"><span class="string">    :param smtpserver: 邮件服务器, 默认为'qq.smtp.com'</span></div><div class="line"><span class="string">    :type smtpserver: str</span></div><div class="line"><span class="string">    </span></div><div class="line"><span class="string">    :return bool</span></div><div class="line"><span class="string">    '''</span></div><div class="line">    msg=MIMEText(message)</div><div class="line">    msg[<span class="string">'Subject'</span>]=subject</div><div class="line">    msg[<span class="string">'Form'</span>]=sender</div><div class="line">    msg[<span class="string">'To'</span>]=receiver</div><div class="line">    result = <span class="keyword">False</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">      smtp=SMTP()</div><div class="line">      smtp.connect(smtpserver)</div><div class="line">      smtp.login(sender,password)</div><div class="line">      smtp.sendmail(sender,receiver,msg.as_string())</div><div class="line">      smtp.close()</div><div class="line">      retult = <span class="keyword">True</span></div><div class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">      print(e)</div><div class="line">      result = <span class="keyword">False</span></div><div class="line">    <span class="keyword">return</span> result</div><div class="line"></div><div class="line">result = send_mail(<span class="string">'369574757@qq.com'</span>, <span class="string">'123456'</span>, [<span class="string">'369574757@qq.com'</span>], <span class="string">'Hello World'</span>)</div><div class="line">print(result)</div></pre></td></tr></table></figure>
<ul>
<li>定义函数  从def所在行开始 直至函数所在的最后1行</li>
<li>函数注释： 函数里边第一个注释块 help()会返回函数的注释</li>
<li>函数返回值： return 所返回的值(默认为None)</li>
<li>调用函数: send_mail() | result = send_mail()</li>
<li>接收返回值： result = send_mail()</li>
<li>内置函数与自定义函数：</li>
<li>send_mail()就是自定义函数</li>
<li>内置函数–&gt;不需要用户自己定义就能调用的(list,dict,tuple等)</li>
</ul>
<h3 id="函数的传参方式-按绑定关系传递"><a href="#函数的传参方式-按绑定关系传递" class="headerlink" title="函数的传参方式 按绑定关系传递"></a>函数的传参方式 按绑定关系传递</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">str1 = <span class="string">"dear"</span></div><div class="line">list1 = []</div><div class="line"></div><div class="line">print(sys.getrefcount(list1)) -&gt; 2</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(s:str, l:list)</span>:</span></div><div class="line"></div><div class="line">  print(sys.getrefcount(list1)) -&gt; 5</div><div class="line">  print(sys.getrefcount(l)) -&gt; 5</div><div class="line">  print(id(l),l)</div><div class="line"></div><div class="line">  l.append(s)</div><div class="line">  print(id(l),l)</div><div class="line">  </div><div class="line">  print(id(s),s)</div><div class="line">  s += <span class="string">"Eirs"</span></div><div class="line">  print(id(s),s)</div><div class="line"></div><div class="line"><span class="comment"># 由sys.getrefcount(list1)统计得知在参数传递的过程中  只是把list1的绑定关系传递给l 相当于l = list1 </span></div><div class="line"><span class="comment"># 由于l.append(s)只是对[]进行修改,并没有改变l与[]的绑定关系  所以两次print出来的id 是一样的</span></div><div class="line"><span class="comment"># s += "Eirs" 把变量s重新指向了新的元素'dearEirs', 变量从绑定'dear' 变为绑定'dearEirs'所以值的内存地址变了</span></div></pre></td></tr></table></figure>
<h3 id="传参的形式"><a href="#传参的形式" class="headerlink" title="传参的形式"></a>传参的形式</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(a, b, c=<span class="number">6</span>, *args)</span>:</span></div><div class="line">  <span class="keyword">return</span> id(a),id(b),id(c)</div><div class="line">  </div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(x, y, z)</span>:</span></div><div class="line">  <span class="keyword">return</span> x-y+z</div></pre></td></tr></table></figure>
<ul>
<li>必选参数: a, b   func(1, 2)</li>
<li>可选参数（默认参数): c  func(1, 2) func(1, 2, 3)</li>
<li>按位置传参: func(1,2,3)  在第一、二、三位的参数1,2,3分别对应着参数a, b, c</li>
<li>关键字参数: func(a=1, b=2, c=3)</li>
<li>可变长参数: func(1,2,3,4,’dear’),在a,b,c 都接收到参数后,其余参数传递给*args</li>
</ul>
<h3 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">lambda</span> x: x % <span class="number">2</span></div><div class="line"></div><div class="line">相当于</div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(x)</span>:</span></div><div class="line">  <span class="keyword">return</span> x % <span class="number">2</span></div><div class="line"></div><div class="line"><span class="comment">#使用情景: 函数体可以用1条表达式就可以解决时</span></div></pre></td></tr></table></figure>
<h3 id="作用域"><a href="#作用域" class="headerlink" title="作用域"></a>作用域</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"></div><div class="line">x = <span class="number">1</span></div><div class="line"></div><div class="line"><span class="keyword">if</span> <span class="keyword">True</span>:</div><div class="line">  y = <span class="number">2</span></div><div class="line"></div><div class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</div><div class="line">  z = x+i</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(x,y,z)</span>:</span></div><div class="line">  total = x + y + z</div><div class="line">  print(total)</div><div class="line">  <span class="keyword">return</span> total</div><div class="line"></div><div class="line"><span class="comment">#print(total)</span></div><div class="line">total = func()</div><div class="line">print(total)</div></pre></td></tr></table></figure>
<ul>
<li>全局作用域：在当前py文件里都生效</li>
<li>局部作用域：从函数或类的定义开始到该函数或类最后1行代码 为该函数或类的 局部作用域</li>
<li>全局变量：定格定义的变量（包含定格的if while for try里边定义的变量），在全局生效,可用globals()查看</li>
<li>局部变量：在函数或类里边所定义的变量，只在该函数或类中生效,可用locals()查看</li>
</ul>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">a = <span class="number">10000</span></div><div class="line">sys.getrefcount(a) -&gt; 2</div><div class="line"><span class="keyword">del</span> a</div><div class="line">sys.getrefcount(a) -&gt; 1</div><div class="line"><span class="comment">#变量a的生命周期结束,如果不del a   那么变量a将会一直存在 直至程序关闭</span></div><div class="line"></div><div class="line"><span class="comment">#函数的生命周期</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func</span><span class="params">(x,y,z)</span>:</span></div><div class="line">  total = x + y + z</div><div class="line">  print(total)</div><div class="line">  <span class="keyword">return</span> total</div><div class="line">  </div><div class="line"><span class="comment">#从函数第一行开始 到函数 return 返回值 若没return则到函数代码里的最后1行执行结束  即为函数的生命周期</span></div><div class="line"></div><div class="line"><span class="comment">#对象的生命周期</span></div><div class="line">当对象被垃圾回收机制回收时,对象才会结束它的生命周期</div></pre></td></tr></table></figure>
<h1 id="垃圾回收"><a href="#垃圾回收" class="headerlink" title="垃圾回收"></a>垃圾回收</h1><h3 id="引用计数"><a href="#引用计数" class="headerlink" title="引用计数"></a>引用计数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># sys.getrefcount() 统计变量所指向内存地址被引用的次数</span></div><div class="line">a = <span class="number">1000</span></div><div class="line">sys.getrefcount(a) -&gt; 2</div><div class="line"></div><div class="line">b = c  = a </div><div class="line">sys.getrefcount(a) -&gt; 4</div><div class="line">sys.getrefcount(b) -&gt; 4</div><div class="line">sys.getrefcount(c) -&gt; 4</div><div class="line"></div><div class="line"><span class="comment"># 每当有1个变量1000时  1000的引用计数就会加1  a, b, c, d,都指向着1000</span></div><div class="line"></div><div class="line"><span class="keyword">del</span> a </div><div class="line"></div><div class="line">sys.getrefcount(a) -&gt; 1</div><div class="line">sys.getrefcount(b) -&gt; 3</div><div class="line">sys.getrefcount(c) -&gt; 3</div><div class="line"></div><div class="line">当变量a被销毁时, <span class="number">1000</span>的引用次数就会减<span class="number">1</span></div></pre></td></tr></table></figure>
<h3 id="分代收集"><a href="#分代收集" class="headerlink" title="分代收集"></a>分代收集</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># gc.get_count() 查看当前回收计数</span></div><div class="line"><span class="comment"># gc.get_threshold() 查看回收阈值 -&gt; (700, 10, 10)</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> gc</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span>:</span></div><div class="line">  <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">()</span>:</span></div><div class="line">    i = <span class="number">0</span></div><div class="line">    <span class="keyword">while</span> i&lt;<span class="number">200</span>:</div><div class="line">      c1 = A()</div><div class="line">      c2 = A()</div><div class="line">      c1.t = c2</div><div class="line">      c2.t = c1</div><div class="line">      <span class="keyword">del</span> c1</div><div class="line">      <span class="keyword">del</span> c2</div><div class="line">      i += <span class="number">1</span></div><div class="line"></div><div class="line">gc.get_count()</div><div class="line">func1()</div><div class="line">gc.get_count()</div></pre></td></tr></table></figure>
<h1 id="闭包"><a href="#闭包" class="headerlink" title="闭包"></a>闭包</h1><ul>
<li>前提1：嵌套函数</li>
<li>前提2：内层函数引用非全局变量</li>
<li>前提3：不改变外部变量的绑定关系</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line"><span class="string">查看函数是不是闭包：</span></div><div class="line"><span class="string">2.7:func.func_closure  返回cell对象即为闭包  返回None即不是</span></div><div class="line"><span class="string">3.6:func.__closure__</span></div><div class="line"><span class="string">'''</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">outer</span><span class="params">()</span>:</span></div><div class="line">  dict1 = &#123;&#125;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">(key,value)</span>:</span></div><div class="line">    dict1[key] = value</div><div class="line">    <span class="keyword">return</span> dict1</div><div class="line">  <span class="keyword">return</span> inner</div><div class="line"></div><div class="line">f1 = outer()</div><div class="line">print(f.__closure__) -&gt; (&lt;cell at 0x000002BEE0BC57C8: dict object at 0x000002BEE0FD5F78&gt;,)</div><div class="line">f1(<span class="string">'key1'</span>,<span class="string">'value1'</span>)</div><div class="line">f1('key2','value2') -&gt; &#123;'key1': 'value1', 'key2': 'value2'&#125;</div><div class="line"></div><div class="line">f2 = outer()</div><div class="line">f2(<span class="string">'key3'</span>,<span class="string">'value3'</span>)</div><div class="line">f2('key4','value4') -&gt; &#123;'key3': 'value3', 'key4': 'value4'&#125;</div><div class="line"></div><div class="line"><span class="comment"># 当外部函数被调用时，返回一个闭包 即f,f2</span></div><div class="line"><span class="comment"># 闭包 = 子函数 + 依赖的外部变量  子函数 inner 外部变量 dict1</span></div><div class="line"><span class="comment"># 闭包是一种特殊的函数</span></div><div class="line"><span class="comment"># 每调一次外部函数，返回一个新闭包 f f2 的互不干扰,是2个不一样的闭包 各自指向着不同的内存地址</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 匿名函数可不可以是闭包</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">outer</span><span class="params">()</span>:</span></div><div class="line">  dict1 = &#123;&#125;</div><div class="line">  l = <span class="keyword">lambda</span> key, value: dict1.update(&#123;key:value&#125;)</div><div class="line">  <span class="keyword">return</span> l</div><div class="line"></div><div class="line">f = outer()</div><div class="line">print(f.__closure__) -&gt; (&lt;cell at 0x00000230A4645798: dict object at 0x00000230A46E2168&gt;,)</div><div class="line"></div><div class="line"><span class="comment"># 匿名函数也可以是闭包</span></div></pre></td></tr></table></figure>

	
	</div>
  <a type="button" href="/2017/09/12/func/#more" class="btn btn-default more">阅读此文</a>
</div>

           
		

		</div>

		<!-- pagination -->
		<div>
  		<center>
		<div class="pagination">
<ul class="pagination">
	 
		
    	<li class="prev"><a href="/" class="alignleft prev"><i class="fa fa-arrow-circle-o-left"></i> 上一页</a></li>
  		

        <li><a href="/"><i class="fa fa-home"></i>Home</a></li>

		
		   <li class="next"> <a href="/page/3/" class="alignright next">下一页<i class="fa fa-arrow-circle-o-right"></i></a> </li>          
        
	
</ul>
</div>

  		</center>
		</div>

		
		
	</div> <!-- col-md-9 -->

	
		<div class="col-md-3">
	<div id="sidebar">
	
			
  <div id="site_search">
   <div class="form-group">
    <input type="text" id="local-search-input" name="q" results="0" placeholder="搜索" class="st-search-input st-default-search-input form-control"/>
   </div>  
  <div id="local-search-result"></div>
  </div>


		
			
	<div class="widget">
		<h4>分类</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/categories/database/">database</label></a></li>
		
			<li><a href="/categories/django/">django</label></a></li>
		
			<li><a href="/categories/linux/">linux</label></a></li>
		
			<li><a href="/categories/python/">python</label></a></li>
		
			<li><a href="/categories/saltstack/">saltstack</label></a></li>
		
			<li><a href="/categories/web/">web</label></a></li>
		
			<li><a href="/categories/协议/">协议</label></a></li>
		
			<li><a href="/categories/大数据/">大数据</label></a></li>
		
		</ul>
	</div>


		
			
	<div class="widget">
		<h4>标签云</h4>
		<ul class="tag_box inline list-unstyled">
		
			<li><a href="/tags/uwsgi/">uwsgi</a></li>
		
			<li><a href="/tags/敏捷开发/">敏捷开发</a></li>
		
			<li><a href="/tags/函数/">函数</a></li>
		
			<li><a href="/tags/rocketmq/">rocketmq</a></li>
		
			<li><a href="/tags/闭包/">闭包</a></li>
		
			<li><a href="/tags/decorator/">decorator</a></li>
		
			<li><a href="/tags/ELK/">ELK</a></li>
		
			<li><a href="/tags/python/">python</a></li>
		
			<li><a href="/tags/gc/">gc</a></li>
		
			<li><a href="/tags/jinja/">jinja</a></li>
		
			<li><a href="/tags/大数据/">大数据</a></li>
		
			<li><a href="/tags/flask/">flask</a></li>
		
			<li><a href="/tags/cache/">cache</a></li>
		
			<li><a href="/tags/代码优化/">代码优化</a></li>
		
			<li><a href="/tags/vim/">vim</a></li>
		
			<li><a href="/tags/http/">http</a></li>
		
			<li><a href="/tags/mysql/">mysql</a></li>
		
			<li><a href="/tags/cgi/">cgi</a></li>
		
			<li><a href="/tags/redis/">redis</a></li>
		
			<li><a href="/tags/django/">django</a></li>
		
		
		   <li><a href="/tags">...<span>23</span></a></li>
		 
		</ul>
	</div>


		
			
<div class="widget">
  <h4>最新文章</h4>
  <ul class="entry list-unstyled">
    
      <li>
        <a href="/2018/06/21/cgi/" ><i class="fa fa-file-o"></i>cgi的应用</a>
      </li>
    
      <li>
        <a href="/2018/06/21/cache/" ><i class="fa fa-file-o"></i>缓存常见问题</a>
      </li>
    
      <li>
        <a href="/2018/06/21/http/" ><i class="fa fa-file-o"></i>http协议理解</a>
      </li>
    
      <li>
        <a href="/2018/05/10/flask/" ><i class="fa fa-file-o"></i>flask源码--处理过程</a>
      </li>
    
      <li>
        <a href="/2018/04/25/redis-use/" ><i class="fa fa-file-o"></i>redis常用命令</a>
      </li>
    
  </ul>
</div>

		
			
<div class="widget">
	<h4>链接</h4>
	<ul class="blogroll list-unstyled">
	
		<li><i class="fa fa-github"></i><a href="http://www.github.com/DearEirs" title="My Github account." target="_blank"]);">My Github</a></li>
	
	</ul>
</div>


		
	</div> <!-- sidebar -->
</div> <!-- col-md-3 -->

	
	
</div> <!-- row-fluid -->


	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  &copy; 2018 Dear
  
      with help from <a href="http://hexo.io/" target="_blank">Hexo</a> and <a href="http://getbootstrap.com/" target="_blank">Twitter Bootstrap</a>. Theme by <a href="http://github.com/wzpan/hexo-theme-freemind/">Freemind</a>.    
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>▲</span> 
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="https://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 




   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>


<!-- syntax highlighting -->


</body>
   </html>
